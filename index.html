<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shillette</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
    <style type="text/tailwindcss">
        /* --- Animations --- */
        @keyframes animateGradient { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }
        @keyframes spinBorder { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }
        @keyframes fall { 0% { transform: translateY(-10vh) translateX(0); opacity: 1; } 100% { transform: translateY(110vh) translateX(5vw); opacity: 0; } }
        @keyframes scaleUpDown { 0%, 100% { transform: scaleY(0.4); } 20% { transform: scaleY(1.0); } }

        /* --- Base Styles --- */
        body {
            font-family: 'Inter', sans-serif;
            /* Default gradient, can be overridden by dynamic config */
            @apply bg-gradient-to-br from-orange-700 via-black to-black text-gray-300;
            background-size: 200% 200%;
            animation: animateGradient 25s ease infinite;
            overflow-x: hidden; position: relative; z-index: 0;
        }
        body::before { content: ''; position: fixed; inset: 0; background-image: url('images/background.png'); background-size: cover; background-position: center center; background-repeat: no-repeat; background-attachment: fixed; opacity: 0.2; z-index: -1; }

        /* --- Snow Effect --- */
        #snow-container { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 40; overflow: hidden; }
        .snowflake { position: absolute; background-color: white; border-radius: 50%; pointer-events: none; animation-name: fall; animation-timing-function: linear; animation-iteration-count: infinite; }

        /* --- Card Styles --- */
        .card-gradient-border::before { content: ''; position: absolute; inset: 0; border-radius: 0.5rem; padding: 2px; background-size: 300% 300%; animation: spinBorder 5s linear infinite; -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0); -webkit-mask-composite: xor; mask-composite: exclude; pointer-events: none; z-index: -1; }
        .card-gradient-border.orange-border::before { background-image: linear-gradient(145deg, #f97316, #9a3412, #000000); }
        .card-gradient-border.gray-border::before { background-image: linear-gradient(145deg, #9ca3af, #374151, #000000); animation-duration: 6s; }

        .product-card { @apply relative bg-slate-800/80 backdrop-blur-sm rounded-lg p-6 shadow-xl flex flex-col z-0; overflow: hidden; transition: transform 0.3s ease-in-out, box-shadow 0.3s ease-in-out; }
        .product-card:hover { transform: scale(1.03); }
        .product-card.card-gradient-border.orange-border:hover { box-shadow: 0 0 8px 1px rgba(249, 115, 22, 0.6), 0 0 16px 4px rgba(249, 115, 22, 0.4), 0 0 32px 8px rgba(249, 115, 22, 0.2); }
        .product-card.card-gradient-border.gray-border:hover { box-shadow: 0 0 8px 1px rgba(156, 163, 175, 0.5), 0 0 16px 4px rgba(156, 163, 175, 0.3), 0 0 32px 8px rgba(156, 163, 175, 0.15); }

        /* --- Page Section & General Content Styles --- */
        #dashboard-content h2, #products-page-content h2, #tickets-page-content h2, #ticket-detail-content h2 { @apply text-3xl md:text-4xl font-bold text-white text-center mb-12; }
        #dashboard-content .dashboard-card, #tickets-page-content .ticket-card, #ticket-detail-content .ticket-card, .admin-section { @apply bg-slate-800/80 backdrop-blur-sm p-6 rounded-lg shadow-lg mb-6; } /* Added admin-section */

        .paypal-button, .purchase-button { /* Combined styles */
            @apply bg-sky-600 hover:bg-sky-700 text-white text-sm font-medium py-2 px-4 rounded-md transition duration-300 flex items-center justify-center space-x-2 w-full disabled:opacity-50 disabled:cursor-not-allowed;
        }

        /* --- Message Popups --- */
        #payment-message, #ticket-message, #error-message, #config-message, #product-message { /* Added config/product messages */
            position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
            @apply text-white text-sm font-medium py-2 px-5 rounded-lg shadow-lg opacity-0 transition-opacity duration-500 ease-in-out z-50 pointer-events-none;
        }
        #payment-message.show, #ticket-message.show, #error-message.show, #config-message.show, #product-message.show { opacity: 1; }
        #payment-message, #ticket-message, #config-message, #product-message { @apply bg-green-600; } /* General success */
        #error-message { @apply bg-red-600; } /* General error */

        /* --- Loading Overlay --- */
        #loading-overlay { position: fixed; inset: 0; @apply bg-black/60 backdrop-blur-sm flex items-center justify-center z-50 transition-opacity duration-300 ease-in-out opacity-0 pointer-events-none; }
        #loading-overlay.active { @apply opacity-100 pointer-events-auto; }
        .loader { display: flex; align-items: center; justify-content: space-between; width: 50px; height: 25px; }
        .loader-bar { display: block; width: 8px; height: 100%; background-color: #f97316; border-radius: 4px; animation: scaleUpDown 1.2s infinite ease-in-out; }
        .loader-bar:nth-child(2) { animation-delay: 0.2s; } .loader-bar:nth-child(3) { animation-delay: 0.4s; }

        /* --- Page Section Visibility --- */
        .page-section { display: none; /* Hide by default */ }
        .page-section.active { display: block; /* Show active section */ }

        /* --- Ticket Specific Styles --- */
        .ticket-list-item { @apply bg-slate-700/50 p-4 rounded-md mb-3 flex justify-between items-center cursor-pointer hover:bg-slate-600/50 transition-colors; }
        .status-open { @apply bg-green-500 text-green-900 text-xs font-bold px-2 py-0.5 rounded-full; }
        .status-closed { @apply bg-red-500 text-red-900 text-xs font-bold px-2 py-0.5 rounded-full; }
        #create-ticket-status { @apply text-sm mt-4 mb-4 text-center h-6; } /* Added height */
        #create-ticket-status.success { @apply text-green-400; } #create-ticket-status.error { @apply text-red-400; }
        #moderator-management-view h3 { @apply text-xl font-semibold text-white mb-4; }
        #moderator-management-view details summary { @apply cursor-pointer text-lg font-semibold text-white mb-3 hover:text-orange-400 transition-colors; }
        #moderator-management-view details[open] summary { @apply text-orange-400; }
        .ticket-list-container { @apply space-y-3 max-h-96 overflow-y-auto pr-2; }

        /* --- Chat Styles --- */
        #chat-messages { @apply h-64 md:h-80 overflow-y-auto mb-4 p-3 bg-slate-900/50 rounded-md border border-slate-700 space-y-2; }
        .chat-message { @apply text-sm break-words p-1 rounded hover:bg-slate-800/50 transition-colors; }
        .chat-message .username { @apply font-semibold text-orange-400 mr-2 cursor-pointer hover:underline; }
        .chat-message .timestamp { @apply text-xs text-gray-500 ml-2 whitespace-nowrap; }
        #chat-input-form { @apply flex space-x-2; }
        #chat-input { @apply flex-grow bg-slate-700 border border-slate-600 rounded-md py-2 px-3 text-white focus:outline-none focus:ring-2 focus:ring-orange-500 focus:border-transparent placeholder-gray-500; }
        #send-chat-button { @apply bg-orange-600 hover:bg-orange-700 text-white font-medium py-2 px-4 rounded-lg transition duration-300; }

        /* --- Modals (User Info, Product Edit) --- */
        .modal { @apply fixed inset-0 bg-black/70 backdrop-blur-sm flex items-center justify-center z-50 opacity-0 pointer-events-none transition-opacity duration-300; }
        .modal.active { @apply opacity-100 pointer-events-auto; }
        .modal-content { @apply bg-slate-800 p-6 rounded-lg shadow-xl max-w-md w-full text-white relative; } /* Added relative */
        .modal-close-button { @apply absolute top-3 right-3 text-gray-400 hover:text-white transition-colors; }
        #modal-user-roles { @apply flex flex-wrap gap-1 mt-3; }

        /* --- Custom Context Menu --- */
        #chat-context-menu, #ticket-context-menu { @apply absolute bg-slate-700 border border-slate-600 rounded-md shadow-lg py-1 text-sm text-white z-50 hidden; }
        .context-menu-item { @apply px-3 py-1.5 hover:bg-orange-600 cursor-pointer block w-full text-left; }
        .context-menu-item.hidden { display: none; }
        .context-menu-item.delete { @apply hover:bg-red-600 text-red-400 hover:text-white; }

        /* --- Mobile Menu --- */
        #mobile-menu { @apply absolute top-full left-0 right-0 bg-gray-800/95 backdrop-blur-sm p-4 space-y-2 border-t border-gray-700/50 md:hidden z-30 hidden; } /* Start hidden */
        .mobile-menu-link { @apply block text-gray-300 hover:text-white transition duration-200 py-1; }

        /* --- Admin Dashboard Styles --- */
        .admin-section h3 { @apply text-xl font-semibold text-white mb-4 border-b border-slate-700 pb-2; }
        .admin-form label { @apply block text-sm font-medium text-gray-300 mb-1; }
        .admin-form input[type="text"], .admin-form input[type="number"], .admin-form textarea, .admin-form select {
             @apply w-full bg-slate-700 border border-slate-600 rounded-md py-2 px-3 text-white focus:outline-none focus:ring-2 focus:ring-orange-500 focus:border-transparent placeholder-gray-500 mb-4;
        }
        .admin-form button[type="submit"] { @apply w-full bg-orange-600 hover:bg-orange-700 text-white font-medium py-2.5 px-6 rounded-lg transition duration-300 disabled:opacity-50; }
        .admin-form .link-group { @apply flex items-center space-x-2 mb-2; }
        .admin-form .link-group input { @apply mb-0; } /* Remove bottom margin for inputs in group */
        .admin-form .link-group button { @apply bg-red-600 hover:bg-red-700 text-white text-xs font-bold py-1 px-2 rounded; }

        #product-list-table { @apply w-full text-sm text-left text-gray-400 mt-4; }
        #product-list-table thead { @apply text-xs text-gray-300 uppercase bg-slate-700/50; }
        #product-list-table th, #product-list-table td { @apply px-4 py-3; }
        #product-list-table tbody tr { @apply border-b border-slate-700 hover:bg-slate-700/50; }
        #product-list-table .actions button { @apply text-xs font-medium px-2 py-1 rounded mr-1 transition duration-200; }
        #product-list-table .actions .edit-btn { @apply bg-blue-600 hover:bg-blue-700 text-white; }
        #product-list-table .actions .delete-btn { @apply bg-red-600 hover:bg-red-700 text-white; }
        #product-list-status { @apply text-sm text-gray-500 mt-4 text-center; }

    </style>
</head>
<body class="min-h-screen flex flex-col">

    <div id="snow-container"></div>

    <div id="payment-message">Placeholder</div>
    <div id="ticket-message">Placeholder</div>
    <div id="error-message">Placeholder</div>
    <div id="config-message">Placeholder</div> <div id="product-message">Placeholder</div> <div id="loading-overlay">
        <div class="loader"><span class="loader-bar"></span><span class="loader-bar"></span><span class="loader-bar"></span></div>
    </div>

    <div id="user-info-modal" class="modal">
        <div class="modal-content">
            <button id="modal-close-button" class="modal-close-button">
                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path></svg>
            </button>
            <h3 class="text-lg font-semibold mb-3" id="modal-username">Username</h3>
            <p class="text-sm text-gray-400 mb-1">User ID: <span id="modal-user-id">N/A</span></p>
            <p class="text-sm font-medium mb-2">Roles:</p>
            <div id="modal-user-roles"><p class="text-gray-500 text-xs">Roles not available.</p></div>
        </div>
    </div>

    <div id="product-edit-modal" class="modal">
        <div class="modal-content max-w-lg"> <button id="product-modal-close-button" class="modal-close-button">
                 <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path></svg>
            </button>
            <h3 class="text-lg font-semibold mb-4" id="product-modal-title">Add Product</h3>
            <form id="product-edit-form" class="admin-form space-y-4">
                <input type="hidden" id="product-edit-id"> <div>
                    <label for="product-edit-name">Product Name</label>
                    <input type="text" id="product-edit-name" required>
                </div>
                <div>
                    <label for="product-edit-price">Price ($)</label>
                    <input type="number" id="product-edit-price" step="0.01" required>
                </div>
                 <div>
                    <label for="product-edit-tag">Tag (e.g., ALL IN ONE, SOFTWARE)</label>
                    <input type="text" id="product-edit-tag">
                </div>
                 <div>
                    <label for="product-edit-tagColor">Tag Color (e.g., orange, gray)</label>
                    <select id="product-edit-tagColor">
                        <option value="orange">Orange</option>
                        <option value="gray">Gray</option>
                        <option value="blue">Blue</option>
                        <option value="green">Green</option>
                        <option value="red">Red</option>
                        <option value="purple">Purple</option>
                    </select>
                </div>
                <div>
                    <label for="product-edit-description">Description (Optional)</label>
                    <textarea id="product-edit-description" rows="3"></textarea>
                </div>
                 <div>
                    <label for="product-edit-features">Features (One per line)</label>
                    <textarea id="product-edit-features" rows="5"></textarea>
                </div>
                 <div>
                    <label for="product-edit-paymentLink">Payment Link/ID (e.g., PayPal button ID)</label>
                    <input type="text" id="product-edit-paymentLink">
                </div>
                <button type="submit" id="product-save-button">Save Product</button>
                <div id="product-edit-status" class="text-sm text-center h-5 mt-2"></div>
            </form>
        </div>
    </div>

    <div id="chat-context-menu">
        <button class="context-menu-item" id="context-delete-message">Delete Message</button>
        <button class="context-menu-item" id="context-user-info">User Info</button>
    </div>
    <div id="ticket-context-menu">
        <button class="context-menu-item" id="context-close-ticket">Close Ticket</button>
        <button class="context-menu-item" id="context-reopen-ticket">Reopen Ticket</button>
        <button class="context-menu-item delete" id="context-delete-ticket">Delete Ticket</button>
    </div>


    <header class="py-4 sticky top-0 z-40 bg-gray-900/80 backdrop-blur-md border-b border-gray-700/50">
        <div class="container mx-auto px-6 flex justify-between items-center">
            <div class="flex items-center space-x-2">
                <img src="images/icon.png" alt="Shillette Icon" class="w-8 h-8" onerror="this.style.display='none'; this.nextElementSibling.classList.remove('hidden');">
                <span class="text-2xl font-bold text-white hidden">Shillette</span>
                <span id="site-title-display" class="text-2xl font-bold text-white">Shillette</span>
            </div>
            <div class="flex items-center space-x-6">
                <nav id="main-navigation" class="hidden md:flex space-x-6">
                    </nav>
                <div id="user-area" class="flex items-center">
                    <a id="login-button" href="https://api.shillette.com/login" class="bg-orange-600 hover:bg-orange-700 text-white text-sm font-medium py-2 px-4 rounded-lg transition duration-300 flex items-center space-x-2">
                        <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M19.54 6.04a13.27 13.27 0 00-2.66-1.89 12.4 12.4 0 00-1.6-1.3c-.4-.3-.82-.53-1.28-.71-.18-.07-.37-.13-.56-.19a.82.82 0 00-.5-.06 11.85 11.85 0 00-5.88 0 .82.82 0 00-.5.06c-.19.06-.38.12-.56.19-.46.18-.88.4-1.28.7a12.34 12.34 0 00-1.6 1.3A13.23 13.23 0 004.46 6.04 14.31 14.31 0 003 11.7c0 .1 0 .19.02.28a13.8 13.8 0 001.44 4.61c.56 1.1 1.24 2.1 2.04 3 .5.56 1.04 1.07 1.63 1.53.17.13.34.25.52.37a.8.8 0 00.57.19.78.78 0 00.57-.19 11.07 11.07 0 005.56 0 .78.78 0 00.57.19.8.8 0 00.57-.19c.18-.12.35-.24.52-.37a12.06 12.06 0 003.67-4.53 13.85 13.85 0 001.44-4.61c0-.1 0-.19.02-.28a14.31 14.31 0 00-1.46-5.66zm-4.61 7.03a1.93 1.93 0 01-3.86 0 1.93 1.93 0 013.86 0zm-5.72 0a1.93 1.93 0 01-3.86 0 1.93 1.93 0 013.86 0z"></path></svg>
                        <span>Login with Discord</span>
                    </a>
                    <a href="/#dashboard" id="user-info" class="hidden items-center space-x-3 hover:bg-slate-700/50 p-1.5 rounded-lg transition duration-200 cursor-pointer">
                        <img id="user-avatar" src="https://placehold.co/32x32/7f8c8d/ecf0f1?text=?" alt="User Avatar" class="w-8 h-8 rounded-full border-2 border-slate-600" onerror="this.src='https://placehold.co/32x32/7f8c8d/ecf0f1?text=?'">
                        <span id="user-name" class="text-white text-sm font-medium">Username</span>
                        <button id="logout-button" class="text-gray-400 hover:text-white text-xs font-medium bg-slate-600 hover:bg-slate-500 px-2 py-1 rounded-md transition duration-200">Logout</button>
                    </a>
                </div>
            </div>
            <div class="md:hidden">
                <button id="mobile-menu-button" class="text-gray-300 hover:text-white focus:outline-none">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7"></path></svg>
                </button>
            </div>
        </div>
        <div id="mobile-menu" class="hidden">
            </div>
    </header>

    <main id="main-content" class="flex-grow page-section">
        <section class="relative text-center py-24 md:py-32 lg:py-40 overflow-hidden">
            <div class="container mx-auto px-6 relative z-10">
                <h1 class="text-4xl md:text-5xl lg:text-6xl font-extrabold text-white mb-4">Shillette</h1>
                <p class="text-xl md:text-2xl text-orange-400 mb-6 font-medium">Advanced DMA Firmware</p>
                <p class="max-w-2xl mx-auto text-gray-400 mb-10">
                    Fully undetected DMA firmware, battle-tested for reliable performance. Join thousands of satisfied users.
                </p>
                <div class="flex flex-col sm:flex-row justify-center items-center space-y-4 sm:space-y-0 sm:space-x-4 mb-16">
                    <a href="/#products" id="purchase-button" class="bg-orange-600 hover:bg-orange-700 text-white font-semibold py-3 px-8 rounded-lg transition duration-300 shadow-lg w-full sm:w-auto">
                        Purchase Product
                    </a>
                    <a href="https://discord.gg/shillette" target="_blank" rel="noopener noreferrer" class="bg-gray-700 hover:bg-gray-600 text-white font-semibold py-3 px-8 rounded-lg transition duration-300 shadow-lg w-full sm:w-auto flex items-center justify-center space-x-2">
                        <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M19.54 6.04a13.27 13.27 0 00-2.66-1.89 12.4 12.4 0 00-1.6-1.3c-.4-.3-.82-.53-1.28-.71-.18-.07-.37-.13-.56-.19a.82.82 0 00-.5-.06 11.85 11.85 0 00-5.88 0 .82.82 0 00-.5.06c-.19.06-.38.12-.56.19-.46.18-.88.4-1.28.7a12.34 12.34 0 00-1.6 1.3A13.23 13.23 0 004.46 6.04 14.31 14.31 0 003 11.7c0 .1 0 .19.02.28a13.8 13.8 0 001.44 4.61c.56 1.1 1.24 2.1 2.04 3 .5.56 1.04 1.07 1.63 1.53.17.13.34.25.52.37a.8.8 0 00.57.19.78.78 0 00.57-.19 11.07 11.07 0 005.56 0 .78.78 0 00.57.19.8.8 0 00.57-.19c.18-.12.35-.24.52-.37a12.06 12.06 0 003.67-4.53 13.85 13.85 0 001.44 4.61c0-.1 0-.19.02-.28a14.31 14.31 0 00-1.46-5.66zm-4.61 7.03a1.93 1.93 0 01-3.86 0 1.93 1.93 0 013.86 0zm-5.72 0a1.93 1.93 0 01-3.86 0 1.93 1.93 0 013.86 0z"></path></svg>
                        <span>Join Discord</span>
                    </a>
                </div>
                <div class="grid grid-cols-2 sm:grid-cols-4 gap-8 max-w-3xl mx-auto text-gray-400">
                    <div class="text-center"><div class="text-3xl font-bold text-white mb-1">1000+</div><div>Happy Users</div></div>
                    <div class="text-center"><div class="text-3xl font-bold text-white mb-1">1000+</div><div>Products Sold</div></div>
                    <div class="text-center"><div class="text-3xl font-bold text-white mb-1">5.0</div><div>Star Rating</div></div>
                    <div class="text-center"><div class="text-3xl font-bold text-white mb-1">3+</div><div>Years Experience</div></div>
                </div>
            </div>
        </section>
    </main>

    <div id="products-page-content" class="flex-grow container mx-auto px-6 py-10 page-section">
        <div class="flex justify-start mb-8">
             <a href="/#home" id="back-to-home-button-products" class="text-orange-400 hover:text-orange-300 flex items-center space-x-2 transition duration-200">
                 <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path></svg>
                 <span>Back to Home</span>
             </a>
        </div>
        <h2>Our Products</h2>
        <div id="product-grid" class="grid grid-cols-1 md:grid-cols-2 gap-8 max-w-5xl mx-auto">
            <p id="product-loading-status" class="text-center text-gray-400 md:col-span-2">Loading products...</p>
        </div>
    </div>

    <div id="dashboard-content" class="flex-grow container mx-auto px-6 py-10 page-section">
        <h2>Dashboard</h2>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
            <div class="dashboard-card md:col-span-1">
                <h3 class="text-lg font-semibold text-white mb-4">Welcome!</h3>
                <div class="flex items-center space-x-4 mb-4">
                     <img id="dashboard-user-avatar" src="https://placehold.co/64x64/7f8c8d/ecf0f1?text=?" alt="User Avatar" class="w-16 h-16 rounded-full border-2 border-orange-500" onerror="this.src='https://placehold.co/64x64/7f8c8d/ecf0f1?text=?'">
                     <div>
                         <p id="dashboard-user-name" class="text-xl font-semibold text-white">Username</p>
                         <p class="text-sm text-gray-400">Status: Active</p>
                     </div>
                </div>
                <button id="dashboard-logout-button" class="w-full bg-red-600 hover:bg-red-700 text-white text-sm font-medium py-2 px-4 rounded-lg transition duration-300">
                    Logout
                </button>
            </div>

            <div class="dashboard-card md:col-span-2">
                <h3 class="text-lg font-semibold text-white mb-4">My Products</h3>
                <p class="text-gray-400">Purchased product information will appear here (Feature not implemented).</p>
                </div>

            <div class="dashboard-card md:col-span-1">
                <h3 class="text-lg font-semibold text-white mb-4">My Roles</h3>
                <div id="dashboard-user-roles" class="space-y-2 flex flex-wrap gap-1">
                    <p class="text-gray-400 text-sm w-full">Loading roles...</p>
                </div>
            </div>

            <div class="dashboard-card md:col-span-2">
                 <h3 class="text-lg font-semibold text-white mb-4">Settings</h3>
                 <p class="text-gray-400">User settings will appear here (Feature not implemented).</p>
            </div>

            <div id="admin-dashboard-sections" class="hidden md:col-span-3 grid grid-cols-1 lg:grid-cols-2 gap-6">

                <div class="admin-section lg:col-span-1">
                    <h3>Site Configuration</h3>
                    <form id="site-config-form" class="admin-form">
                        <div>
                            <label for="config-site-title">Site Title</label>
                            <input type="text" id="config-site-title" required>
                        </div>
                        <div>
                            <label>Header Links</label>
                            <div id="config-header-links-container" class="space-y-2 mb-2">
                                </div>
                            <button type="button" id="add-header-link-button" class="text-sm bg-blue-600 hover:bg-blue-700 text-white py-1 px-3 rounded">Add Link</button>
                        </div>
                        <button type="submit" id="save-config-button">Save Configuration</button>
                        <div id="config-save-status" class="text-sm text-center h-5 mt-2"></div>
                    </form>
                </div>

                <div class="admin-section lg:col-span-1">
                    <h3>Product Management</h3>
                    <button id="add-product-button" class="mb-4 bg-green-600 hover:bg-green-700 text-white font-medium py-2 px-4 rounded-lg transition duration-300">Add New Product</button>
                    <div class="overflow-x-auto">
                        <table id="product-list-table">
                            <thead>
                                <tr><th>Name</th><th>Price</th><th>Tag</th><th>Actions</th></tr>
                            </thead>
                            <tbody id="product-list-tbody">
                                </tbody>
                        </table>
                    </div>
                    <p id="product-list-status">Loading products...</p>
                </div>

            </div>
            </div> </div> <div id="tickets-page-content" class="flex-grow container mx-auto px-6 py-10 page-section">
         <div class="flex justify-start mb-8">
             <a href="/#home" id="back-to-home-button-tickets" class="text-orange-400 hover:text-orange-300 flex items-center space-x-2 transition duration-200">
                 <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path></svg>
                 <span>Back to Home</span>
             </a>
         </div>
         <h2>Support Tickets</h2>

         <div id="moderator-management-view" class="hidden mb-8 ticket-card">
             <h3 class="text-xl font-semibold text-white mb-4 border-b border-slate-700 pb-2">Ticket Management</h3>
             <details class="mb-6" open> <summary>Active Tickets</summary>
                 <div id="moderator-active-ticket-list" class="ticket-list-container mt-3"></div>
                 <p id="moderator-active-list-status" class="text-sm text-gray-500 mt-4">Loading active tickets...</p>
             </details>
             <details> <summary>Archived Tickets</summary>
                 <div id="moderator-archived-ticket-list" class="ticket-list-container mt-3"></div>
                 <p id="moderator-archived-list-status" class="text-sm text-gray-500 mt-4">Loading archived tickets...</p>
             </details>
         </div>

         <div id="user-ticket-view" class="mb-8 ticket-card">
             <h3 class="text-xl font-semibold text-white mb-4">My Tickets</h3>
             <div id="ticket-list" class="ticket-list-container"></div>
             <p id="ticket-list-status" class="text-sm text-gray-500 mt-4">Loading tickets...</p>
         </div>

         <div class="ticket-card">
             <h3 class="text-xl font-semibold text-white mb-4">Create New Ticket</h3>
             <form id="create-ticket-form" novalidate>
                 <div class="mb-4">
                     <label for="ticket-subject" class="block text-sm font-medium text-gray-300 mb-1">Subject</label>
                     <input type="text" id="ticket-subject" name="ticket-subject" required class="w-full bg-slate-700 border border-slate-600 rounded-md py-2 px-3 text-white focus:outline-none focus:ring-2 focus:ring-orange-500 focus:border-transparent placeholder-gray-500">
                 </div>
                 <div class="mb-4">
                     <label for="ticket-message-input" class="block text-sm font-medium text-gray-300 mb-1">Message</label>
                     <textarea id="ticket-message-input" name="ticket-message-input" rows="6" required class="w-full bg-slate-700 border border-slate-600 rounded-md py-2 px-3 text-white focus:outline-none focus:ring-2 focus:ring-orange-500 focus:border-transparent placeholder-gray-500"></textarea>
                 </div>
                 <div id="create-ticket-status" class="h-6"></div>
                 <button type="submit" id="create-ticket-button" class="w-full bg-orange-600 hover:bg-orange-700 text-white font-medium py-2.5 px-6 rounded-lg transition duration-300">Submit Ticket</button>
             </form>
         </div>
     </div>

     <div id="ticket-detail-content" class="flex-grow container mx-auto px-6 py-10 page-section">
         <div class="flex justify-start mb-8">
             <a href="/#tickets" id="back-to-tickets-button" class="text-orange-400 hover:text-orange-300 flex items-center space-x-2 transition duration-200">
                 <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path></svg>
                 <span>Back to Tickets</span>
             </a>
         </div>
         <h2 id="ticket-detail-subject">Ticket Subject</h2>
         <div class="ticket-card">
             <div id="chat-messages"><p class="text-gray-500 text-center py-4">Loading chat...</p></div>
             <form id="chat-input-form" class="mt-4" novalidate>
                 <input type="text" id="chat-input" placeholder="Type your message..." required class="w-full">
                 <button type="submit" id="send-chat-button">Send</button>
             </form>
         </div>
     </div>


    <footer class="bg-black mt-auto py-6 border-t border-gray-800">
        <div class="container mx-auto px-6 text-center text-gray-500 text-sm">
            <p>&copy; <span id="footer-year">2025</span> Shillette. All rights reserved.</p>
        </div>
    </footer>

    <script>
        // --- DOM Element References ---
        const pageSections = { // Map hash to element ID
            '#home': 'main-content',
            '#products': 'products-page-content',
            '#tickets': 'tickets-page-content',
            '#dashboard': 'dashboard-content',
            '#ticketDetail': 'ticket-detail-content'
        };
        // Header & User
        const siteTitleDisplay = document.getElementById('site-title-display');
        const mainNavigation = document.getElementById('main-navigation');
        const mobileMenuNav = document.getElementById('mobile-menu');
        const loginButton = document.getElementById('login-button');
        const logoutButton = document.getElementById('logout-button');
        const dashboardLogoutButton = document.getElementById('dashboard-logout-button');
        const userInfo = document.getElementById('user-info');
        const userNameDisplay = document.getElementById('user-name');
        const userAvatarDisplay = document.getElementById('user-avatar');
        const dashboardUserNameDisplay = document.getElementById('dashboard-user-name');
        const dashboardUserAvatarDisplay = document.getElementById('dashboard-user-avatar');
        const dashboardUserRolesContainer = document.getElementById('dashboard-user-roles');
        // Popups & Overlays
        const snowContainer = document.getElementById('snow-container');
        const paymentMessage = document.getElementById('payment-message');
        const ticketMessagePopup = document.getElementById('ticket-message');
        const errorMessagePopup = document.getElementById('error-message');
        const configMessagePopup = document.getElementById('config-message'); // New
        const productMessagePopup = document.getElementById('product-message'); // New
        const loadingOverlay = document.getElementById('loading-overlay');
        // Tickets
        const createTicketForm = document.getElementById('create-ticket-form');
        const ticketSubjectInput = document.getElementById('ticket-subject');
        const ticketMessageInput = document.getElementById('ticket-message-input');
        const createTicketStatus = document.getElementById('create-ticket-status');
        const userTicketView = document.getElementById('user-ticket-view');
        const moderatorManagementView = document.getElementById('moderator-management-view');
        const ticketListDiv = document.getElementById('ticket-list');
        const ticketListStatus = document.getElementById('ticket-list-status');
        const moderatorActiveTicketListDiv = document.getElementById('moderator-active-ticket-list');
        const moderatorActiveListStatus = document.getElementById('moderator-active-list-status');
        const moderatorArchivedTicketListDiv = document.getElementById('moderator-archived-ticket-list');
        const moderatorArchivedListStatus = document.getElementById('moderator-archived-list-status');
        // Ticket Detail
        const ticketDetailSubject = document.getElementById('ticket-detail-subject');
        const chatMessagesDiv = document.getElementById('chat-messages');
        const chatInputForm = document.getElementById('chat-input-form');
        const chatInput = document.getElementById('chat-input');
        const sendChatButton = document.getElementById('send-chat-button');
        const backToTicketsButton = document.getElementById('back-to-tickets-button');
        // Modals & Context Menus
        const userInfoModal = document.getElementById('user-info-modal');
        const modalCloseButton = document.getElementById('modal-close-button');
        const modalUsername = document.getElementById('modal-username');
        const modalUserId = document.getElementById('modal-user-id');
        const modalUserRoles = document.getElementById('modal-user-roles');
        const chatContextMenu = document.getElementById('chat-context-menu');
        const contextDeleteButton = document.getElementById('context-delete-message');
        const contextUserInfoButton = document.getElementById('context-user-info');
        const ticketContextMenu = document.getElementById('ticket-context-menu');
        const contextCloseTicketButton = document.getElementById('context-close-ticket');
        const contextReopenTicketButton = document.getElementById('context-reopen-ticket');
        const contextDeleteTicketButton = document.getElementById('context-delete-ticket');
        const mobileMenuButton = document.getElementById('mobile-menu-button');
        // Products Page
        const productGrid = document.getElementById('product-grid'); // New
        const productLoadingStatus = document.getElementById('product-loading-status'); // New
        // Admin Dashboard
        const adminDashboardSections = document.getElementById('admin-dashboard-sections'); // New container
        const siteConfigForm = document.getElementById('site-config-form'); // New
        const configSiteTitleInput = document.getElementById('config-site-title'); // New
        const configHeaderLinksContainer = document.getElementById('config-header-links-container'); // New
        const addHeaderLinkButton = document.getElementById('add-header-link-button'); // New
        const saveConfigButton = document.getElementById('save-config-button'); // New
        const configSaveStatus = document.getElementById('config-save-status'); // New
        const addProductButton = document.getElementById('add-product-button'); // New
        const productListTableBody = document.getElementById('product-list-tbody'); // New
        const productListStatus = document.getElementById('product-list-status'); // New
        // Product Edit Modal
        const productEditModal = document.getElementById('product-edit-modal'); // New
        const productModalCloseButton = document.getElementById('product-modal-close-button'); // New
        const productModalTitle = document.getElementById('product-modal-title'); // New
        const productEditForm = document.getElementById('product-edit-form'); // New
        const productEditIdInput = document.getElementById('product-edit-id'); // New
        const productEditNameInput = document.getElementById('product-edit-name'); // New
        const productEditPriceInput = document.getElementById('product-edit-price'); // New
        const productEditTagInput = document.getElementById('product-edit-tag'); // New
        const productEditTagColorSelect = document.getElementById('product-edit-tagColor'); // New
        const productEditDescriptionInput = document.getElementById('product-edit-description'); // New
        const productEditFeaturesInput = document.getElementById('product-edit-features'); // New
        const productEditPaymentLinkInput = document.getElementById('product-edit-paymentLink'); // New
        const productSaveButton = document.getElementById('product-save-button'); // New
        const productEditStatus = document.getElementById('product-edit-status'); // New
        // Footer
        const footerYear = document.getElementById('footer-year');


        // --- Configuration ---
        const API_BASE_URL = 'https://api.shillette.com'; // Ensure this matches your backend URL
        const SOCKET_URL = 'https://api.shillette.com';

        // --- State Variables ---
        let currentUser = null;
        let siteConfig = null; // New state for site config
        let socket = null;
        let currentTicketId = null;
        let activeSectionId = null; // Stores the ID ('main-content', 'products-page-content', etc.)
        let currentContextMenu = null;
        let contextMenuData = { ticketId: null, messageTimestamp: null, senderId: null, ticketStatus: null };
        let isInitialLoginCheckComplete = false;
        let isInitialConfigLoadComplete = false; // New flag for config load


        // --- Utility Functions ---

        /** Shows a temporary pop-up message. */
        function showPopupMessage(element, message, isError = false, duration = 3500) {
             if (!element) return;
             element.textContent = message;
             element.classList.toggle('bg-red-600', isError);
             element.classList.toggle('bg-green-600', !isError);
             element.classList.add('show');
             setTimeout(() => element.classList.remove('show'), duration);
        }

        /** Updates header UI based on login status. */
        function updateHeaderUI(user) {
             const isLoggedIn = user && user.logged_in;
             loginButton.classList.toggle('hidden', isLoggedIn);
             userInfo.classList.toggle('hidden', !isLoggedIn);
             userInfo.classList.toggle('flex', isLoggedIn); // Ensure flex display when shown

             if (isLoggedIn) {
                 userNameDisplay.textContent = user.username || 'User';
                 userAvatarDisplay.src = user.user_id && user.avatar ? `https://cdn.discordapp.com/avatars/${user.user_id}/${user.avatar}.png?size=32` : 'https://placehold.co/32x32/7f8c8d/ecf0f1?text=?';
                 dashboardUserNameDisplay.textContent = user.username || 'User';
                 dashboardUserAvatarDisplay.src = user.user_id && user.avatar ? `https://cdn.discordapp.com/avatars/${user.user_id}/${user.avatar}.png?size=64` : 'https://placehold.co/64x64/7f8c8d/ecf0f1?text=?';
                 // Show/hide admin sections based on moderator status
                 adminDashboardSections?.classList.toggle('hidden', !user.is_moderator);
             } else {
                 dashboardUserNameDisplay.textContent = 'User';
                 dashboardUserAvatarDisplay.src = 'https://placehold.co/64x64/7f8c8d/ecf0f1?text=?';
                 adminDashboardSections?.classList.add('hidden'); // Ensure admin sections hidden if logged out
             }
        }

        /** Hides all page sections and shows the specified one by its element ID. */
        function showSection(sectionElementId) {
            console.log(`[showSection] Attempting to show element ID: ${sectionElementId}`);
            hideContextMenu(); // Hide context menu when changing sections

            let foundSection = false;
            // Hide all sections first
            Object.values(pageSections).forEach(id => {
                const sectionElement = document.getElementById(id);
                if (sectionElement) {
                    sectionElement.classList.remove('active'); // Use 'active' class now
                    sectionElement.classList.add('hidden'); // Keep hidden for layout consistency
                } else {
                    console.warn(`[showSection] Element not found for ID: ${id}`);
                }
            });

            // Show the target section
            const targetElement = document.getElementById(sectionElementId);
            if (targetElement) {
                targetElement.classList.remove('hidden');
                targetElement.classList.add('active'); // Add 'active' class
                activeSectionId = sectionElementId; // Update the active section ID
                foundSection = true;
                console.log(`[showSection] Successfully shown: ${sectionElementId}`);
            }

            // Default to home if target not found or invalid
            if (!foundSection) {
                console.warn(`[showSection] Target element ID not found: ${sectionElementId}. Defaulting to home.`);
                const homeElement = document.getElementById(pageSections['#home']);
                if (homeElement) {
                    homeElement.classList.remove('hidden');
                    homeElement.classList.add('active');
                    activeSectionId = pageSections['#home'];
                    console.log(`[showSection] Defaulted to ${activeSectionId}.`);
                } else {
                     activeSectionId = null;
                     console.error("[showSection] Could not find home element either!");
                }
            }

            // Disconnect socket ONLY if navigating away from ticket detail AND tickets list
            const isTicketRelated = sectionElementId === pageSections['#ticketDetail'] || sectionElementId === pageSections['#tickets'];
            if (!isTicketRelated) {
                 console.log(`[showSection] Navigating away from tickets/detail, disconnecting socket.`);
                 disconnectSocket();
             }
            // Clear currentTicketId if not on detail page
            if (sectionElementId !== pageSections['#ticketDetail']) {
                 currentTicketId = null;
            }
        }

        /** Handles navigation based on URL hash changes. */
        function navigateTo(hash) {
            console.log(`[navigateTo] Received hash: ${hash}`);
            const baseHash = hash.split('?')[0] || '#home'; // e.g., #home, #ticketDetail
            const targetElementId = pageSections[baseHash] || pageSections['#home']; // Get element ID, default to home

            console.log(`[navigateTo] Base hash: ${baseHash}, Target element ID: ${targetElementId}`);

            const isProtected = ['#dashboard', '#tickets', '#ticketDetail'].includes(baseHash);

            // ** CRITICAL CHECKS **: Wait for both login and config checks before navigating protected routes
            if (isProtected && (!isInitialLoginCheckComplete || !isInitialConfigLoadComplete)) {
                console.log(`[navigateTo] Initial checks not complete for protected route ${baseHash}. Deferring action.`);
                // Optional: Show a global loading indicator here if not already visible
                return;
            }

            console.log(`[navigateTo] Checking protection. Is protected: ${isProtected}, User logged in: ${currentUser?.logged_in}`);
            if (isProtected && (!currentUser || !currentUser.logged_in)) {
                console.log(`[navigateTo] Access denied to protected route: ${baseHash}`);
                showPopupMessage(errorMessagePopup, "Please log in to view this page.", true);
                if (window.location.hash !== '#home' && window.location.hash !== '/#home') {
                    console.log(`[navigateTo] Redirecting to /#home`);
                    window.location.hash = '/#home';
                } else {
                    console.log(`[navigateTo] Already on home, ensuring #home section is shown.`);
                    if(activeSectionId !== pageSections['#home']) showSection(pageSections['#home']);
                }
                return;
            }

            // Ensure socket is connected if navigating to a socket-requiring page
            if (['#tickets', '#ticketDetail'].includes(baseHash)) {
                console.log(`[navigateTo] Ensuring socket is connected for route: ${baseHash}`);
                ensureSocketConnected();
            }

            // Handle Ticket Detail specific logic
            if (baseHash === '#ticketDetail') {
                let id = null;
                const params = new URLSearchParams(hash.split('?')[1] || '');
                id = params.get('id');
                console.log(`[navigateTo] Ticket Detail - ID from URL: ${id}`);
                if (id) {
                    if (currentTicketId !== id) {
                        currentTicketId = id;
                        ticketDetailSubject.textContent = `Ticket #${id.slice(-6)}`;
                        chatMessagesDiv.innerHTML = '<p class="text-gray-500 text-center py-4">Connecting to chat...</p>';
                        fetchTicketDetails(id);
                    } else {
                         console.log(`[navigateTo] Already viewing ticket ${id}, not re-fetching details.`);
                         if (socket && socket.connected) socket.emit('join_ticket_room', { ticket_id: currentTicketId });
                    }
                } else {
                    console.warn("[navigateTo] Ticket ID missing for detail view. Redirecting to tickets list.");
                    showPopupMessage(errorMessagePopup, "Invalid ticket link.", true);
                    window.location.hash = '/#tickets';
                    return;
                }
            }

            // Show the correct section
            showSection(targetElementId);

            // Fetch data if needed for the newly shown section
            if (baseHash === '#tickets') {
                console.log(`[navigateTo] Fetching tickets for #tickets view.`);
                fetchTickets();
            } else if (baseHash === '#products') {
                 console.log(`[navigateTo] Fetching products for #products view.`);
                 fetchProducts(); // Fetch products when navigating to products page
            } else if (baseHash === '#dashboard' && currentUser?.logged_in) {
                 console.log(`[navigateTo] Loading dashboard data.`);
                 displayUserRoles(currentUser.roles); // Display roles
                 if (currentUser.is_moderator) {
                     loadAdminDashboardData(); // Load config and products for admin view
                 }
            }

            updateHeaderUI(currentUser); // Update header based on login status
        }

        /** Runs navigation logic based on current URL hash. */
        function runNavigation() {
            console.log(`[runNavigation] Processing raw hash: ${window.location.hash}`);
            const rawHash = window.location.hash;
            let pathPart = '';
            const firstHashIndex = rawHash.indexOf('#');
            if (firstHashIndex !== -1) {
                pathPart = rawHash.substring(firstHashIndex + 1);
                while (pathPart.startsWith('/') || pathPart.startsWith('#')) {
                    pathPart = pathPart.substring(1);
                }
            }
            const hashToNavigate = `#${pathPart || 'home'}`;
            console.log(`[runNavigation] Cleaned hash to navigate: ${hashToNavigate}`);

            // Call navigateTo only if initial checks are complete OR target is home
            if ((isInitialLoginCheckComplete && isInitialConfigLoadComplete) || hashToNavigate === '#home') {
                navigateTo(hashToNavigate);
            } else {
                console.log(`[runNavigation] Initial checks not complete for target ${hashToNavigate}. Deferring.`);
            }
        }

        /** Creates snowflake effect. */
        function createSnowflakes() { /* ... (keep existing snowflake code) ... */ }

        /** Checks login status via API, then triggers config load. */
        async function checkLoginStatus() {
             isInitialLoginCheckComplete = false;
             try {
                 const response = await fetch(`${API_BASE_URL}/api/user`, { credentials: 'include' });
                 if (!response.ok && (response.status === 401 || response.status === 403)) {
                     currentUser = { logged_in: false };
                 } else if (!response.ok) {
                     throw new Error(`HTTP error! status: ${response.status}`);
                 } else {
                     currentUser = await response.json();
                 }
                 console.log("[checkLoginStatus] User status checked:", currentUser);
                 if (currentUser && currentUser.logged_in) {
                     ensureSocketConnected(); // Connect socket early if logged in
                 }
             } catch (error) {
                 console.error("[checkLoginStatus] Error checking login status:", error);
                 currentUser = { logged_in: false };
                 showPopupMessage(errorMessagePopup, "Could not verify login status.", true);
             } finally {
                 isInitialLoginCheckComplete = true;
                 console.log("[checkLoginStatus] Initial login check complete.");
                 // Now that login status is known, load config
                 loadSiteConfigAndNavigate();
             }
        }

        /** Fetches site config and applies it, then runs navigation. */
        async function loadSiteConfigAndNavigate() {
            isInitialConfigLoadComplete = false;
            try {
                const response = await fetch(`${API_BASE_URL}/api/config`);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                siteConfig = await response.json();
                console.log("[loadSiteConfig] Site config loaded:", siteConfig);
                applySiteConfig(siteConfig); // Apply the loaded config
            } catch (error) {
                console.error("[loadSiteConfig] Error loading site config:", error);
                showPopupMessage(errorMessagePopup, "Failed to load site configuration. Using defaults.", true);
                // Apply default fallbacks if needed, or just let existing HTML stand
                applySiteConfig(null); // Apply defaults/fallbacks
            } finally {
                isInitialConfigLoadComplete = true;
                console.log("[loadSiteConfig] Initial config load complete.");
                // Now that both checks are done, run navigation
                runNavigation();
            }
        }

        /** Applies fetched site configuration to the UI. */
        function applySiteConfig(config) {
            // Use default values if config is null or missing properties
            const title = config?.siteTitle || "Shillette";
            const links = config?.headerLinks || [
                {name: "Home", href: "/#home"}, {name: "Products", href: "/#products"},
                {name: "Tickets", href: "/#tickets"}, {name: "Discord", href: "https://discord.gg/shillette", target: "_blank"}
            ];
            // Apply Gradient (Example - more complex logic might be needed)
            // if (config?.gradient?.colors?.length >= 2) {
            //     const gradientStyle = `linear-gradient(${config.gradient.angle || 145}deg, ${config.gradient.colors.join(', ')})`;
            //     document.body.style.backgroundImage = gradientStyle;
            // }

            // Set Page Title
            document.title = title;
            siteTitleDisplay.textContent = title;

            // Build Navigation Links
            mainNavigation.innerHTML = ''; // Clear existing
            mobileMenuNav.innerHTML = ''; // Clear existing mobile links
            links.forEach(link => {
                // Main Nav
                const a = document.createElement('a');
                a.href = link.href;
                a.textContent = link.name;
                a.classList.add('text-gray-300', 'hover:text-white', 'transition', 'duration-200');
                if (link.target) a.target = link.target;
                if (link.target === '_blank') a.rel = 'noopener noreferrer';
                mainNavigation.appendChild(a);

                // Mobile Nav
                const mob_a = a.cloneNode(true); // Clone for mobile
                mob_a.classList.remove('text-gray-300', 'hover:text-white');
                mob_a.classList.add('mobile-menu-link');
                // Add listener to close mobile menu on click
                mob_a.addEventListener('click', () => mobileMenuNav.classList.add('hidden'));
                mobileMenuNav.appendChild(mob_a);
            });

            // Update Footer Year
            footerYear.textContent = new Date().getFullYear();
        }

        /** Fetches and displays products on the products page. */
        async function fetchProducts() {
             if (!productGrid || !productLoadingStatus) return;
             productGrid.innerHTML = ''; // Clear previous products
             productLoadingStatus.textContent = 'Loading products...';
             productLoadingStatus.classList.remove('hidden');

             try {
                 const response = await fetch(`${API_BASE_URL}/api/products`);
                 if (!response.ok) throw new Error(`HTTP ${response.status}`);
                 const products = await response.json();

                 productLoadingStatus.classList.add('hidden'); // Hide loading message

                 if (!products || products.length === 0) {
                     productGrid.innerHTML = '<p class="text-center text-gray-400 md:col-span-2">No products available at this time.</p>';
                     return;
                 }

                 products.forEach(renderProductCard); // Render each product

             } catch (error) {
                 console.error("Error fetching products:", error);
                 productLoadingStatus.textContent = 'Failed to load products.';
                 showPopupMessage(errorMessagePopup, `Error loading products: ${error.message}`, true);
             }
        }

        /** Renders a single product card and appends it to the grid. */
        function renderProductCard(product) {
             if (!productGrid) return;

             const card = document.createElement('div');
             const tagColor = product.tagColor || 'gray'; // Default to gray
             const borderClass = `${tagColor}-border`; // e.g., orange-border, gray-border

             card.className = `product-card card-gradient-border ${borderClass}`; // Add dynamic border class

             // Basic structure (adapt based on your product data fields)
             card.innerHTML = `
                 <div class="flex justify-between items-center mb-4">
                     <span class="bg-${tagColor}-500/20 text-${tagColor}-300 text-xs font-semibold px-2.5 py-0.5 rounded">${product.tag || 'PRODUCT'}</span>
                     </div>
                 <h3 class="text-xl font-semibold text-white mb-2">${product.name || 'Unnamed Product'}</h3>
                 <p class="text-3xl font-bold text-white mb-4">$${product.price?.toFixed(2) || 'N/A'}</p>
                 <ul class="text-sm text-gray-400 space-y-2 mb-6 flex-grow">
                     ${(product.features || []).map(feature => `<li class="flex items-center"><svg class="w-4 h-4 mr-2 text-green-500" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path></svg> ${feature}</li>`).join('')}
                     ${!(product.features && product.features.length > 0) ? '<li class="text-gray-500">No features listed.</li>' : ''}
                 </ul>
                 <div class="mt-auto space-y-3 pt-4 border-t border-slate-700/50">
                     ${product.paymentLink ? `<button class="purchase-button" data-product-id="${product._id}" data-payment-link="${product.paymentLink}">Pay with PayPal</button>` : '<button class="purchase-button" disabled>Purchase Unavailable</button>'}
                     </div>
             `;

             // Add event listener for the purchase button if needed
             const purchaseBtn = card.querySelector('.purchase-button');
             if (purchaseBtn && !purchaseBtn.disabled) {
                 purchaseBtn.addEventListener('click', handlePurchaseClick); // Define handlePurchaseClick
             }

             productGrid.appendChild(card);
        }

        /** Placeholder for handling purchase clicks */
        function handlePurchaseClick(event) {
            const button = event.target;
            const productId = button.dataset.productId;
            const paymentLink = button.dataset.paymentLink; // Could be a PayPal ID or a full URL
            console.log(`Purchase clicked for product ID: ${productId}, Link/ID: ${paymentLink}`);
            // Implement actual purchase logic here
            // e.g., redirect to PayPal, call Stripe API, etc.
            if (paymentLink) {
                 // Simple example: Assume it's a full URL for now
                 // window.location.href = paymentLink;
                 // Or if it's a PayPal button ID, trigger specific PayPal logic
                 showPopupMessage(paymentMessage, `Initiating purchase for product ${productId}... (Integration needed)`);
            } else {
                 showPopupMessage(errorMessagePopup, 'Payment link is missing for this product.', true);
            }
        }


        /** Fetches the list of tickets (user's or all). */
        async function fetchTickets() { /* ... (keep existing fetchTickets code, ensure it uses serialize_doc logic if needed) ... */ }
        /** Fetches details for a specific ticket. */
        async function fetchTicketDetails(ticketId) { /* ... (keep existing fetchTicketDetails code, ensure it uses serialize_doc logic if needed) ... */ }
        /** Appends a chat message to the display. */
        function appendChatMessage(data) { /* ... (keep existing appendChatMessage code) ... */ }
        /** Establishes WebSocket connection. */
        function connectSocket(ticketIdToJoin = null) { /* ... (keep existing connectSocket code) ... */ }
        /** Ensures WebSocket is connected. */
        function ensureSocketConnected() { /* ... (keep existing ensureSocketConnected code) ... */ }
        /** Sets up WebSocket event listeners. */
        function setupSocketListeners() { /* ... (keep existing setupSocketListeners code) ... */ }
        /** Disconnects WebSocket. */
        function disconnectSocket() { /* ... (keep existing disconnectSocket code) ... */ }
        /** Displays user roles. */
        function displayUserRoles(roles) { /* ... (keep existing displayUserRoles code, ensure it uses sorted roles) ... */ }
        /** Shows user info modal. */
        function showUserInfoModal(senderId, username) { /* ... (keep existing showUserInfoModal code) ... */ }
        /** Hides user info modal. */
        function hideUserInfoModal() { /* ... (keep existing hideUserInfoModal code) ... */ }
        /** Positions context menu. */
        function positionContextMenu(menuElement, event) { /* ... (keep existing positionContextMenu code) ... */ }
        /** Hides context menu. */
        function hideContextMenu() { /* ... (keep existing hideContextMenu code) ... */ }
        /** Shows chat context menu. */
        function showChatContextMenu(event) { /* ... (keep existing showChatContextMenu code) ... */ }
        /** Shows ticket context menu. */
        function showTicketContextMenu(event) { /* ... (keep existing showTicketContextMenu code) ... */ }
        /** Deletes chat message via socket. */
        function deleteChatMessage() { /* ... (keep existing deleteChatMessage code) ... */ }
        /** Closes ticket via socket. */
        function closeTicket() { /* ... (keep existing closeTicket code) ... */ }
        /** Reopens ticket via socket. */
        function reopenTicket() { /* ... (keep existing reopenTicket code) ... */ }
        /** Deletes ticket via socket. */
        function deleteTicket() { /* ... (keep existing deleteTicket code) ... */ }


        // --- Admin Dashboard Functions ---

        /** Loads data needed for the admin sections (config, products). */
        async function loadAdminDashboardData() {
            console.log("Loading admin dashboard data...");
            if (!currentUser?.is_moderator) return; // Should not be called if not mod

            // Load site config into the form
            await loadSiteConfigForm();
            // Load products into the table
            await loadProductManagementTable();
        }

        /** Fetches site config and populates the admin form. */
        async function loadSiteConfigForm() {
            if (!siteConfigForm) return;
            // Use the already loaded siteConfig if available
            if (!siteConfig) {
                console.warn("Site config not loaded yet for admin form.");
                // Optionally try fetching again, but it should be loaded by loadSiteConfigAndNavigate
                configSaveStatus.textContent = "Error: Config not loaded.";
                configSaveStatus.classList.add('text-red-400');
                return;
            }

            configSiteTitleInput.value = siteConfig.siteTitle || '';

            // Populate header links
            configHeaderLinksContainer.innerHTML = ''; // Clear existing
            (siteConfig.headerLinks || []).forEach((link, index) => {
                addHeaderLinkInput(link.name, link.href, link.target);
            });

            // Populate other config fields here...
        }

        /** Adds a row of inputs for a header link to the config form. */
        function addHeaderLinkInput(name = '', href = '', target = '') {
             const linkGroup = document.createElement('div');
             linkGroup.className = 'link-group';
             linkGroup.innerHTML = `
                 <input type="text" placeholder="Link Name" value="${name}" class="link-name flex-1" required>
                 <input type="text" placeholder="Link Href" value="${href}" class="link-href flex-1" required>
                 <input type="text" placeholder="Target (e.g., _blank)" value="${target}" class="link-target flex-auto w-24">
                 <button type="button" class="remove-link-button" title="Remove Link">X</button>
             `;
             linkGroup.querySelector('.remove-link-button').addEventListener('click', () => linkGroup.remove());
             configHeaderLinksContainer.appendChild(linkGroup);
        }

        /** Handles saving the site configuration. */
        async function handleSaveSiteConfig(event) {
            event.preventDefault();
            if (!siteConfigForm) return;
            saveConfigButton.disabled = true;
            saveConfigButton.textContent = 'Saving...';
            configSaveStatus.textContent = '';
            configSaveStatus.className = 'text-sm text-center h-5 mt-2'; // Reset class

            // Gather data from form
            const updatedConfig = {
                siteTitle: configSiteTitleInput.value.trim(),
                headerLinks: []
                // Gather other config fields...
            };

            // Gather header links
            configHeaderLinksContainer.querySelectorAll('.link-group').forEach(group => {
                const nameInput = group.querySelector('.link-name');
                const hrefInput = group.querySelector('.link-href');
                const targetInput = group.querySelector('.link-target');
                if (nameInput.value.trim() && hrefInput.value.trim()) {
                    updatedConfig.headerLinks.push({
                        name: nameInput.value.trim(),
                        href: hrefInput.value.trim(),
                        target: targetInput.value.trim() || null // Store null if empty
                    });
                }
            });

            try {
                const response = await fetch(`${API_BASE_URL}/api/config`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(updatedConfig),
                    credentials: 'include'
                });
                const result = await response.json();
                if (!response.ok) throw new Error(result.error || `HTTP ${response.status}`);

                // Update local siteConfig state and re-apply
                siteConfig = result;
                applySiteConfig(siteConfig);

                configSaveStatus.textContent = 'Configuration saved successfully!';
                configSaveStatus.classList.add('text-green-400');
                showPopupMessage(configMessagePopup, 'Configuration saved!');

            } catch (error) {
                console.error("Error saving site config:", error);
                configSaveStatus.textContent = `Error: ${error.message}`;
                configSaveStatus.classList.add('text-red-400');
                showPopupMessage(errorMessagePopup, `Failed to save config: ${error.message}`, true);
            } finally {
                saveConfigButton.disabled = false;
                saveConfigButton.textContent = 'Save Configuration';
            }
        }

        /** Fetches products and populates the management table. */
        async function loadProductManagementTable() {
             if (!productListTableBody || !productListStatus) return;
             productListTableBody.innerHTML = ''; // Clear table
             productListStatus.textContent = 'Loading products...';
             productListStatus.classList.remove('hidden');

             try {
                 const response = await fetch(`${API_BASE_URL}/api/products`); // No credentials needed for GET
                 if (!response.ok) throw new Error(`HTTP ${response.status}`);
                 const products = await response.json();

                 productListStatus.classList.add('hidden'); // Hide loading message

                 if (!products || products.length === 0) {
                     productListStatus.textContent = 'No products found.';
                     productListStatus.classList.remove('hidden');
                     return;
                 }

                 products.forEach(product => {
                     const row = productListTableBody.insertRow();
                     row.innerHTML = `
                         <td>${product.name || 'N/A'}</td>
                         <td>$${product.price?.toFixed(2) || 'N/A'}</td>
                         <td>${product.tag || '-'}</td>
                         <td class="actions">
                             <button class="edit-btn" data-product-id="${product._id}">Edit</button>
                             <button class="delete-btn" data-product-id="${product._id}">Delete</button>
                         </td>
                     `;
                     // Add event listeners for edit/delete buttons
                     row.querySelector('.edit-btn').addEventListener('click', () => openProductEditModal(product));
                     row.querySelector('.delete-btn').addEventListener('click', () => handleDeleteProduct(product._id, product.name));
                 });

             } catch (error) {
                 console.error("Error loading products for admin table:", error);
                 productListStatus.textContent = 'Failed to load products.';
                 productListStatus.classList.remove('hidden');
                 showPopupMessage(errorMessagePopup, `Error loading products: ${error.message}`, true);
             }
        }

        /** Opens the Add/Edit Product modal. */
        function openProductEditModal(product = null) { // Pass product object for editing, null for adding
             if (!productEditModal || !productEditForm) return;
             productEditForm.reset(); // Clear form
             productEditStatus.textContent = '';
             productEditStatus.className = 'text-sm text-center h-5 mt-2'; // Reset status style

             if (product) {
                 // Editing existing product
                 productModalTitle.textContent = 'Edit Product';
                 productEditIdInput.value = product._id;
                 productEditNameInput.value = product.name || '';
                 productEditPriceInput.value = product.price || '';
                 productEditTagInput.value = product.tag || '';
                 productEditTagColorSelect.value = product.tagColor || 'gray';
                 productEditDescriptionInput.value = product.description || '';
                 productEditFeaturesInput.value = (product.features || []).join('\n');
                 productEditPaymentLinkInput.value = product.paymentLink || '';
             } else {
                 // Adding new product
                 productModalTitle.textContent = 'Add Product';
                 productEditIdInput.value = ''; // Clear ID field
             }
             productEditModal.classList.add('active'); // Show modal
        }

        /** Closes the Add/Edit Product modal. */
        function closeProductEditModal() {
             if (productEditModal) productEditModal.classList.remove('active');
        }

        /** Handles saving (add/update) a product from the modal form. */
        async function handleSaveProduct(event) {
             event.preventDefault();
             if (!productEditForm) return;
             productSaveButton.disabled = true;
             productSaveButton.textContent = 'Saving...';
             productEditStatus.textContent = '';
             productEditStatus.className = 'text-sm text-center h-5 mt-2';

             const productId = productEditIdInput.value;
             const isEditing = !!productId;
             const url = isEditing ? `${API_BASE_URL}/api/products/${productId}` : `${API_BASE_URL}/api/products`;
             const method = isEditing ? 'PUT' : 'POST';

             const productData = {
                 name: productEditNameInput.value.trim(),
                 price: parseFloat(productEditPriceInput.value),
                 tag: productEditTagInput.value.trim() || null,
                 tagColor: productEditTagColorSelect.value || 'gray',
                 description: productEditDescriptionInput.value.trim() || null,
                 features: productEditFeaturesInput.value.split('\n').map(f => f.trim()).filter(f => f), // Split lines, trim, remove empty
                 paymentLink: productEditPaymentLinkInput.value.trim() || null
             };

             // Basic validation
             if (!productData.name || isNaN(productData.price)) {
                  productEditStatus.textContent = 'Name and valid Price are required.';
                  productEditStatus.classList.add('text-red-400');
                  productSaveButton.disabled = false;
                  productSaveButton.textContent = 'Save Product';
                  return;
             }


             try {
                 const response = await fetch(url, {
                     method: method,
                     headers: { 'Content-Type': 'application/json' },
                     body: JSON.stringify(productData),
                     credentials: 'include' // Needed for moderator check
                 });
                 const result = await response.json();
                 if (!response.ok) throw new Error(result.error || `HTTP ${response.status}`);

                 showPopupMessage(productMessagePopup, `Product ${isEditing ? 'updated' : 'added'} successfully!`);
                 closeProductEditModal();
                 await loadProductManagementTable(); // Refresh the product list table
                 // Also refresh the public products page if it might be visible
                 if (activeSectionId === pageSections['#products']) {
                     await fetchProducts();
                 }

             } catch (error) {
                 console.error(`Error ${isEditing ? 'updating' : 'adding'} product:`, error);
                 productEditStatus.textContent = `Error: ${error.message}`;
                 productEditStatus.classList.add('text-red-400');
                 showPopupMessage(errorMessagePopup, `Failed to save product: ${error.message}`, true);
             } finally {
                 productSaveButton.disabled = false;
                 productSaveButton.textContent = 'Save Product';
             }
        }

        /** Handles deleting a product after confirmation. */
        async function handleDeleteProduct(productId, productName) {
            if (!productId) return;
            if (!confirm(`Are you sure you want to delete the product "${productName || 'this product'}"? This cannot be undone.`)) {
                return;
            }

            // Show loading state? Maybe disable delete button?
            console.log(`Attempting to delete product: ${productId}`);

            try {
                const response = await fetch(`${API_BASE_URL}/api/products/${productId}`, {
                    method: 'DELETE',
                    credentials: 'include' // Needed for moderator check
                });
                const result = await response.json();
                if (!response.ok) throw new Error(result.error || `HTTP ${response.status}`);

                showPopupMessage(productMessagePopup, 'Product deleted successfully!');
                await loadProductManagementTable(); // Refresh the product list table
                 // Also refresh the public products page if it might be visible
                 if (activeSectionId === pageSections['#products']) {
                     await fetchProducts();
                 }

            } catch (error) {
                console.error("Error deleting product:", error);
                showPopupMessage(errorMessagePopup, `Failed to delete product: ${error.message}`, true);
            }
        }


        // --- Event Listeners Setup ---

        // Login Button
        loginButton.addEventListener('click', (e) => {
            e.preventDefault(); window.location.href = loginButton.href;
        });

        /** Handles the logout process. */
        async function handleLogout() {
            console.log('Logging out...');
            try {
                // Call backend logout first
                const response = await fetch(`${API_BASE_URL}/logout`, { credentials: 'include' });
                if (!response.ok) {
                    let errorMsg = 'Logout request failed';
                    try { const errorData = await response.json(); errorMsg = errorData.error || errorMsg; } catch (parseError) {}
                    console.warn(`Backend logout failed: ${errorMsg}. Proceeding with client-side cleanup.`);
                    // Don't throw here, let client-side cleanup happen anyway
                }

                // --- Client-side cleanup ---
                currentUser = { logged_in: false }; // Update state immediately
                isInitialLoginCheckComplete = false; // Reset flag, requires re-check on next load/nav
                isInitialConfigLoadComplete = false; // Reset config flag too
                localStorage.removeItem('currentPage'); // Clear any saved state
                disconnectSocket(); // Disconnect socket

                // Update UI immediately before redirect
                updateHeaderUI(currentUser);
                // Hide admin sections if they were visible
                adminDashboardSections?.classList.add('hidden');

                // Redirect to home - this will trigger hashchange -> runNavigation -> checks
                console.log("Redirecting to /#home after logout cleanup.");
                window.location.hash = '/#home';

            } catch(error) {
                // Catch fetch errors specifically
                console.error("Network error during logout fetch:", error);
                showPopupMessage(errorMessagePopup, `Logout failed: ${error.message}`, true);
                // Still attempt client-side cleanup even on fetch error
                currentUser = { logged_in: false };
                isInitialLoginCheckComplete = false;
                isInitialConfigLoadComplete = false;
                localStorage.removeItem('currentPage');
                disconnectSocket();
                updateHeaderUI(currentUser);
                adminDashboardSections?.classList.add('hidden');
                window.location.hash = '/#home';
            }
        }
        logoutButton.addEventListener('click', handleLogout);
        dashboardLogoutButton.addEventListener('click', handleLogout);

        // Hash Change Listener
        window.addEventListener('hashchange', runNavigation);

        // Create Ticket Form Submission
        if(createTicketForm) createTicketForm.addEventListener('submit', async (event) => { /* ... (keep existing code) ... */ });
        // Chat Input Form Submission
        if(chatInputForm) chatInputForm.addEventListener('submit', (event) => { /* ... (keep existing code) ... */ });
        // Modal Close Button Listener
        if (modalCloseButton) modalCloseButton.addEventListener('click', hideUserInfoModal);
        // Close user info modal on backdrop click
        if (userInfoModal) userInfoModal.addEventListener('click', (event) => { if (event.target === userInfoModal) hideUserInfoModal(); });
        // Chat Context Menu Action Listeners
        if (contextDeleteButton) contextDeleteButton.addEventListener('click', deleteChatMessage);
        if (contextUserInfoButton) contextUserInfoButton.addEventListener('click', () => { /* ... (keep existing code) ... */ });
        // Ticket Context Menu Action Listeners
        if (contextCloseTicketButton) contextCloseTicketButton.addEventListener('click', closeTicket);
        if (contextReopenTicketButton) contextReopenTicketButton.addEventListener('click', reopenTicket);
        if (contextDeleteTicketButton) contextDeleteTicketButton.addEventListener('click', deleteTicket);
        // Mobile Menu Toggle
        if (mobileMenuButton && mobileMenuNav) mobileMenuButton.addEventListener('click', () => mobileMenuNav.classList.toggle('hidden'));

        // --- NEW Admin Dashboard Event Listeners ---
        if (siteConfigForm) siteConfigForm.addEventListener('submit', handleSaveSiteConfig);
        if (addHeaderLinkButton) addHeaderLinkButton.addEventListener('click', () => addHeaderLinkInput());
        if (addProductButton) addProductButton.addEventListener('click', () => openProductEditModal()); // Open modal for adding
        if (productEditModal && productModalCloseButton) productModalCloseButton.addEventListener('click', closeProductEditModal);
        if (productEditModal) productEditModal.addEventListener('click', (event) => { if (event.target === productEditModal) closeProductEditModal(); }); // Close on backdrop click
        if (productEditForm) productEditForm.addEventListener('submit', handleSaveProduct);


        // --- Initial Page Load Logic ---
        document.addEventListener('DOMContentLoaded', () => {
            console.log("DOM fully loaded.");
            createSnowflakes();
            // Start the process: Check login -> Load Config -> Run Navigation
            checkLoginStatus();
        });

    </script>

</body>
</html>
