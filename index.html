<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shillette</title>
    <link id="favicon" rel="icon" href="images/icon.png" type="image/png"> {/* Add ID for easy selection */}
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
    <style type="text/tailwindcss">
        /* --- Animations --- */
        @keyframes animateGradient { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }
        @keyframes spinBorder { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }
        @keyframes fall { 0% { transform: translateY(-10vh) translateX(0); opacity: 1; } 100% { transform: translateY(110vh) translateX(5vw); opacity: 0; } }
        @keyframes scaleUpDown { 0%, 100% { transform: scaleY(0.4); } 20% { transform: scaleY(1.0); } }

        /* --- Base Styles --- */
        body {
            font-family: 'Inter', sans-serif;
            @apply bg-gradient-to-br from-orange-700 via-black to-black text-gray-300;
            background-size: 200% 200%;
            animation: animateGradient 25s ease infinite;
            overflow-x: hidden; position: relative; z-index: 0;
        }
        body::before { content: ''; position: fixed; inset: 0; background-image: url('images/background.png'); background-size: cover; background-position: center center; background-repeat: no-repeat; background-attachment: fixed; opacity: 0.2; z-index: -1; }

        /* --- Snow Effect --- */
        #snow-container { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 40; overflow: hidden; }
        .snowflake { position: absolute; background-color: white; border-radius: 50%; pointer-events: none; animation-name: fall; animation-timing-function: linear; animation-iteration-count: infinite; }

        /* --- Card Styles --- */
        .card-gradient-border::before { content: ''; position: absolute; inset: 0; border-radius: 0.5rem; padding: 2px; background-size: 300% 300%; animation: spinBorder 5s linear infinite; -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0); -webkit-mask-composite: xor; mask-composite: exclude; pointer-events: none; z-index: -1; }
        .card-gradient-border.orange-border::before { background-image: linear-gradient(145deg, #f97316, #9a3412, #000000); }
        .card-gradient-border.gray-border::before { background-image: linear-gradient(145deg, #9ca3af, #374151, #000000); animation-duration: 6s; }
        .card-gradient-border.blue-border::before { background-image: linear-gradient(145deg, #3b82f6, #1e40af, #000000); animation-duration: 5.5s; }
        .card-gradient-border.green-border::before { background-image: linear-gradient(145deg, #22c55e, #15803d, #000000); animation-duration: 6.5s; }
        .card-gradient-border.red-border::before { background-image: linear-gradient(145deg, #ef4444, #991b1b, #000000); animation-duration: 4.5s; }
        .card-gradient-border.purple-border::before { background-image: linear-gradient(145deg, #a855f7, #6b21a8, #000000); animation-duration: 5.8s; }
        .card-gradient-border.yellow-border::before { background-image: linear-gradient(145deg, #eab308, #a16207, #000000); animation-duration: 5.2s; }
        .card-gradient-border.pink-border::before { background-image: linear-gradient(145deg, #ec4899, #be185d, #000000); animation-duration: 5.6s; }
        .card-gradient-border.teal-border::before { background-image: linear-gradient(145deg, #14b8a6, #0f766e, #000000); animation-duration: 6.1s; }
        .card-gradient-border.custom-border { border-width: 2px; border-style: solid; } /* Style for custom HEX border */

        /* Product Card General Styling */
        .product-card { @apply relative bg-slate-800/80 backdrop-blur-sm rounded-lg shadow-xl flex flex-col z-0; overflow: hidden; transition: transform 0.3s ease-in-out, box-shadow 0.3s ease-in-out; }
        .product-card:not(.custom-border) { @apply p-0; } /* Remove padding only if using gradient border */
        .product-card.custom-border { @apply p-0; } /* Remove padding for custom border too, rely on inner div */
        .product-card-inner { @apply p-6 flex flex-col flex-grow; } /* Inner container for padding */
        .product-card:hover { transform: scale(1.03); }

        /* Hover effects for Gradient Borders */
        .product-card.card-gradient-border.orange-border:hover { box-shadow: 0 0 8px 1px rgba(249, 115, 22, 0.6), 0 0 16px 4px rgba(249, 115, 22, 0.4), 0 0 32px 8px rgba(249, 115, 22, 0.2); }
        .product-card.card-gradient-border.gray-border:hover { box-shadow: 0 0 8px 1px rgba(156, 163, 175, 0.5), 0 0 16px 4px rgba(156, 163, 175, 0.3), 0 0 32px 8px rgba(156, 163, 175, 0.15); }
        .product-card.card-gradient-border.blue-border:hover { box-shadow: 0 0 8px 1px rgba(59, 130, 246, 0.6), 0 0 16px 4px rgba(59, 130, 246, 0.4), 0 0 32px 8px rgba(59, 130, 246, 0.2); }
        .product-card.card-gradient-border.green-border:hover { box-shadow: 0 0 8px 1px rgba(34, 197, 94, 0.6), 0 0 16px 4px rgba(34, 197, 94, 0.4), 0 0 32px 8px rgba(34, 197, 94, 0.2); }
        .product-card.card-gradient-border.red-border:hover { box-shadow: 0 0 8px 1px rgba(239, 68, 68, 0.6), 0 0 16px 4px rgba(239, 68, 68, 0.4), 0 0 32px 8px rgba(239, 68, 68, 0.2); }
        .product-card.card-gradient-border.purple-border:hover { box-shadow: 0 0 8px 1px rgba(168, 85, 247, 0.6), 0 0 16px 4px rgba(168, 85, 247, 0.4), 0 0 32px 8px rgba(168, 85, 247, 0.2); }
        .product-card.card-gradient-border.yellow-border:hover { box-shadow: 0 0 8px 1px rgba(234, 179, 8, 0.6), 0 0 16px 4px rgba(234, 179, 8, 0.4), 0 0 32px 8px rgba(234, 179, 8, 0.2); }
        .product-card.card-gradient-border.pink-border:hover { box-shadow: 0 0 8px 1px rgba(236, 72, 153, 0.6), 0 0 16px 4px rgba(236, 72, 153, 0.4), 0 0 32px 8px rgba(236, 72, 153, 0.2); }
        .product-card.card-gradient-border.teal-border:hover { box-shadow: 0 0 8px 1px rgba(20, 184, 166, 0.6), 0 0 16px 4px rgba(20, 184, 166, 0.4), 0 0 32px 8px rgba(20, 184, 166, 0.2); }
        /* Hover effect for Custom Border */
        .product-card.custom-border:hover { box-shadow: var(--custom-hover-shadow, 0 0 8px 1px rgba(255, 255, 255, 0.6), 0 0 16px 4px rgba(255, 255, 255, 0.4), 0 0 32px 8px rgba(255, 255, 255, 0.2)); }

        /* Product Thumbnail */
        .product-thumbnail { @apply w-full h-40 object-cover rounded-t-lg; }
        .product-thumbnail-placeholder { @apply w-full h-40 bg-slate-700 rounded-t-lg flex items-center justify-center text-gray-500; }

        /* --- Page Section & General Content Styles --- */
        #dashboard-content h2, #products-page-content h2, #tickets-page-content h2, #ticket-detail-content h2 { @apply text-3xl md:text-4xl font-bold text-white text-center mb-12; }
        #dashboard-content .dashboard-card, #tickets-page-content .ticket-card, #ticket-detail-content .ticket-card, .admin-section { @apply bg-slate-800/80 backdrop-blur-sm p-6 rounded-lg shadow-lg mb-6; }

        .paypal-button, .purchase-button {
            @apply bg-sky-600 hover:bg-sky-700 text-white text-sm font-medium py-2 px-4 rounded-md transition duration-300 flex items-center justify-center space-x-2 w-full disabled:opacity-50 disabled:cursor-not-allowed;
        }

        /* --- Message Popups --- */
        #payment-message, #ticket-message, #error-message, #config-message, #product-message {
            position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
            @apply text-white text-sm font-medium py-2 px-5 rounded-lg shadow-lg opacity-0 transition-opacity duration-500 ease-in-out z-50 pointer-events-none;
        }
        #payment-message.show, #ticket-message.show, #error-message.show, #config-message.show, #product-message.show { opacity: 1; }
        #payment-message, #ticket-message, #config-message, #product-message { @apply bg-green-600; }
        #error-message { @apply bg-red-600; }

        /* --- Loading Overlay --- */
        #loading-overlay { position: fixed; inset: 0; @apply bg-black/60 backdrop-blur-sm flex items-center justify-center z-50 transition-opacity duration-300 ease-in-out opacity-0 pointer-events-none; }
        #loading-overlay.active { @apply opacity-100 pointer-events-auto; }
        .loader { display: flex; align-items: center; justify-content: space-between; width: 50px; height: 25px; }
        .loader-bar { display: block; width: 8px; height: 100%; background-color: #f97316; border-radius: 4px; animation: scaleUpDown 1.2s infinite ease-in-out; }
        .loader-bar:nth-child(2) { animation-delay: 0.2s; } .loader-bar:nth-child(3) { animation-delay: 0.4s; }

        /* --- Page Section Visibility --- */
        .page-section { display: none; }
        .page-section.active { display: block; }

        /* --- Ticket Specific Styles --- */
        .ticket-list-item { @apply bg-slate-700/50 p-4 rounded-md mb-3 flex justify-between items-center cursor-pointer hover:bg-slate-600/50 transition-colors; }
        .status-open { @apply bg-green-500 text-green-900 text-xs font-bold px-2 py-0.5 rounded-full; }
        .status-closed { @apply bg-red-500 text-red-900 text-xs font-bold px-2 py-0.5 rounded-full; }
        #create-ticket-status { @apply text-sm mt-4 mb-4 text-center h-6; }
        #create-ticket-status.success { @apply text-green-400; } #create-ticket-status.error { @apply text-red-400; }
        #moderator-management-view h3 { @apply text-xl font-semibold text-white mb-4; }
        #moderator-management-view details summary { @apply cursor-pointer text-lg font-semibold text-white mb-3 hover:text-orange-400 transition-colors; }
        #moderator-management-view details[open] summary { @apply text-orange-400; }
        .ticket-list-container { @apply space-y-3 max-h-96 overflow-y-auto pr-2; }

        /* --- Chat Styles --- */
        #chat-messages { @apply h-64 md:h-80 overflow-y-auto mb-4 p-3 bg-slate-900/50 rounded-md border border-slate-700 space-y-2; }
        .chat-message { @apply text-sm break-words p-1 rounded hover:bg-slate-800/50 transition-colors; }
        .chat-message .username { @apply font-semibold text-orange-400 mr-2 cursor-pointer hover:underline; }
        .chat-message .timestamp { @apply text-xs text-gray-500 ml-2 whitespace-nowrap; }
        #chat-input-form { @apply flex space-x-2; }
        #chat-input { @apply flex-grow bg-slate-700 border border-slate-600 rounded-md py-2 px-3 text-white focus:outline-none focus:ring-2 focus:ring-orange-500 focus:border-transparent placeholder-gray-500; }
        #send-chat-button { @apply bg-orange-600 hover:bg-orange-700 text-white font-medium py-2 px-4 rounded-lg transition duration-300; }

        /* --- Modals (User Info, Product Edit) --- */
        .modal { @apply fixed inset-0 bg-black/70 backdrop-blur-sm flex items-center justify-center z-50 opacity-0 pointer-events-none transition-opacity duration-300; }
        .modal.active { @apply opacity-100 pointer-events-auto; }
        .modal-content { @apply bg-slate-800 p-6 rounded-lg shadow-xl max-w-md w-full text-white relative; }
        #product-edit-modal .modal-content { @apply max-w-lg; } /* Wider modal for product edit */
        .modal-close-button { @apply absolute top-3 right-3 text-gray-400 hover:text-white transition-colors; }
        #modal-user-roles { @apply flex flex-wrap gap-1 mt-3; }

        /* --- Custom Context Menu --- */
        #chat-context-menu, #ticket-context-menu { @apply absolute bg-slate-700 border border-slate-600 rounded-md shadow-lg py-1 text-sm text-white z-50 hidden; }
        .context-menu-item { @apply px-3 py-1.5 hover:bg-orange-600 cursor-pointer block w-full text-left; }
        .context-menu-item.hidden { display: none; }
        .context-menu-item.delete { @apply hover:bg-red-600 text-red-400 hover:text-white; }

        /* --- Mobile Menu --- */
        #mobile-menu { @apply absolute top-full left-0 right-0 bg-gray-800/95 backdrop-blur-sm p-4 space-y-2 border-t border-gray-700/50 md:hidden z-30 hidden; }
        .mobile-menu-link { @apply block text-gray-300 hover:text-white transition duration-200 py-1; }

        /* --- Admin Dashboard Styles --- */
        .admin-section h3 { @apply text-xl font-semibold text-white mb-4 border-b border-slate-700 pb-2; }
        .admin-form label { @apply block text-sm font-medium text-gray-300 mb-1; }
        /* General input style for admin form, EXCLUDING inputs inside .link-group */
        .admin-form > div > input[type="text"],
        .admin-form > div > input[type="number"],
        .admin-form > div > input[type="color"],
        .admin-form > div > textarea,
        .admin-form > div > select,
        .admin-form > .grid > div > input[type="text"], /* Target inputs within the grid */
        .admin-form > .grid > div > select { /* Target select within the grid */
             @apply w-full bg-slate-700 border border-slate-600 rounded-md py-2 px-3 text-white focus:outline-none focus:ring-2 focus:ring-orange-500 focus:border-transparent placeholder-gray-400 mb-4; /* Adjusted placeholder color */
        }
        /* Specific style for inputs inside .link-group (handled by JS now) */
        .admin-form .link-group { @apply flex items-center space-x-2 mb-2; }
        .admin-form .link-group button { @apply bg-red-600 hover:bg-red-700 text-white text-xs font-bold py-1 px-2 rounded flex-shrink-0; }

        .admin-form button[type="submit"] { @apply w-full bg-orange-600 hover:bg-orange-700 text-white font-medium py-2.5 px-6 rounded-lg transition duration-300 disabled:opacity-50; }

        /* Product Management Table */
        #product-list-table { @apply w-full text-sm text-left text-gray-400 mt-4; }
        #product-list-table thead { @apply text-xs text-gray-300 uppercase bg-slate-700/50; }
        #product-list-table th, #product-list-table td { @apply px-4 py-3; }
        #product-list-table tbody tr { @apply border-b border-slate-700 hover:bg-slate-700/50; }
        #product-list-table .actions button { @apply text-xs font-medium px-2 py-1 rounded mr-1 transition duration-200; }
        #product-list-table .actions .edit-btn { @apply bg-blue-600 hover:bg-blue-700 text-white; }
        #product-list-table .actions .clone-btn { @apply bg-cyan-600 hover:bg-cyan-700 text-white; } /* Clone button style */
        #product-list-table .actions .delete-btn { @apply bg-red-600 hover:bg-red-700 text-white; }
        #product-list-status { @apply text-sm text-gray-500 mt-4 text-center; }

        /* Site Config Icon Preview */
        #config-icon-preview { @apply w-8 h-8 ml-2 inline-block align-middle rounded border border-slate-600 bg-slate-700 object-contain; }

        /* Helper class for role spans */
        .role-span { @apply px-2 py-0.5 rounded-md text-xs font-medium mr-1 mb-1 inline-block; }

    </style>
</head>
<body class="min-h-screen flex flex-col">

    <div id="snow-container"></div>

    <div id="payment-message">Placeholder</div>
    <div id="ticket-message">Placeholder</div>
    <div id="error-message">Placeholder</div>
    <div id="config-message">Placeholder</div>
    <div id="product-message">Placeholder</div>

    <div id="loading-overlay">
        <div class="loader"><span class="loader-bar"></span><span class="loader-bar"></span><span class="loader-bar"></span></div>
    </div>

    <div id="user-info-modal" class="modal">
        <div class="modal-content">
            <button id="modal-close-button" class="modal-close-button">
                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path></svg>
            </button>
            <h3 class="text-lg font-semibold mb-3" id="modal-username">Username</h3>
            <p class="text-sm text-gray-400 mb-1">User ID: <span id="modal-user-id">N/A</span></p>
            <p class="text-sm font-medium mb-2">Roles:</p>
            <div id="modal-user-roles"><p class="text-gray-500 text-xs">Roles not available.</p></div>
        </div>
    </div>

    <div id="product-edit-modal" class="modal">
        <div class="modal-content max-w-lg"> {/* Adjusted max-width */}
            <button id="product-modal-close-button" class="modal-close-button">
                 <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path></svg>
            </button>
            <h3 class="text-lg font-semibold mb-4" id="product-modal-title">Add Product</h3>
            <form id="product-edit-form" class="admin-form space-y-4">
                <input type="hidden" id="product-edit-id">
                <div>
                    <label for="product-edit-name">Product Name</label>
                    <input type="text" id="product-edit-name" required>
                </div>
                 <div>
                    <label for="product-edit-thumbnail">Thumbnail URL (Optional)</label>
                    <input type="text" id="product-edit-thumbnail">
                </div>
                <div>
                    <label for="product-edit-price">Price ($)</label>
                    <input type="number" id="product-edit-price" step="0.01" required>
                </div>
                 <div>
                    <label for="product-edit-tag">Tag (e.g., ALL IN ONE, SOFTWARE)</label>
                    <input type="text" id="product-edit-tag">
                </div>
                 <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                         <label for="product-edit-tagColor">Tag Border Color</label>
                         <select id="product-edit-tagColor">
                            <option value="gray">Gray</option>
                            <option value="orange">Orange</option>
                            <option value="blue">Blue</option>
                            <option value="green">Green</option>
                            <option value="red">Red</option>
                            <option value="purple">Purple</option>
                            <option value="yellow">Yellow</option>
                            <option value="pink">Pink</option>
                            <option value="teal">Teal</option>
                            <option value="custom">Custom HEX</option>
                         </select>
                     </div>
                     <div id="custom-hex-input-container" class="hidden"> {/* Container for conditional visibility */}
                         <label for="product-edit-customHex">Custom HEX Color</label>
                         <input type="text" id="product-edit-customHex" placeholder="#RRGGBB">
                     </div>
                </div>
                <div>
                    <label for="product-edit-description">Description (Optional)</label>
                    <textarea id="product-edit-description" rows="3"></textarea>
                </div>
                 <div>
                    <label for="product-edit-features">Features (One per line)</label>
                    <textarea id="product-edit-features" rows="5"></textarea>
                </div>
                 <div>
                    <label for="product-edit-paymentLink">Payment Link/ID (e.g., PayPal button ID)</label>
                    <input type="text" id="product-edit-paymentLink">
                </div>
                <button type="submit" id="product-save-button">Save Product</button>
                <div id="product-edit-status" class="text-sm text-center h-5 mt-2"></div>
            </form>
        </div>
    </div>

    <div id="chat-context-menu">
        <button class="context-menu-item" id="context-delete-message">Delete Message</button>
        <button class="context-menu-item" id="context-user-info">User Info</button>
    </div>
    <div id="ticket-context-menu">
        <button class="context-menu-item" id="context-close-ticket">Close Ticket</button>
        <button class="context-menu-item" id="context-reopen-ticket">Reopen Ticket</button>
        <button class="context-menu-item delete" id="context-delete-ticket">Delete Ticket</button>
    </div>


    <header class="py-4 sticky top-0 z-40 bg-gray-900/80 backdrop-blur-md border-b border-gray-700/50">
        <div class="container mx-auto px-6 flex justify-between items-center">
            <div class="flex items-center space-x-2">
                <img id="header-site-icon" src="images/icon.png" alt="Site Icon" class="w-8 h-8" onerror="this.src='https://placehold.co/32x32/333/ccc?text=ICON'"> {/* Added ID */}
                <span class="text-2xl font-bold text-white hidden">Shillette</span>
                <span id="site-title-display" class="text-2xl font-bold text-white">Shillette</span>
            </div>
            <div class="flex items-center space-x-6">
                <nav id="main-navigation" class="hidden md:flex space-x-6">
                    </nav>
                <div id="user-area" class="flex items-center">
                    <a id="login-button" href="https://api.shillette.com/login" class="bg-orange-600 hover:bg-orange-700 text-white text-sm font-medium py-2 px-4 rounded-lg transition duration-300 flex items-center space-x-2">
                        <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M19.54 6.04a13.27 13.27 0 00-2.66-1.89 12.4 12.4 0 00-1.6-1.3c-.4-.3-.82-.53-1.28-.71-.18-.07-.37-.13-.56-.19a.82.82 0 00-.5-.06 11.85 11.85 0 00-5.88 0 .82.82 0 00-.5.06c-.19.06-.38.12-.56.19-.46.18-.88.4-1.28.7a12.34 12.34 0 00-1.6 1.3A13.23 13.23 0 004.46 6.04 14.31 14.31 0 003 11.7c0 .1 0 .19.02.28a13.8 13.8 0 001.44 4.61c.56 1.1 1.24 2.1 2.04 3 .5.56 1.04 1.07 1.63 1.53.17.13.34.25.52.37a.8.8 0 00.57.19.78.78 0 00.57-.19 11.07 11.07 0 005.56 0 .78.78 0 00.57.19.8.8 0 00.57-.19c.18-.12.35-.24.52-.37a12.06 12.06 0 003.67-4.53 13.85 13.85 0 001.44 4.61c0-.1 0-.19.02-.28a14.31 14.31 0 00-1.46-5.66zm-4.61 7.03a1.93 1.93 0 01-3.86 0 1.93 1.93 0 013.86 0zm-5.72 0a1.93 1.93 0 01-3.86 0 1.93 1.93 0 013.86 0z"></path></svg>
                        <span>Login with Discord</span>
                    </a>
                    <a href="/#dashboard" id="user-info" class="hidden items-center space-x-3 hover:bg-slate-700/50 p-1.5 rounded-lg transition duration-200 cursor-pointer">
                        <img id="user-avatar" src="https://placehold.co/32x32/7f8c8d/ecf0f1?text=?" alt="User Avatar" class="w-8 h-8 rounded-full border-2 border-slate-600" onerror="this.src='https://placehold.co/32x32/7f8c8d/ecf0f1?text=?'">
                        <span id="user-name" class="text-white text-sm font-medium">Username</span>
                        <button id="logout-button" class="text-gray-400 hover:text-white text-xs font-medium bg-slate-600 hover:bg-slate-500 px-2 py-1 rounded-md transition duration-200">Logout</button>
                    </a>
                </div>
            </div>
            <div class="md:hidden">
                <button id="mobile-menu-button" class="text-gray-300 hover:text-white focus:outline-none">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7"></path></svg>
                </button>
            </div>
        </div>
        <div id="mobile-menu" class="hidden">
            </div>
    </header>

    <main id="main-content" class="flex-grow page-section">
        <section class="relative text-center py-24 md:py-32 lg:py-40 overflow-hidden">
            <div class="container mx-auto px-6 relative z-10">
                <h1 class="text-4xl md:text-5xl lg:text-6xl font-extrabold text-white mb-4">Shillette</h1>
                <p class="text-xl md:text-2xl text-orange-400 mb-6 font-medium">Advanced DMA Firmware</p>
                <p class="max-w-2xl mx-auto text-gray-400 mb-10">
                    Fully undetected DMA firmware, battle-tested for reliable performance. Join thousands of satisfied users.
                </p>
                <div class="flex flex-col sm:flex-row justify-center items-center space-y-4 sm:space-y-0 sm:space-x-4 mb-16">
                    <a href="/#products" id="purchase-button" class="bg-orange-600 hover:bg-orange-700 text-white font-semibold py-3 px-8 rounded-lg transition duration-300 shadow-lg w-full sm:w-auto">
                        Purchase Product
                    </a>
                    <a href="https://discord.gg/shillette" target="_blank" rel="noopener noreferrer" class="bg-gray-700 hover:bg-gray-600 text-white font-semibold py-3 px-8 rounded-lg transition duration-300 shadow-lg w-full sm:w-auto flex items-center justify-center space-x-2">
                        <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M19.54 6.04a13.27 13.27 0 00-2.66-1.89 12.4 12.4 0 00-1.6-1.3c-.4-.3-.82-.53-1.28-.71-.18-.07-.37-.13-.56-.19a.82.82 0 00-.5-.06 11.85 11.85 0 00-5.88 0 .82.82 0 00-.5.06c-.19.06-.38.12-.56.19-.46.18-.88.4-1.28.7a12.34 12.34 0 00-1.6 1.3A13.23 13.23 0 004.46 6.04 14.31 14.31 0 003 11.7c0 .1 0 .19.02.28a13.8 13.8 0 001.44 4.61c.56 1.1 1.24 2.1 2.04 3 .5.56 1.04 1.07 1.63 1.53.17.13.34.25.52.37a.8.8 0 00.57.19.78.78 0 00.57-.19 11.07 11.07 0 005.56 0 .78.78 0 00.57.19.8.8 0 00.57-.19c.18-.12.35-.24.52-.37a12.06 12.06 0 003.67-4.53 13.85 13.85 0 001.44 4.61c0-.1 0-.19.02-.28a14.31 14.31 0 00-1.46-5.66zm-4.61 7.03a1.93 1.93 0 01-3.86 0 1.93 1.93 0 013.86 0zm-5.72 0a1.93 1.93 0 01-3.86 0 1.93 1.93 0 013.86 0z"></path></svg>
                        <span>Join Discord</span>
                    </a>
                </div>
                <div class="grid grid-cols-2 sm:grid-cols-4 gap-8 max-w-3xl mx-auto text-gray-400">
                    <div class="text-center"><div class="text-3xl font-bold text-white mb-1">1000+</div><div>Happy Users</div></div>
                    <div class="text-center"><div class="text-3xl font-bold text-white mb-1">1000+</div><div>Products Sold</div></div>
                    <div class="text-center"><div class="text-3xl font-bold text-white mb-1">5.0</div><div>Star Rating</div></div>
                    <div class="text-center"><div class="text-3xl font-bold text-white mb-1">3+</div><div>Years Experience</div></div>
                </div>
            </div>
        </section>
    </main>

    <div id="products-page-content" class="flex-grow container mx-auto px-6 py-10 page-section">
        <div class="flex justify-start mb-8">
             <a href="/#home" id="back-to-home-button-products" class="text-orange-400 hover:text-orange-300 flex items-center space-x-2 transition duration-200">
                 <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path></svg>
                 <span>Back to Home</span>
             </a>
        </div>
        <h2>Our Products</h2>
        <div id="product-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8 max-w-7xl mx-auto">
            <p id="product-loading-status" class="text-center text-gray-400 md:col-span-2 lg:col-span-3">Loading products...</p>
        </div>
    </div>

    <div id="dashboard-content" class="flex-grow container mx-auto px-6 py-10 page-section">
        <h2>Dashboard</h2>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
            <div class="dashboard-card md:col-span-1">
                <h3 class="text-lg font-semibold text-white mb-4">Welcome!</h3>
                <div class="flex items-center space-x-4 mb-4">
                     <img id="dashboard-user-avatar" src="https://placehold.co/64x64/7f8c8d/ecf0f1?text=?" alt="User Avatar" class="w-16 h-16 rounded-full border-2 border-orange-500" onerror="this.src='https://placehold.co/64x64/7f8c8d/ecf0f1?text=?'">
                     <div>
                         <p id="dashboard-user-name" class="text-xl font-semibold text-white">Username</p>
                         <p class="text-sm text-gray-400">Status: Active</p>
                     </div>
                </div>
                <button id="dashboard-logout-button" class="w-full bg-red-600 hover:bg-red-700 text-white text-sm font-medium py-2 px-4 rounded-lg transition duration-300">
                    Logout
                </button>
            </div>

            <div class="dashboard-card md:col-span-2">
                <h3 class="text-lg font-semibold text-white mb-4">My Products</h3>
                <p class="text-gray-400">Purchased product information will appear here (Feature not implemented).</p>
            </div>

            <div class="dashboard-card md:col-span-1">
                <h3 class="text-lg font-semibold text-white mb-4">My Roles</h3>
                <div id="dashboard-user-roles" class="space-y-2 flex flex-wrap gap-1">
                    <p class="text-gray-400 text-sm w-full">Loading roles...</p>
                </div>
            </div>

            <div class="dashboard-card md:col-span-2">
                 <h3 class="text-lg font-semibold text-white mb-4">Settings</h3>
                 <p class="text-gray-400">User settings will appear here (Feature not implemented).</p>
            </div>

            <div id="admin-dashboard-sections" class="hidden md:col-span-3 grid grid-cols-1 lg:grid-cols-2 gap-6">

                <div class="admin-section lg:col-span-1">
                    <h3>Site Configuration</h3>
                    <form id="site-config-form" class="admin-form">
                        <div>
                            <label for="config-site-title">Site Title</label>
                            <input type="text" id="config-site-title" required>
                        </div>
                        <div class="flex items-center">
                            <div class="flex-grow">
                                <label for="config-site-icon">Site Icon URL (Favicon)</label>
                                <input type="text" id="config-site-icon">
                            </div>
                            <img id="config-icon-preview" src="images/icon.png" alt="Icon Preview" onerror="this.src='https://placehold.co/32x32/333/ccc?text=ICON'">
                        </div>
                        <div>
                            <label>Header Links</label>
                            <div id="config-header-links-container" class="space-y-2 mb-2">
                                </div>
                            <button type="button" id="add-header-link-button" class="text-sm bg-blue-600 hover:bg-blue-700 text-white py-1 px-3 rounded">Add Link</button>
                        </div>
                        <button type="submit" id="save-config-button">Save Configuration</button>
                        <div id="config-save-status" class="text-sm text-center h-5 mt-2"></div>
                    </form>
                </div>

                <div class="admin-section lg:col-span-1">
                    <h3>Product Management</h3>
                    <button id="add-product-button" class="mb-4 bg-green-600 hover:bg-green-700 text-white font-medium py-2 px-4 rounded-lg transition duration-300">Add New Product</button>
                    <div class="overflow-x-auto">
                        <table id="product-list-table">
                            <thead>
                                <tr><th>Name</th><th>Price</th><th>Tag</th><th>Actions</th></tr>
                            </thead>
                            <tbody id="product-list-tbody">
                                </tbody>
                        </table>
                    </div>
                    <p id="product-list-status">Loading products...</p>
                </div>

            </div>
            </div> </div> <div id="tickets-page-content" class="flex-grow container mx-auto px-6 py-10 page-section">
         <div class="flex justify-start mb-8">
             <a href="/#home" id="back-to-home-button-tickets" class="text-orange-400 hover:text-orange-300 flex items-center space-x-2 transition duration-200">
                 <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path></svg>
                 <span>Back to Home</span>
             </a>
         </div>
         <h2>Support Tickets</h2>

         <div id="moderator-management-view" class="hidden mb-8 ticket-card">
             <h3 class="text-xl font-semibold text-white mb-4 border-b border-slate-700 pb-2">Ticket Management</h3>
             <details class="mb-6" open> <summary>Active Tickets</summary>
                 <div id="moderator-active-ticket-list" class="ticket-list-container mt-3"></div>
                 <p id="moderator-active-list-status" class="text-sm text-gray-500 mt-4">Loading active tickets...</p>
             </details>
             <details> <summary>Archived Tickets</summary>
                 <div id="moderator-archived-ticket-list" class="ticket-list-container mt-3"></div>
                 <p id="moderator-archived-list-status" class="text-sm text-gray-500 mt-4">Loading archived tickets...</p>
             </details>
         </div>

         <div id="user-ticket-view" class="mb-8 ticket-card">
             <h3 class="text-xl font-semibold text-white mb-4">My Tickets</h3>
             <div id="ticket-list" class="ticket-list-container"></div>
             <p id="ticket-list-status" class="text-sm text-gray-500 mt-4">Loading tickets...</p>
         </div>

         <div class="ticket-card">
             <h3 class="text-xl font-semibold text-white mb-4">Create New Ticket</h3>
             <form id="create-ticket-form" novalidate>
                 <div class="mb-4">
                     <label for="ticket-subject" class="block text-sm font-medium text-gray-300 mb-1">Subject</label>
                     <input type="text" id="ticket-subject" name="ticket-subject" required class="w-full bg-slate-700 border border-slate-600 rounded-md py-2 px-3 text-white focus:outline-none focus:ring-2 focus:ring-orange-500 focus:border-transparent placeholder-gray-500">
                 </div>
                 <div class="mb-4">
                     <label for="ticket-message-input" class="block text-sm font-medium text-gray-300 mb-1">Message</label>
                     <textarea id="ticket-message-input" name="ticket-message-input" rows="6" required class="w-full bg-slate-700 border border-slate-600 rounded-md py-2 px-3 text-white focus:outline-none focus:ring-2 focus:ring-orange-500 focus:border-transparent placeholder-gray-500"></textarea>
                 </div>
                 <div id="create-ticket-status" class="h-6"></div>
                 <button type="submit" id="create-ticket-button" class="w-full bg-orange-600 hover:bg-orange-700 text-white font-medium py-2.5 px-6 rounded-lg transition duration-300">Submit Ticket</button>
             </form>
         </div>
     </div>

     <div id="ticket-detail-content" class="flex-grow container mx-auto px-6 py-10 page-section">
         <div class="flex justify-start mb-8">
             <a href="/#tickets" id="back-to-tickets-button" class="text-orange-400 hover:text-orange-300 flex items-center space-x-2 transition duration-200">
                 <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path></svg>
                 <span>Back to Tickets</span>
             </a>
         </div>
         <h2 id="ticket-detail-subject">Ticket Subject</h2>
         <div class="ticket-card">
             <div id="chat-messages"><p class="text-gray-500 text-center py-4">Loading chat...</p></div>
             <form id="chat-input-form" class="mt-4" novalidate>
                 <input type="text" id="chat-input" placeholder="Type your message..." required class="w-full">
                 <button type="submit" id="send-chat-button">Send</button>
             </form>
         </div>
     </div>


    <footer class="bg-black mt-auto py-6 border-t border-gray-800">
        <div class="container mx-auto px-6 text-center text-gray-500 text-sm">
            <p>&copy; <span id="footer-year">2025</span> Shillette. All rights reserved.</p>
        </div>
    </footer>

    <script>
        // --- DOM Element References ---
        const pageSections = {
            '#home': 'main-content',
            '#products': 'products-page-content',
            '#tickets': 'tickets-page-content',
            '#dashboard': 'dashboard-content',
            '#ticketDetail': 'ticket-detail-content'
        };
        const siteTitleDisplay = document.getElementById('site-title-display');
        const headerSiteIcon = document.getElementById('header-site-icon'); // Header icon
        const faviconLink = document.getElementById('favicon'); // Favicon link tag
        const mainNavigation = document.getElementById('main-navigation');
        const mobileMenuNav = document.getElementById('mobile-menu');
        const loginButton = document.getElementById('login-button');
        const logoutButton = document.getElementById('logout-button');
        const dashboardLogoutButton = document.getElementById('dashboard-logout-button');
        const userInfo = document.getElementById('user-info');
        const userNameDisplay = document.getElementById('user-name');
        const userAvatarDisplay = document.getElementById('user-avatar');
        const dashboardUserNameDisplay = document.getElementById('dashboard-user-name');
        const dashboardUserAvatarDisplay = document.getElementById('dashboard-user-avatar');
        const dashboardUserRolesContainer = document.getElementById('dashboard-user-roles');
        const snowContainer = document.getElementById('snow-container');
        const paymentMessage = document.getElementById('payment-message');
        const ticketMessagePopup = document.getElementById('ticket-message');
        const errorMessagePopup = document.getElementById('error-message');
        const configMessagePopup = document.getElementById('config-message');
        const productMessagePopup = document.getElementById('product-message');
        const loadingOverlay = document.getElementById('loading-overlay');
        const createTicketForm = document.getElementById('create-ticket-form');
        const ticketSubjectInput = document.getElementById('ticket-subject');
        const ticketMessageInput = document.getElementById('ticket-message-input');
        const createTicketStatus = document.getElementById('create-ticket-status');
        const userTicketView = document.getElementById('user-ticket-view');
        const moderatorManagementView = document.getElementById('moderator-management-view');
        const ticketListDiv = document.getElementById('ticket-list');
        const ticketListStatus = document.getElementById('ticket-list-status');
        const moderatorActiveTicketListDiv = document.getElementById('moderator-active-ticket-list');
        const moderatorActiveListStatus = document.getElementById('moderator-active-list-status');
        const moderatorArchivedTicketListDiv = document.getElementById('moderator-archived-ticket-list');
        const moderatorArchivedListStatus = document.getElementById('moderator-archived-list-status');
        const ticketDetailSubject = document.getElementById('ticket-detail-subject');
        const chatMessagesDiv = document.getElementById('chat-messages');
        const chatInputForm = document.getElementById('chat-input-form');
        const chatInput = document.getElementById('chat-input');
        const sendChatButton = document.getElementById('send-chat-button');
        const backToTicketsButton = document.getElementById('back-to-tickets-button');
        const userInfoModal = document.getElementById('user-info-modal');
        const modalCloseButton = document.getElementById('modal-close-button');
        const modalUsername = document.getElementById('modal-username');
        const modalUserId = document.getElementById('modal-user-id');
        const modalUserRoles = document.getElementById('modal-user-roles');
        const chatContextMenu = document.getElementById('chat-context-menu');
        const contextDeleteButton = document.getElementById('context-delete-message');
        const contextUserInfoButton = document.getElementById('context-user-info');
        const ticketContextMenu = document.getElementById('ticket-context-menu');
        const contextCloseTicketButton = document.getElementById('context-close-ticket');
        const contextReopenTicketButton = document.getElementById('context-reopen-ticket');
        const contextDeleteTicketButton = document.getElementById('context-delete-ticket');
        const mobileMenuButton = document.getElementById('mobile-menu-button');
        const productGrid = document.getElementById('product-grid');
        const productLoadingStatus = document.getElementById('product-loading-status');
        const adminDashboardSections = document.getElementById('admin-dashboard-sections');
        const siteConfigForm = document.getElementById('site-config-form');
        const configSiteTitleInput = document.getElementById('config-site-title');
        const configSiteIconInput = document.getElementById('config-site-icon'); // Icon URL input
        const configIconPreview = document.getElementById('config-icon-preview'); // Icon preview img
        const configHeaderLinksContainer = document.getElementById('config-header-links-container');
        const addHeaderLinkButton = document.getElementById('add-header-link-button');
        const saveConfigButton = document.getElementById('save-config-button');
        const configSaveStatus = document.getElementById('config-save-status');
        const addProductButton = document.getElementById('add-product-button');
        const productListTableBody = document.getElementById('product-list-tbody');
        const productListStatus = document.getElementById('product-list-status');
        const productEditModal = document.getElementById('product-edit-modal');
        const productModalCloseButton = document.getElementById('product-modal-close-button');
        const productModalTitle = document.getElementById('product-modal-title');
        const productEditForm = document.getElementById('product-edit-form');
        const productEditIdInput = document.getElementById('product-edit-id');
        const productEditNameInput = document.getElementById('product-edit-name');
        const productEditThumbnailInput = document.getElementById('product-edit-thumbnail');
        const productEditPriceInput = document.getElementById('product-edit-price');
        const productEditTagInput = document.getElementById('product-edit-tag');
        const productEditTagColorSelect = document.getElementById('product-edit-tagColor');
        const productEditCustomHexInput = document.getElementById('product-edit-customHex');
        const customHexInputContainer = document.getElementById('custom-hex-input-container'); // Get the container
        const productEditDescriptionInput = document.getElementById('product-edit-description');
        const productEditFeaturesInput = document.getElementById('product-edit-features');
        const productEditPaymentLinkInput = document.getElementById('product-edit-paymentLink');
        const productSaveButton = document.getElementById('product-save-button');
        const productEditStatus = document.getElementById('product-edit-status');
        const footerYear = document.getElementById('footer-year');


        // --- Configuration ---
        const API_BASE_URL = 'https://api.shillette.com';
        const SOCKET_URL = 'https://api.shillette.com';
        const DEFAULT_ICON_URL = 'images/icon.png'; // Default icon path
        const ICON_PLACEHOLDER_URL = 'https://placehold.co/32x32/333/ccc?text=ICON'; // Placeholder

        // --- State Variables ---
        let currentUser = null;
        let siteConfig = null;
        let socket = null;
        let currentTicketId = null;
        let activeSectionId = null;
        let currentContextMenu = null;
        let contextMenuData = { ticketId: null, messageTimestamp: null, senderId: null, ticketStatus: null };
        let isInitialLoginCheckComplete = false;
        let isInitialConfigLoadComplete = false;


        // --- Utility Functions ---

        /** Shows a temporary pop-up message. */
        function showPopupMessage(element, message, isError = false, duration = 3500) {
             if (!element) return;
             element.textContent = message;
             element.classList.toggle('bg-red-600', isError);
             element.classList.toggle('bg-green-600', !isError);
             element.classList.add('show');
             setTimeout(() => element.classList.remove('show'), duration);
        }

        /** Updates header UI based on login status and toggles admin sections. */
        function updateHeaderUI(user) {
             const isLoggedIn = user && user.logged_in;
             loginButton.classList.toggle('hidden', isLoggedIn);
             userInfo.classList.toggle('hidden', !isLoggedIn);
             userInfo.classList.toggle('flex', isLoggedIn);

             if (isLoggedIn) {
                 userNameDisplay.textContent = user.username || 'User';
                 userAvatarDisplay.src = user.user_id && user.avatar ? `https://cdn.discordapp.com/avatars/${user.user_id}/${user.avatar}.png?size=32` : 'https://placehold.co/32x32/7f8c8d/ecf0f1?text=?';
                 dashboardUserNameDisplay.textContent = user.username || 'User';
                 dashboardUserAvatarDisplay.src = user.user_id && user.avatar ? `https://cdn.discordapp.com/avatars/${user.user_id}/${user.avatar}.png?size=64` : 'https://placehold.co/64x64/7f8c8d/ecf0f1?text=?';

                 const isMod = user.is_moderator === true;
                 console.log(`[updateHeaderUI] Toggling admin sections. Moderator status: ${isMod} (Raw value: ${user.is_moderator})`);
                 adminDashboardSections?.classList.toggle('hidden', !isMod);

             } else {
                 dashboardUserNameDisplay.textContent = 'User';
                 dashboardUserAvatarDisplay.src = 'https://placehold.co/64x64/7f8c8d/ecf0f1?text=?';
                 adminDashboardSections?.classList.add('hidden');
             }
        }

        /** Hides all page sections and shows the specified one by its element ID. */
        function showSection(sectionElementId) {
            console.log(`[showSection] Attempting to show element ID: ${sectionElementId}`);
            hideContextMenu();

            let foundSection = false;
            Object.values(pageSections).forEach(id => {
                const sectionElement = document.getElementById(id);
                if (sectionElement) {
                    sectionElement.classList.remove('active');
                    sectionElement.classList.add('hidden');
                } else {
                    console.warn(`[showSection] Element not found for ID: ${id}`);
                }
            });

            const targetElement = document.getElementById(sectionElementId);
            if (targetElement) {
                targetElement.classList.remove('hidden');
                targetElement.classList.add('active');
                activeSectionId = sectionElementId;
                foundSection = true;
                console.log(`[showSection] Successfully shown: ${sectionElementId}`);
            }

            if (!foundSection) {
                console.warn(`[showSection] Target element ID not found: ${sectionElementId}. Defaulting to home.`);
                const homeElement = document.getElementById(pageSections['#home']);
                if (homeElement) {
                    homeElement.classList.remove('hidden');
                    homeElement.classList.add('active');
                    activeSectionId = pageSections['#home'];
                    console.log(`[showSection] Defaulted to ${activeSectionId}.`);
                } else {
                     activeSectionId = null;
                     console.error("[showSection] Could not find home element either!");
                }
            }

            const isTicketRelated = sectionElementId === pageSections['#ticketDetail'] || sectionElementId === pageSections['#tickets'];
            if (!isTicketRelated) {
                 console.log(`[showSection] Navigating away from tickets/detail, disconnecting socket.`);
                 disconnectSocket();
             }
            if (sectionElementId !== pageSections['#ticketDetail']) {
                 currentTicketId = null;
            }
        }

        /** Handles navigation based on URL hash changes. */
        function navigateTo(hash) {
            console.log(`[navigateTo] Received hash: ${hash}`);
            const baseHash = hash.split('?')[0] || '#home';
            const targetElementId = pageSections[baseHash] || pageSections['#home'];

            console.log(`[navigateTo] Base hash: ${baseHash}, Target element ID: ${targetElementId}`);

            const isProtected = ['#dashboard', '#tickets', '#ticketDetail'].includes(baseHash);

            if (isProtected && (!isInitialLoginCheckComplete || !isInitialConfigLoadComplete)) {
                console.log(`[navigateTo] Initial checks not complete for protected route ${baseHash}. Deferring action.`);
                return;
            }

            console.log(`[navigateTo] Checking protection. Is protected: ${isProtected}, User logged in: ${currentUser?.logged_in}`);
            if (isProtected && (!currentUser || !currentUser.logged_in)) {
                console.log(`[navigateTo] Access denied to protected route: ${baseHash}`);
                showPopupMessage(errorMessagePopup, "Please log in to view this page.", true);
                if (window.location.hash !== '#home' && window.location.hash !== '/#home') {
                    console.log(`[navigateTo] Redirecting to /#home`);
                    window.location.hash = '/#home';
                } else {
                    console.log(`[navigateTo] Already on home, ensuring #home section is shown.`);
                    if(activeSectionId !== pageSections['#home']) showSection(pageSections['#home']);
                }
                return;
            }

            if (['#tickets', '#ticketDetail'].includes(baseHash)) {
                console.log(`[navigateTo] Ensuring socket is connected for route: ${baseHash}`);
                ensureSocketConnected();
            }

            if (baseHash === '#ticketDetail') {
                let id = null;
                const params = new URLSearchParams(hash.split('?')[1] || '');
                id = params.get('id');
                console.log(`[navigateTo] Ticket Detail - ID from URL: ${id}`);
                if (id) {
                    if (currentTicketId !== id) {
                        currentTicketId = id;
                        ticketDetailSubject.textContent = `Ticket #${id.slice(-6)}`;
                        chatMessagesDiv.innerHTML = '<p class="text-gray-500 text-center py-4">Connecting to chat...</p>';
                        fetchTicketDetails(id);
                    } else {
                         console.log(`[navigateTo] Already viewing ticket ${id}, not re-fetching details.`);
                         if (socket && socket.connected) socket.emit('join_ticket_room', { ticket_id: currentTicketId });
                    }
                } else {
                    console.warn("[navigateTo] Ticket ID missing for detail view. Redirecting to tickets list.");
                    showPopupMessage(errorMessagePopup, "Invalid ticket link.", true);
                    window.location.hash = '/#tickets';
                    return;
                }
            }

            // Show the correct section
            showSection(targetElementId);

            // Fetch data if needed for the newly shown section
            if (baseHash === '#tickets') {
                console.log(`[navigateTo] Fetching tickets for #tickets view.`);
                fetchTickets();
            } else if (baseHash === '#products') {
                 console.log(`[navigateTo] Fetching products for #products view.`);
                 fetchProducts();
            } else if (baseHash === '#dashboard' && currentUser?.logged_in) {
                 console.log(`[navigateTo] Loading dashboard data. User:`, currentUser);
                 displayUserRoles(currentUser.roles);
                 if (currentUser.is_moderator === true) {
                     console.log(`[navigateTo] User is moderator, loading admin data.`);
                     loadAdminDashboardData();
                 } else {
                     console.log(`[navigateTo] User is NOT moderator, skipping admin data load.`);
                 }
            }

            // Update header UI (which also handles admin section visibility)
            updateHeaderUI(currentUser);
        }

        /** Runs navigation logic based on current URL hash. */
        function runNavigation() {
            console.log(`[runNavigation] Processing raw hash: ${window.location.hash}`);
            const rawHash = window.location.hash;
            let pathPart = '';
            const firstHashIndex = rawHash.indexOf('#');
            if (firstHashIndex !== -1) {
                pathPart = rawHash.substring(firstHashIndex + 1);
                while (pathPart.startsWith('/') || pathPart.startsWith('#')) {
                    pathPart = pathPart.substring(1);
                }
            }
            const hashToNavigate = `#${pathPart || 'home'}`;
            console.log(`[runNavigation] Cleaned hash to navigate: ${hashToNavigate}`);

            if ((isInitialLoginCheckComplete && isInitialConfigLoadComplete) || hashToNavigate === '#home') {
                navigateTo(hashToNavigate);
            } else {
                console.log(`[runNavigation] Initial checks not complete for target ${hashToNavigate}. Deferring.`);
            }
        }

        /** Creates snowflake effect. */
        function createSnowflakes() {
            const numberOfSnowflakes = 75;
            if (!snowContainer) return;
            snowContainer.innerHTML = '';
            for (let i = 0; i < numberOfSnowflakes; i++) {
                const snowflake = document.createElement('div');
                snowflake.classList.add('snowflake');
                const size = Math.random() * 3 + 2;
                const duration = Math.random() * 10 + 5;
                const delay = Math.random() * 10;
                const startLeft = Math.random() * 100;
                const opacity = Math.random() * 0.5 + 0.5;

                snowflake.style.width = `${size}px`;
                snowflake.style.height = `${size}px`;
                snowflake.style.left = `${startLeft}vw`;
                snowflake.style.opacity = opacity;
                snowflake.style.animationDuration = `${duration}s`;
                snowflake.style.animationDelay = `-${delay}s`;

                snowContainer.appendChild(snowflake);
            }
        }

        /** Checks login status via API, then triggers config load. */
        async function checkLoginStatus() {
             isInitialLoginCheckComplete = false;
             try {
                 const response = await fetch(`${API_BASE_URL}/api/user`, { credentials: 'include' });
                 if (!response.ok && (response.status === 401 || response.status === 403)) {
                     currentUser = { logged_in: false };
                 } else if (!response.ok) {
                     throw new Error(`HTTP error! status: ${response.status}`);
                 } else {
                     currentUser = await response.json();
                 }
                 console.log("[checkLoginStatus] User status checked:", currentUser);
                 if (currentUser && currentUser.logged_in) {
                     ensureSocketConnected();
                 }
             } catch (error) {
                 console.error("[checkLoginStatus] Error checking login status:", error);
                 currentUser = { logged_in: false };
                 showPopupMessage(errorMessagePopup, "Could not verify login status.", true);
             } finally {
                 isInitialLoginCheckComplete = true;
                 console.log("[checkLoginStatus] Initial login check complete.");
                 loadSiteConfigAndNavigate();
             }
        }

        /** Fetches site config and applies it, then runs navigation. */
        async function loadSiteConfigAndNavigate() {
            isInitialConfigLoadComplete = false;
            try {
                const response = await fetch(`${API_BASE_URL}/api/config`);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                siteConfig = await response.json();
                console.log("[loadSiteConfig] Site config loaded:", siteConfig);
                applySiteConfig(siteConfig);
            } catch (error) {
                console.error("[loadSiteConfig] Error loading site config:", error);
                showPopupMessage(errorMessagePopup, "Failed to load site configuration. Using defaults.", true);
                applySiteConfig(null); // Apply defaults if fetch fails
            } finally {
                isInitialConfigLoadComplete = true;
                console.log("[loadSiteConfig] Initial config load complete.");
                runNavigation(); // Run navigation after config is loaded or defaults applied
            }
        }

        /** Applies fetched or default site configuration to the UI. */
        function applySiteConfig(config) {
            const effectiveConfig = config || {}; // Use empty object if config is null/undefined
            const title = effectiveConfig.siteTitle || "Shillette";
            const iconUrl = effectiveConfig.siteIconUrl || DEFAULT_ICON_URL;
            const links = effectiveConfig.headerLinks || [
                {name: "Home", href: "/#home"}, {name: "Products", href: "/#products"},
                {name: "Tickets", href: "/#tickets"}, {name: "Discord", href: "https://discord.gg/shillette", target: "_blank"}
            ];

            // Update Page Title
            document.title = title;
            if (siteTitleDisplay) siteTitleDisplay.textContent = title;

            // Update Header Icon
            if (headerSiteIcon) headerSiteIcon.src = iconUrl;

            // Update Favicon
            if (faviconLink) faviconLink.href = iconUrl;

            // Update Navigation Links
            if (mainNavigation) mainNavigation.innerHTML = '';
            if (mobileMenuNav) mobileMenuNav.innerHTML = '';
            links.forEach(link => {
                // Main Navigation
                const a = document.createElement('a');
                a.href = link.href;
                a.textContent = link.name;
                a.classList.add('text-gray-300', 'hover:text-white', 'transition', 'duration-200');
                if (link.target) a.target = link.target;
                if (link.target === '_blank') a.rel = 'noopener noreferrer';
                if (mainNavigation) mainNavigation.appendChild(a);

                // Mobile Navigation
                const mob_a = a.cloneNode(true);
                mob_a.classList.remove('text-gray-300', 'hover:text-white');
                mob_a.classList.add('mobile-menu-link');
                mob_a.addEventListener('click', () => mobileMenuNav?.classList.add('hidden')); // Close menu on click
                if (mobileMenuNav) mobileMenuNav.appendChild(mob_a);
            });

            // Update Footer Year
            if (footerYear) footerYear.textContent = new Date().getFullYear();
        }


        /** Fetches and displays products on the products page. */
        async function fetchProducts() {
             if (!productGrid || !productLoadingStatus) return;
             productGrid.innerHTML = '';
             productLoadingStatus.textContent = 'Loading products...';
             productLoadingStatus.classList.remove('hidden');

             try {
                 const response = await fetch(`${API_BASE_URL}/api/products`);
                 if (!response.ok) throw new Error(`HTTP ${response.status}`);
                 const products = await response.json();

                 productLoadingStatus.classList.add('hidden');

                 if (!products || products.length === 0) {
                     productGrid.innerHTML = `<p class="text-center text-gray-400 md:col-span-2 lg:col-span-3">No products available at this time.</p>`;
                     return;
                 }

                 products.forEach(renderProductCard);

             } catch (error) {
                 console.error("Error fetching products:", error);
                 productLoadingStatus.textContent = 'Failed to load products.';
                 // Display the specific error message from the catch block
                 showPopupMessage(errorMessagePopup, `Error loading products: ${error.message}`, true);
             }
        }

        /** Renders a single product card and appends it to the grid. */
        function renderProductCard(product) {
             if (!productGrid) return;

             const card = document.createElement('div');
             card.className = `product-card flex flex-col`; // Base classes

             const tagColor = product.tagColor || 'gray';
             const customHex = product.customBorderHex;
             let borderClasses = '';
             let inlineStyle = '';
             let hoverStyleVar = '';

             // Determine border style
             if (customHex && /^#[0-9A-F]{6}$/i.test(customHex)) {
                 // Valid Custom HEX
                 borderClasses = 'custom-border';
                 inlineStyle = `border-color: ${customHex};`;
                 hoverStyleVar = `--custom-hover-shadow: 0 0 8px 1px ${customHex}99, 0 0 16px 4px ${customHex}66, 0 0 32px 8px ${customHex}33;`;
                 card.style.cssText = inlineStyle + hoverStyleVar;
                 card.classList.add(borderClasses);
             } else if (tagColor !== 'custom') {
                 // Predefined Gradient Color
                 borderClasses = `card-gradient-border ${tagColor}-border`;
                 card.classList.add(...borderClasses.split(' '));
             } else {
                  // Fallback (e.g., 'custom' selected but no valid HEX)
                  borderClasses = `card-gradient-border gray-border`;
                  card.classList.add(...borderClasses.split(' '));
             }

             // Determine tag text/bg color
             const displayTagColor = (tagColor === 'custom' && !customHex) ? 'gray' : tagColor;
             const tagBgClass = `bg-${displayTagColor}-500/20`;
             const tagTextClass = `text-${displayTagColor}-300`;

             // --- Thumbnail Element Creation ---
             let thumbnailElement = null;
             const placeholderDiv = document.createElement('div');
             placeholderDiv.className = 'product-thumbnail-placeholder';
             placeholderDiv.style.display = 'none'; // Hide initially
             placeholderDiv.innerHTML = '<span>Image not found</span>';

             if (product.thumbnailUrl && product.thumbnailUrl.trim() !== '') {
                 thumbnailElement = document.createElement('img');
                 thumbnailElement.src = product.thumbnailUrl;
                 thumbnailElement.alt = `${product.name || 'Product'} thumbnail`;
                 thumbnailElement.className = 'product-thumbnail';
                 // Add onerror handler to show the placeholder
                 thumbnailElement.onerror = () => {
                     if (thumbnailElement) thumbnailElement.style.display = 'none'; // Hide broken image
                     placeholderDiv.style.display = 'flex'; // Show placeholder
                 };
             } else {
                 // No URL provided, use placeholder directly
                 placeholderDiv.style.display = 'flex'; // Show placeholder
                 thumbnailElement = null; // No img element needed
             }

             // --- Inner Content Div ---
             const innerDiv = document.createElement('div');
             innerDiv.className = 'product-card-inner';
             innerDiv.innerHTML = `
                 <div class="flex justify-between items-center mb-4">
                     <span class="${tagBgClass} ${tagTextClass} text-xs font-semibold px-2.5 py-0.5 rounded">${product.tag || 'PRODUCT'}</span>
                 </div>
                 <h3 class="text-xl font-semibold text-white mb-2">${product.name || 'Unnamed Product'}</h3>
                 <p class="text-3xl font-bold text-white mb-4">$${product.price?.toFixed(2) || 'N/A'}</p>
                 <ul class="text-sm text-gray-400 space-y-2 mb-6 flex-grow">
                     ${(product.features || []).map(feature => `<li class="flex items-center"><svg class="w-4 h-4 mr-2 text-green-500" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path></svg> ${feature}</li>`).join('')}
                     ${!(product.features && product.features.length > 0) ? '<li class="text-gray-500">No features listed.</li>' : ''}
                 </ul>
                 <div class="mt-auto space-y-3 pt-4 border-t border-slate-700/50">
                     ${product.paymentLink ? `<button class="purchase-button" data-product-id="${product._id}" data-payment-link="${product.paymentLink}">Pay with PayPal</button>` : '<button class="purchase-button" disabled>Purchase Unavailable</button>'}
                 </div>
             `;

             // --- Assemble the Card ---
             // Append the actual image element if it exists
             if (thumbnailElement) {
                 card.appendChild(thumbnailElement);
             }
             // Always append the placeholder (it's hidden by default or if the image loads)
             card.appendChild(placeholderDiv);
             // Append the inner content
             card.appendChild(innerDiv);

             // Add event listener to purchase button
             const purchaseBtn = card.querySelector('.purchase-button');
             if (purchaseBtn && !purchaseBtn.disabled) {
                 purchaseBtn.addEventListener('click', handlePurchaseClick);
             }

             // Append the fully assembled card to the grid
             productGrid.appendChild(card);
        }


        /** Placeholder for handling purchase clicks */
        function handlePurchaseClick(event) {
            const button = event.target;
            const productId = button.dataset.productId;
            const paymentLink = button.dataset.paymentLink;
            console.log(`Purchase clicked for product ID: ${productId}, Link/ID: ${paymentLink}`);
            if (paymentLink) {
                 showPopupMessage(paymentMessage, `Initiating purchase for product ${productId}... (Integration needed)`);
                 // Potentially redirect or open PayPal link here
            } else {
                 showPopupMessage(errorMessagePopup, 'Payment link is missing for this product.', true);
            }
        }


        /** Fetches the list of tickets (user's or all). */
        async function fetchTickets() {
            console.log("[fetchTickets] Starting...");
            if (!userTicketView || !moderatorManagementView || !ticketListDiv || !ticketListStatus || !moderatorActiveTicketListDiv || !moderatorActiveListStatus || !moderatorArchivedTicketListDiv || !moderatorArchivedListStatus) {
                console.error("[fetchTickets] One or more ticket list elements not found."); return;
            }
            if (!currentUser || !currentUser.logged_in) {
                console.log("[fetchTickets] User not logged in.");
                ticketListStatus.textContent = "Please log in to view tickets.";
                moderatorActiveListStatus.textContent = "Please log in to view tickets.";
                moderatorArchivedListStatus.textContent = "Please log in to view tickets.";
                ticketListDiv.innerHTML = ''; moderatorActiveTicketListDiv.innerHTML = ''; moderatorArchivedTicketListDiv.innerHTML = '';
                userTicketView.classList.remove('hidden'); moderatorManagementView.classList.add('hidden'); return;
            }

            ticketListStatus.textContent = "Loading tickets...";
            moderatorActiveListStatus.textContent = "Loading active tickets...";
            moderatorArchivedListStatus.textContent = "Loading archived tickets...";
            ticketListDiv.innerHTML = ''; moderatorActiveTicketListDiv.innerHTML = ''; moderatorArchivedTicketListDiv.innerHTML = '';

            const isMod = currentUser.is_moderator === true;
            console.log(`[fetchTickets] Is moderator: ${isMod}`);
            userTicketView.classList.toggle('hidden', isMod);
            moderatorManagementView.classList.toggle('hidden', !isMod);

            try {
                const response = await fetch(`${API_BASE_URL}/api/tickets`, { credentials: 'include' });
                if (!response.ok) {
                     if (response.status === 401 || response.status === 403) throw new Error("Authentication required.");
                     else throw new Error(`HTTP error! status: ${response.status}`);
                }
                const tickets = await response.json();
                console.log(`[fetchTickets] Received ${tickets.length} tickets.`);

                ticketListStatus.textContent = ""; moderatorActiveListStatus.textContent = ""; moderatorArchivedListStatus.textContent = "";
                let hasActive = false; let hasArchived = false;

                if (tickets.length === 0) {
                    if (isMod) {
                        moderatorActiveListStatus.textContent = "No active tickets found.";
                        moderatorArchivedListStatus.textContent = "No archived tickets found.";
                    } else {
                        ticketListStatus.textContent = "You have no support tickets.";
                    }
                } else {
                    // tickets are pre-sorted by backend now
                    tickets.forEach(ticket => {
                        const item = document.createElement('div');
                        item.classList.add('ticket-list-item');
                        item.dataset.ticketId = ticket._id;
                        item.dataset.ticketStatus = ticket.status;
                        item.dataset.ticketSubject = ticket.subject || 'No Subject';

                        const statusClass = ticket.status === 'open' ? 'status-open' : 'status-closed';
                        const statusText = ticket.status ? ticket.status.charAt(0).toUpperCase() + ticket.status.slice(1) : 'N/A';
                        const dateOpened = ticket.created_at ? new Date(ticket.created_at).toLocaleDateString() : 'N/A';
                        const shortId = ticket._id ? ticket._id.slice(-6) : 'N/A';
                        const subject = ticket.subject || 'No Subject';
                        const username = ticket.username || 'Unknown User';

                        item.innerHTML = `
                            <div>
                                <p class="font-medium text-white">#${shortId}: ${subject}</p>
                                <p class="text-xs text-gray-400">User: ${username} | Opened: ${dateOpened}</p>
                            </div>
                            <span class="${statusClass}">${statusText}</span>`;

                        item.addEventListener('click', (e) => {
                            e.preventDefault();
                            const targetHash = `/#ticketDetail?id=${ticket._id}`;
                            console.log(`[fetchTickets] Ticket item clicked: ID=${ticket._id}. Setting hash to: ${targetHash}`);
                            window.location.hash = targetHash;
                        });
                        item.addEventListener('contextmenu', showTicketContextMenu);

                        if (isMod) {
                            if (ticket.status === 'open') { moderatorActiveTicketListDiv.appendChild(item); hasActive = true; }
                            else { moderatorArchivedTicketListDiv.appendChild(item); hasArchived = true; }
                        } else {
                            ticketListDiv.appendChild(item);
                        }
                    });
                    if (isMod) {
                        if (!hasActive) moderatorActiveListStatus.textContent = "No active tickets found.";
                        if (!hasArchived) moderatorArchivedListStatus.textContent = "No archived tickets found.";
                    }
                }
            } catch (error) {
                console.error("[fetchTickets] Error fetching tickets:", error);
                const errorMsg = `Failed to load tickets: ${error.message}`;
                ticketListStatus.textContent = errorMsg; moderatorActiveListStatus.textContent = errorMsg; moderatorArchivedListStatus.textContent = errorMsg;
                showPopupMessage(errorMessagePopup, `Error fetching tickets: ${error.message}`, true);
            }
        }
        /** Fetches details for a specific ticket. */
        async function fetchTicketDetails(ticketId) {
            console.log(`[fetchTicketDetails] Fetching details for ticket: ${ticketId}`);
            if (!currentUser || !currentUser.logged_in) return;
            ensureSocketConnected();
            chatMessagesDiv.innerHTML = '<p class="text-gray-500 text-center py-4">Loading messages...</p>';
            if (backToTicketsButton) backToTicketsButton.href = '/#tickets'; // Ensure back button works

            try {
                const response = await fetch(`${API_BASE_URL}/api/tickets/${ticketId}`, { credentials: 'include' });
                if (!response.ok) {
                    if (response.status === 401 || response.status === 403) throw new Error("Forbidden or Not Authenticated.");
                    if (response.status === 404) throw new Error("Ticket not found.");
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const ticket = await response.json(); // Data is already serialized by backend helper
                console.log(`[fetchTicketDetails] Received details for ticket: ${ticketId}`);

                ticketDetailSubject.textContent = ticket.subject || `Ticket #${ticketId.slice(-6)}`;
                chatMessagesDiv.innerHTML = '';

                if (ticket.messages && ticket.messages.length > 0) {
                    // Messages should be pre-sorted by backend now
                    ticket.messages.forEach(appendChatMessage);
                } else {
                    chatMessagesDiv.innerHTML = '<p class="text-gray-500 text-center py-4">No messages in this ticket yet.</p>';
                }

                if (socket && socket.connected) {
                    console.log(`[fetchTicketDetails] Emitting join_ticket_room for: ${ticketId}`);
                    socket.emit('join_ticket_room', { ticket_id: ticketId });
                } else {
                    console.warn("[fetchTicketDetails] Socket not connected when trying to join room.");
                }

            } catch (error) {
                console.error("[fetchTicketDetails] Error fetching ticket details:", error);
                chatMessagesDiv.innerHTML = `<p class="text-red-400 text-center py-4">Error loading messages: ${error.message}</p>`;
                showPopupMessage(errorMessagePopup, `Error loading ticket: ${error.message}`, true);
                // Optionally redirect if ticket not found or forbidden
                if (error.message.includes("not found") || error.message.includes("Forbidden")) {
                    window.location.hash = '/#tickets';
                }
            }
        }
        /** Appends a chat message to the display. */
        function appendChatMessage(data) {
            if (!chatMessagesDiv) return;
            // Remove placeholder if it exists
            const placeholderMsg = chatMessagesDiv.querySelector('p.text-gray-500, p.text-red-400');
            if (placeholderMsg) placeholderMsg.remove();

            const messageElement = document.createElement('div');
            messageElement.classList.add('chat-message');
            messageElement.dataset.timestamp = data.timestamp; // ISO timestamp
            messageElement.dataset.senderId = data.sender_id;

            const timestamp = data.timestamp ? new Date(data.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) : '';
            const username = data.sender_username || data.username || 'System'; // Prefer sender_username if available
            const safeUsername = username.replace(/</g, "&lt;").replace(/>/g, "&gt;");
            const safeText = (data.text || '').replace(/</g, "&lt;").replace(/>/g, "&gt;"); // Sanitize text

            // Username Span (clickable)
            const usernameSpan = document.createElement('span');
            usernameSpan.classList.add('username');
            usernameSpan.textContent = `${safeUsername}:`;
            usernameSpan.addEventListener('click', () => showUserInfoModal(data.sender_id, safeUsername));

            messageElement.appendChild(usernameSpan);
            messageElement.append(` ${safeText} `); // Add space after username

            // Timestamp Span
            const timestampSpan = document.createElement('span');
            timestampSpan.classList.add('timestamp');
            timestampSpan.textContent = timestamp;
            messageElement.appendChild(timestampSpan);

            // Add context menu for moderators
            if (currentUser && currentUser.is_moderator) {
               messageElement.addEventListener('contextmenu', showChatContextMenu);
            }

            chatMessagesDiv.appendChild(messageElement);
            chatMessagesDiv.scrollTop = chatMessagesDiv.scrollHeight; // Scroll to bottom
        }
        /** Establishes WebSocket connection. */
        function connectSocket(ticketIdToJoin = null) {
            // If already connected and trying to join the same room, just emit join
            if (socket && socket.connected) {
                if (ticketIdToJoin && currentTicketId === ticketIdToJoin) {
                    console.log(`[connectSocket] Socket already connected, re-joining room: ${ticketIdToJoin}`);
                    socket.emit('join_ticket_room', { ticket_id: ticketIdToJoin });
                } else {
                    console.log(`[connectSocket] Socket already connected, not joining room ${ticketIdToJoin || 'N/A'}.`);
                }
                return;
            }

            console.log(`[connectSocket] Attempting to connect WebSocket... (Potential room join: ${ticketIdToJoin || 'none'})`);
            // Ensure previous socket is fully cleaned up if exists but disconnected
            if (socket) {
                socket.disconnect();
                socket = null;
            }
            socket = io(SOCKET_URL, { reconnectionAttempts: 3, withCredentials: true });

            socket.on('connect', () => {
                console.log('[connectSocket] WebSocket connected:', socket.id);
                // Join room immediately after connection if needed
                if (ticketIdToJoin && currentTicketId === ticketIdToJoin) {
                    console.log(`[connectSocket] Joining room post-connect: ${ticketIdToJoin}`);
                    socket.emit('join_ticket_room', { ticket_id: ticketIdToJoin });
                }
                setupSocketListeners(); // Setup listeners only once connected
            });

            socket.on('disconnect', (reason) => { console.log('[connectSocket] WebSocket disconnected:', reason); socket = null; }); // Clear socket on disconnect
            socket.on('connect_error', (error) => { console.error('[connectSocket] WebSocket connection error:', error); showPopupMessage(errorMessagePopup, "Chat connection failed.", true); socket = null; }); // Clear socket on error
        }
        /** Ensures WebSocket is connected. */
        function ensureSocketConnected() {
             if (!socket || !socket.connected) {
                 console.log("[ensureSocketConnected] Socket not connected, attempting connection...");
                 connectSocket(currentTicketId); // Pass current ticket ID if available
             } else {
                 console.log("[ensureSocketConnected] Socket already connected.");
                 // If already connected but maybe not in the room (e.g., page reload)
                 if (currentTicketId) {
                     socket.emit('join_ticket_room', { ticket_id: currentTicketId });
                 }
             }
        }
        /** Sets up WebSocket event listeners. */
        function setupSocketListeners() {
             if (!socket) return;
             console.log("[setupSocketListeners] Setting up listeners.");
             // Remove potential old listeners first to prevent duplicates
             socket.off('new_message'); socket.off('room_joined'); socket.off('error_message');
             socket.off('message_deleted'); socket.off('ticket_status_updated');
             socket.off('ticket_list_updated'); socket.off('action_success');

             // Add listeners
             socket.on('new_message', (data) => {
                 console.log("[Socket Listener] Received new_message:", data);
                 // Add sender_id if missing and message is from current user (heuristic)
                 if (!data.sender_id && data.username === currentUser?.username) data.sender_id = currentUser.user_id;
                 // Only append if viewing the correct ticket
                 if (data.ticket_id === currentTicketId) appendChatMessage(data);
             });
             socket.on('room_joined', (data) => { console.log('[Socket Listener] Joined room:', data.room); });
             socket.on('error_message', (data) => { console.error('[Socket Listener] WebSocket server error:', data.message); showPopupMessage(errorMessagePopup, data.message || 'Chat error.', true); });
             socket.on('message_deleted', (data) => {
                 console.log("[Socket Listener] Received message_deleted:", data);
                 if (data.ticket_id === currentTicketId) {
                     // Find message by timestamp (assuming timestamps are unique enough within context)
                     const messageToRemove = chatMessagesDiv.querySelector(`.chat-message[data-timestamp="${data.timestamp}"]`);
                     if (messageToRemove) { messageToRemove.remove(); console.log(`[Socket Listener] Removed message with timestamp: ${data.timestamp}`); }
                     else { console.warn(`[Socket Listener] Could not find message to delete with timestamp: ${data.timestamp}`); }
                 }
             });
             socket.on('ticket_status_updated', (data) => {
                  console.log("[Socket Listener] Received ticket_status_updated:", data);
                  // If viewing the main tickets list, refresh it
                  if (activeSectionId === pageSections['#tickets']) { console.log(`[Socket Listener] Ticket ${data.ticket_id} status updated to ${data.status}. Refreshing list.`); fetchTickets(); }
                  // If viewing the affected ticket, show a popup
                  if (data.ticket_id === currentTicketId) { showPopupMessage(ticketMessagePopup, `Ticket status updated to ${data.status}.`); }
                  // Update status in list item data attribute if it exists in the DOM
                  const ticketItem = document.querySelector(`.ticket-list-item[data-ticket-id="${data.ticket_id}"]`);
                  if(ticketItem) ticketItem.dataset.ticketStatus = data.status;
             });
              socket.on('ticket_list_updated', () => {
                  console.log("[Socket Listener] Received ticket_list_updated (likely due to deletion/creation).");
                  // If viewing the main tickets list, refresh it
                  if (activeSectionId === pageSections['#tickets']) { console.log("[Socket Listener] Refreshing ticket list."); fetchTickets(); }
                  // If viewing a ticket detail page when the list updates (e.g., ticket deleted), redirect
                  if (currentTicketId && activeSectionId === pageSections['#ticketDetail']) {
                      // Check if the current ticket still exists? For now, just redirect.
                      // TODO: Could add a check here to see if the current ticket ID is still valid before redirecting
                      console.log(`[Socket Listener] Ticket list updated while viewing ticket ${currentTicketId}. Redirecting to list.`);
                      showPopupMessage(errorMessagePopup, "The ticket list was updated. Returning to list.", true);
                      window.location.hash = '/#tickets';
                  }
              });
             socket.on('action_success', (data) => { console.log("[Socket Listener] Received action_success:", data); showPopupMessage(paymentMessage, data.message || 'Action successful.'); });
        }
        /** Disconnects WebSocket. */
        function disconnectSocket() { if (socket) { console.log('[disconnectSocket] Disconnecting WebSocket...'); socket.disconnect(); socket = null; } }

        /** Displays user roles in the specified container. */
        function displayUserRoles(roles) {
            console.log('[displayUserRoles] Received roles:', roles);

            const rolesContainer = document.getElementById('dashboard-user-roles');
            if (!rolesContainer) {
                console.error('[displayUserRoles] Container #dashboard-user-roles not found!');
                return;
            }
            rolesContainer.innerHTML = ''; // Clear previous roles

            if (roles && Array.isArray(roles) && roles.length > 0) {
                // Roles are already sorted by backend based on position
                roles.forEach(role => {
                    const roleElement = document.createElement('span');
                    roleElement.classList.add('role-span'); // Use shared class

                    let hexColor = '#9CA3AF'; // Default gray
                    // Convert Discord decimal color to HEX if valid
                    if (role.color && role.color !== 0) {
                        hexColor = '#' + role.color.toString(16).padStart(6, '0');
                    }
                    // Simple luminance check for text color contrast
                    const r = parseInt(hexColor.slice(1, 3), 16);
                    const g = parseInt(hexColor.slice(3, 5), 16);
                    const b = parseInt(hexColor.slice(5, 7), 16);
                    const luminance = (0.299 * r + 0.587 * g + 0.114 * b) / 255;
                    const textColorClass = luminance > 0.5 ? 'text-black' : 'text-white'; // Choose black or white text

                    roleElement.textContent = role.name || `Role ${role.id}`;
                    roleElement.style.backgroundColor = hexColor;
                    roleElement.classList.add(textColorClass);
                    rolesContainer.appendChild(roleElement);
                });
            } else {
                console.log('[displayUserRoles] No roles found or roles data is invalid.');
                rolesContainer.innerHTML = '<p class="text-gray-400 text-sm w-full">No roles found.</p>';
            }
        }

        /** Shows user info modal. */
        function showUserInfoModal(senderId, username) {
             if (!userInfoModal || !senderId) return;
             modalUsername.textContent = username || 'Unknown User';
             modalUserId.textContent = senderId;
             modalUserRoles.innerHTML = '<p class="text-gray-500 text-xs">Loading roles...</p>'; // Loading state

             // Check if info is for the currently logged-in user
             if (currentUser && currentUser.user_id === senderId && currentUser.roles) {
                 // Use displayUserRoles logic but target the modal container
                 const modalRolesContainer = document.getElementById('modal-user-roles');
                 if (modalRolesContainer) {
                     modalRolesContainer.innerHTML = ''; // Clear loading state
                     if (currentUser.roles.length > 0) {
                         currentUser.roles.forEach(role => { // Assumes roles are already sorted
                             const roleElement = document.createElement('span');
                             roleElement.classList.add('role-span');
                             let hexColor = '#9CA3AF';
                             if (role.color && role.color !== 0) hexColor = '#' + role.color.toString(16).padStart(6, '0');
                             const r = parseInt(hexColor.slice(1, 3), 16), g = parseInt(hexColor.slice(3, 5), 16), b = parseInt(hexColor.slice(5, 7), 16);
                             const luminance = (0.299 * r + 0.587 * g + 0.114 * b) / 255;
                             const textColorClass = luminance > 0.5 ? 'text-black' : 'text-white';
                             roleElement.textContent = role.name || `Role ${role.id}`;
                             roleElement.style.backgroundColor = hexColor;
                             roleElement.classList.add(textColorClass);
                             modalRolesContainer.appendChild(roleElement);
                         });
                     } else {
                          modalRolesContainer.innerHTML = '<p class="text-gray-500 text-xs">User has no roles.</p>';
                     }
                 }
             } else {
                 // TODO: Add fetch for other user roles if backend endpoint exists
                 // For now, show unavailable message
                 modalUserRoles.innerHTML = '<p class="text-gray-500 text-xs">Role information unavailable.</p>';
             }
             userInfoModal.classList.add('active');
        }
        /** Hides user info modal. */
        function hideUserInfoModal() { if (userInfoModal) userInfoModal.classList.remove('active'); }
        /** Positions context menu. */
        function positionContextMenu(menuElement, event) {
             const rect = event.target.getBoundingClientRect(); // Use target's rect for positioning relative to it
             let top = event.clientY + window.scrollY + 5; // Initial position below cursor
             let left = event.clientX + window.scrollX + 5; // Initial position right of cursor

             const menuHeight = menuElement.offsetHeight || 150; // Estimate height if needed
             const menuWidth = menuElement.offsetWidth || 150; // Estimate width if needed

             const windowHeight = window.innerHeight + window.scrollY;
             const windowWidth = window.innerWidth + window.scrollX;

             // Adjust if menu goes off-screen vertically
             if (top + menuHeight > windowHeight) {
                 top = event.clientY + window.scrollY - menuHeight - 5; // Position above cursor
             }
             // Adjust if menu goes off-screen horizontally
             if (left + menuWidth > windowWidth) {
                 left = event.clientX + window.scrollX - menuWidth - 5; // Position left of cursor
             }
             // Ensure menu doesn't go off-screen top or left
             if (top < window.scrollY) top = window.scrollY;
             if (left < window.scrollX) left = window.scrollX;

             menuElement.style.top = `${top}px`;
             menuElement.style.left = `${left}px`;
             menuElement.style.display = 'block'; // Make it visible
        }
        /** Hides context menu. */
        function hideContextMenu() {
            if (chatContextMenu) chatContextMenu.style.display = 'none';
            if (ticketContextMenu) ticketContextMenu.style.display = 'none';
            // Remove listeners added specifically for hiding the menu
            document.removeEventListener('click', hideContextMenuOnClickOutside);
            window.removeEventListener('scroll', hideContextMenu);
            currentContextMenu = null;
        }
        /** Specific handler to hide context menu only if click is outside */
        function hideContextMenuOnClickOutside(event) {
            if (currentContextMenu && !currentContextMenu.contains(event.target)) {
                hideContextMenu();
            }
        }
        /** Shows chat context menu. */
        function showChatContextMenu(event) {
            event.preventDefault(); hideContextMenu(); // Hide any existing menu first
            if (!currentUser || !currentUser.is_moderator || !chatContextMenu) return; // Only mods can use chat context menu
            const messageElement = event.target.closest('.chat-message'); if (!messageElement) return; // Ensure click was on a message

            // Store data about the clicked message
            contextMenuData.ticketId = currentTicketId;
            contextMenuData.messageTimestamp = messageElement.dataset.timestamp;
            contextMenuData.senderId = messageElement.dataset.senderId;
            contextMenuData.ticketStatus = null; // Not relevant for chat messages

            positionContextMenu(chatContextMenu, event);
            currentContextMenu = chatContextMenu;

            // Add listeners to close the menu
            setTimeout(() => { // Use timeout to prevent immediate closing from the same click event
                 document.addEventListener('click', hideContextMenuOnClickOutside);
                 window.addEventListener('scroll', hideContextMenu, { once: true });
            }, 0);
        }
        /** Shows ticket context menu. */
        function showTicketContextMenu(event) {
             event.preventDefault(); hideContextMenu(); // Hide any existing menu first
             if (!currentUser || !ticketContextMenu) return; // Must be logged in
             const ticketElement = event.target.closest('.ticket-list-item'); if (!ticketElement) return; // Ensure click was on a ticket item

             // Store data about the clicked ticket
             contextMenuData.ticketId = ticketElement.dataset.ticketId;
             contextMenuData.ticketStatus = ticketElement.dataset.ticketStatus;
             contextMenuData.senderId = null; // Not relevant for ticket list items
             contextMenuData.messageTimestamp = null; // Not relevant for ticket list items
             console.log("[showTicketContextMenu] Data:", contextMenuData);

             const isMod = currentUser.is_moderator === true; // Explicit check
             // Determine which actions are available based on status and role
             const canClose = contextMenuData.ticketStatus === 'open'; // User or mod can close
             const canReopen = contextMenuData.ticketStatus === 'closed' && isMod; // Mod only
             const canDelete = isMod; // Mod only

             // Show/hide menu items accordingly
             contextCloseTicketButton.classList.toggle('hidden', !canClose);
             contextReopenTicketButton.classList.toggle('hidden', !canReopen);
             contextDeleteTicketButton.classList.toggle('hidden', !canDelete);

             // Only show the menu if there's at least one action available
             if (canClose || canReopen || canDelete) {
                 positionContextMenu(ticketContextMenu, event);
                 currentContextMenu = ticketContextMenu;
                 // Add listeners to close the menu
                 setTimeout(() => { // Use timeout to prevent immediate closing
                      document.addEventListener('click', hideContextMenuOnClickOutside);
                      window.addEventListener('scroll', hideContextMenu, { once: true });
                 }, 0);
             }
        }
        /** Deletes chat message via socket. */
        function deleteChatMessage() {
             if (!contextMenuData.ticketId || !contextMenuData.messageTimestamp || !socket || !socket.connected) { showPopupMessage(errorMessagePopup, 'Cannot delete message: Invalid state or not connected.', true); return; }
             // Optional: Add confirmation?
             console.log(`[deleteChatMessage] Attempting to delete message: T:${contextMenuData.ticketId} TS:${contextMenuData.messageTimestamp}`);
             socket.emit('delete_message', { ticket_id: contextMenuData.ticketId, message_timestamp: contextMenuData.messageTimestamp });
             hideContextMenu(); // Hide menu after action
        }
        /** Closes ticket via socket. */
         function closeTicket() {
             if (!contextMenuData.ticketId || !socket || !socket.connected) { showPopupMessage(errorMessagePopup, 'Cannot close ticket: Invalid state or not connected.', true); return; }
             console.log(`[closeTicket] Attempting to close ticket: ${contextMenuData.ticketId}`);
             socket.emit('update_ticket_status', { ticket_id: contextMenuData.ticketId, new_status: 'closed' });
             hideContextMenu(); // Hide menu after action
         }
         /** Reopens ticket via socket. */
         function reopenTicket() {
             if (!contextMenuData.ticketId || !socket || !socket.connected) { showPopupMessage(errorMessagePopup, 'Cannot reopen ticket: Invalid state or not connected.', true); return; }
             if (!currentUser?.is_moderator) { showPopupMessage(errorMessagePopup, 'You do not have permission to reopen tickets.', true); hideContextMenu(); return; }
             console.log(`[reopenTicket] Attempting to reopen ticket: ${contextMenuData.ticketId}`);
             socket.emit('update_ticket_status', { ticket_id: contextMenuData.ticketId, new_status: 'open' });
             hideContextMenu(); // Hide menu after action
         }
         /** Deletes ticket via socket. */
         function deleteTicket() {
             if (!contextMenuData.ticketId || !socket || !socket.connected) { showPopupMessage(errorMessagePopup, 'Cannot delete ticket: Invalid state or not connected.', true); return; }
             if (!currentUser?.is_moderator) { showPopupMessage(errorMessagePopup, 'You do not have permission to delete tickets.', true); hideContextMenu(); return; }
             // Confirmation dialog
             if (confirm(`Are you sure you want to permanently delete ticket #${contextMenuData.ticketId.slice(-6)}? This action cannot be undone.`)) {
                 console.log(`[deleteTicket] Attempting to delete ticket: ${contextMenuData.ticketId}`);
                 socket.emit('delete_ticket', { ticket_id: contextMenuData.ticketId });
             }
             hideContextMenu(); // Hide menu after action
         }


        // --- Admin Dashboard Functions ---

        /** Loads data needed for the admin sections (config, products). */
        async function loadAdminDashboardData() {
            console.log("Loading admin dashboard data...");
            if (!currentUser?.is_moderator) return; // Double check permission
            await loadSiteConfigForm(); // Load config form data
            await loadProductManagementTable(); // Load product table data
        }

        /** Fetches site config and populates the admin form. */
        async function loadSiteConfigForm() {
            if (!siteConfigForm || !configSiteTitleInput || !configSiteIconInput || !configIconPreview || !configHeaderLinksContainer || !configSaveStatus) return; // Ensure elements exist
            if (!siteConfig) {
                console.warn("Site config not loaded yet for admin form.");
                configSaveStatus.textContent = "Error: Config not loaded.";
                configSaveStatus.className = 'text-sm text-center h-5 mt-2 text-red-400';
                return;
            }
            // Populate form fields from siteConfig
            configSiteTitleInput.value = siteConfig.siteTitle || '';
            const iconUrl = siteConfig.siteIconUrl || DEFAULT_ICON_URL;
            configSiteIconInput.value = siteConfig.siteIconUrl || ''; // Use stored URL or empty
            configIconPreview.src = iconUrl; // Show current icon or default

            configHeaderLinksContainer.innerHTML = ''; // Clear existing links
            (siteConfig.headerLinks || []).forEach((link) => {
                addHeaderLinkInput(link.name, link.href, link.target);
            });
            configSaveStatus.textContent = ''; // Clear status on load
            configSaveStatus.className = 'text-sm text-center h-5 mt-2';
        }

        /** Adds a row of inputs for a header link to the config form. */
        function addHeaderLinkInput(name = '', href = '', target = '') {
             const linkGroup = document.createElement('div');
             linkGroup.className = 'link-group'; // Style with: @apply flex items-center space-x-2 mb-2;
             // Apply input styles directly and use flex classes for sizing
             linkGroup.innerHTML = `
                 <input type="text" placeholder="Link Name" value="${name}" class="link-name flex-1 bg-slate-700 border border-slate-600 rounded-md py-2 px-3 text-white focus:outline-none focus:ring-2 focus:ring-orange-500 focus:border-transparent placeholder-gray-400" required>
                 <input type="text" placeholder="Link Href" value="${href}" class="link-href flex-1 bg-slate-700 border border-slate-600 rounded-md py-2 px-3 text-white focus:outline-none focus:ring-2 focus:ring-orange-500 focus:border-transparent placeholder-gray-400" required>
                 <input type="text" placeholder="Target (e.g., _blank)" value="${target || ''}" class="link-target flex-none w-32 bg-slate-700 border border-slate-600 rounded-md py-2 px-3 text-white focus:outline-none focus:ring-2 focus:ring-orange-500 focus:border-transparent placeholder-gray-400">
                 <button type="button" class="remove-link-button bg-red-600 hover:bg-red-700 text-white text-xs font-bold py-1 px-2 rounded flex-shrink-0" title="Remove Link">X</button>
             `;
             // Add event listener to the remove button
             linkGroup.querySelector('.remove-link-button').addEventListener('click', () => linkGroup.remove());
             configHeaderLinksContainer.appendChild(linkGroup);
        }

        /** Handles saving the site configuration. */
        async function handleSaveSiteConfig(event) {
            event.preventDefault();
            if (!siteConfigForm || !saveConfigButton) return;
            saveConfigButton.disabled = true; saveConfigButton.textContent = 'Saving...';
            configSaveStatus.textContent = ''; configSaveStatus.className = 'text-sm text-center h-5 mt-2'; // Reset status

            // Collect data from the form
            const updatedConfig = {
                siteTitle: configSiteTitleInput.value.trim(),
                siteIconUrl: configSiteIconInput.value.trim() || null, // Store null if empty
                headerLinks: []
            };
            configHeaderLinksContainer.querySelectorAll('.link-group').forEach(group => {
                const nameInput = group.querySelector('.link-name');
                const hrefInput = group.querySelector('.link-href');
                const targetInput = group.querySelector('.link-target');
                // Only add if name and href are provided
                if (nameInput.value.trim() && hrefInput.value.trim()) {
                    updatedConfig.headerLinks.push({
                        name: nameInput.value.trim(),
                        href: hrefInput.value.trim(),
                        target: targetInput.value.trim() || null // Store null if empty
                    });
                }
            });

            try {
                // Send PUT request to the backend
                const response = await fetch(`${API_BASE_URL}/api/config`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(updatedConfig),
                    credentials: 'include' // Important for session cookies
                });
                const result = await response.json();
                if (!response.ok) throw new Error(result.error || `HTTP ${response.status}`);

                // Update local config and UI
                siteConfig = result;
                applySiteConfig(siteConfig); // Re-apply the updated config to header/footer etc.
                configSaveStatus.textContent = 'Configuration saved successfully!';
                configSaveStatus.classList.add('text-green-400');
                showPopupMessage(configMessagePopup, 'Configuration saved!');
            } catch (error) {
                console.error("Error saving site config:", error);
                configSaveStatus.textContent = `Error: ${error.message}`;
                configSaveStatus.classList.add('text-red-400');
                showPopupMessage(errorMessagePopup, `Failed to save config: ${error.message}`, true);
            } finally {
                // Re-enable button
                saveConfigButton.disabled = false; saveConfigButton.textContent = 'Save Configuration';
            }
        }

        /** Fetches products and populates the management table. */
        async function loadProductManagementTable() {
             if (!productListTableBody || !productListStatus) return;
             productListTableBody.innerHTML = ''; productListStatus.textContent = 'Loading products...';
             productListStatus.classList.remove('hidden');

             try {
                 const response = await fetch(`${API_BASE_URL}/api/products`); // No credentials needed if public endpoint
                 if (!response.ok) throw new Error(`HTTP ${response.status}`);
                 const products = await response.json();
                 productListStatus.classList.add('hidden'); // Hide loading text

                 if (!products || products.length === 0) {
                     productListStatus.textContent = 'No products found.';
                     productListStatus.classList.remove('hidden'); // Show "No products" text
                     return;
                 }

                 // Populate table rows
                 products.forEach(product => {
                     const row = productListTableBody.insertRow();
                     row.dataset.productId = product._id; // Add product ID to row for easy access
                     row.innerHTML = `
                         <td>${product.name || 'N/A'}</td>
                         <td>$${product.price?.toFixed(2) || 'N/A'}</td>
                         <td>${product.tag || '-'}</td>
                         <td class="actions">
                             <button class="edit-btn" title="Edit Product">Edit</button>
                             <button class="clone-btn" title="Clone Product">Clone</button>
                             <button class="delete-btn" title="Delete Product">Delete</button>
                         </td>
                     `;
                     // Add event listeners to buttons using the product data directly
                     row.querySelector('.edit-btn').addEventListener('click', () => openProductEditModal(product));
                     row.querySelector('.clone-btn').addEventListener('click', () => handleCloneProduct(product));
                     row.querySelector('.delete-btn').addEventListener('click', () => handleDeleteProduct(product._id, product.name));
                 });
             } catch (error) {
                 console.error("Error loading products for admin table:", error);
                 productListStatus.textContent = 'Failed to load products.';
                 productListStatus.classList.remove('hidden'); // Show error text
                 showPopupMessage(errorMessagePopup, `Error loading products: ${error.message}`, true);
             }
        }

        /** Handles cloning a product */
        function handleCloneProduct(product) {
            if (!product) return;
            // Create a deep copy of the product data to avoid modifying the original object
            const clonedProductData = JSON.parse(JSON.stringify(product));
            // Clear the ID to indicate it's a new product
            clonedProductData._id = null;
            // Optionally modify the name
            clonedProductData.name = `Clone of ${clonedProductData.name || 'Unnamed Product'}`;
            // Open the modal with the cloned data
            openProductEditModal(clonedProductData);
        }


        /** Opens the Add/Edit Product modal. */
        function openProductEditModal(product = null) {
             if (!productEditModal || !productEditForm || !customHexInputContainer) return; // Ensure elements exist
             productEditForm.reset(); // Clear form fields
             productEditStatus.textContent = ''; // Clear previous status messages
             productEditStatus.className = 'text-sm text-center h-5 mt-2'; // Reset status class

             if (product) {
                 // Editing existing product or populating clone: Populate form
                 productModalTitle.textContent = product._id ? 'Edit Product' : 'Add Cloned Product'; // Adjust title for clone
                 productEditIdInput.value = product._id || ''; // Set ID only if editing
                 productEditNameInput.value = product.name || '';
                 productEditThumbnailInput.value = product.thumbnailUrl || '';
                 productEditPriceInput.value = product.price || '';
                 productEditTagInput.value = product.tag || '';
                 // Set dropdown based on whether custom hex is present and valid
                 const hasValidCustomHex = product.customBorderHex && /^#[0-9A-F]{6}$/i.test(product.customBorderHex);
                 productEditTagColorSelect.value = hasValidCustomHex ? 'custom' : (product.tagColor || 'gray');
                 productEditCustomHexInput.value = hasValidCustomHex ? product.customBorderHex : '';
                 productEditDescriptionInput.value = product.description || '';
                 productEditFeaturesInput.value = (product.features || []).join('\n');
                 productEditPaymentLinkInput.value = product.paymentLink || '';
             } else {
                 // Adding completely new product: Clear fields
                 productModalTitle.textContent = 'Add Product';
                 productEditIdInput.value = ''; // Ensure ID is empty
                 productEditTagColorSelect.value = 'gray'; // Default color
                 productEditCustomHexInput.value = ''; // Clear hex input
             }
             // Update visibility of HEX input based on current dropdown value
             toggleCustomHexInput();
             productEditModal.classList.add('active'); // Show the modal
        }

        /** Toggles the visibility of the Custom HEX input based on dropdown selection */
        function toggleCustomHexInput() {
            if (customHexInputContainer && productEditTagColorSelect) {
                 const selectedColor = productEditTagColorSelect.value;
                 customHexInputContainer.classList.toggle('hidden', selectedColor !== 'custom');
            }
        }

        /** Closes the Add/Edit Product modal. */
        function closeProductEditModal() { if (productEditModal) productEditModal.classList.remove('active'); }

        /** Handles saving (add/update) a product from the modal form. */
        async function handleSaveProduct(event) {
             event.preventDefault(); if (!productEditForm || !productSaveButton) return;
             productSaveButton.disabled = true; productSaveButton.textContent = 'Saving...';
             productEditStatus.textContent = ''; productEditStatus.className = 'text-sm text-center h-5 mt-2'; // Reset status

             const productId = productEditIdInput.value; const isEditing = !!productId;
             const url = isEditing ? `${API_BASE_URL}/api/products/${productId}` : `${API_BASE_URL}/api/products`;
             const method = isEditing ? 'PUT' : 'POST';

             // Determine final tagColor and customBorderHex
             let tagColorValue = productEditTagColorSelect.value;
             let customHexValue = productEditCustomHexInput.value.trim();
             let finalTagColor = 'gray'; // Default
             let finalCustomHex = null;

             if (tagColorValue === 'custom') {
                 // Validate HEX if 'custom' is selected
                 if (customHexValue && /^#[0-9A-F]{6}$/i.test(customHexValue)) {
                     finalTagColor = 'custom'; // Keep tagColor as 'custom' to indicate intent
                     finalCustomHex = customHexValue;
                 } else {
                     // Invalid HEX format
                     productEditStatus.textContent = 'Invalid Custom HEX format. Please use #RRGGBB.';
                     productEditStatus.classList.add('text-red-400');
                     productSaveButton.disabled = false; productSaveButton.textContent = 'Save Product'; return; // Stop execution
                 }
             } else {
                 // Predefined color selected
                 finalTagColor = tagColorValue || 'gray'; // Use selected color or default
                 finalCustomHex = null; // Ensure custom hex is null
             }

             // Construct product data object
             const productData = {
                 name: productEditNameInput.value.trim(),
                 thumbnailUrl: productEditThumbnailInput.value.trim() || null,
                 price: parseFloat(productEditPriceInput.value),
                 tag: productEditTagInput.value.trim() || null,
                 tagColor: finalTagColor, // Store 'custom' or the color name
                 customBorderHex: finalCustomHex, // Store valid HEX or null
                 description: productEditDescriptionInput.value.trim() || null,
                 features: productEditFeaturesInput.value.split('\n').map(f => f.trim()).filter(f => f), // Split features by newline
                 paymentLink: productEditPaymentLinkInput.value.trim() || null
             };

             // Basic validation
             if (!productData.name || isNaN(productData.price)) {
                  productEditStatus.textContent = 'Name and valid Price are required.';
                  productEditStatus.classList.add('text-red-400');
                  productSaveButton.disabled = false; productSaveButton.textContent = 'Save Product'; return;
             }

             try {
                 // Send request to backend
                 const response = await fetch(url, {
                     method: method,
                     headers: { 'Content-Type': 'application/json' },
                     body: JSON.stringify(productData),
                     credentials: 'include' // Important for authentication
                 });
                 const result = await response.json();
                 if (!response.ok) throw new Error(result.error || `HTTP ${response.status}`);

                 // Success: Show message, close modal, refresh relevant views
                 showPopupMessage(productMessagePopup, `Product ${isEditing ? 'updated' : 'added'} successfully!`);
                 closeProductEditModal();
                 await loadProductManagementTable(); // Refresh admin table
                 if (activeSectionId === pageSections['#products']) await fetchProducts(); // Refresh public product grid if visible
             } catch (error) {
                 // Error handling
                 console.error(`Error ${isEditing ? 'updating' : 'adding'} product:`, error);
                 productEditStatus.textContent = `Error: ${error.message}`;
                 productEditStatus.classList.add('text-red-400');
                 showPopupMessage(errorMessagePopup, `Failed to save product: ${error.message}`, true);
             } finally {
                 // Re-enable button
                 productSaveButton.disabled = false; productSaveButton.textContent = 'Save Product';
             }
        }

        /** Handles deleting a product after confirmation. */
        async function handleDeleteProduct(productId, productName) {
            if (!productId) return;
            // Confirmation dialog
            if (!confirm(`Are you sure you want to delete the product "${productName || 'this product'}"? This cannot be undone.`)) return;

            console.log(`Attempting to delete product: ${productId}`);
            try {
                // Send DELETE request
                const response = await fetch(`${API_BASE_URL}/api/products/${productId}`, {
                    method: 'DELETE',
                    credentials: 'include' // Important for authentication
                });
                const result = await response.json(); // Try to parse JSON even on error for potential messages
                if (!response.ok) throw new Error(result.error || `HTTP ${response.status}`);

                // Success: Show message, refresh relevant views
                showPopupMessage(productMessagePopup, 'Product deleted successfully!');
                await loadProductManagementTable(); // Refresh admin table
                if (activeSectionId === pageSections['#products']) await fetchProducts(); // Refresh public product grid if visible
            } catch (error) {
                // Error handling
                console.error("Error deleting product:", error);
                showPopupMessage(errorMessagePopup, `Failed to delete product: ${error.message}`, true);
            }
        }


        // --- Event Listeners Setup ---

        // Login/Logout
        loginButton.addEventListener('click', (e) => { e.preventDefault(); window.location.href = loginButton.href; });
        async function handleLogout() {
            console.log('Logging out...');
            try {
                // Attempt backend logout first
                const response = await fetch(`${API_BASE_URL}/logout`, { credentials: 'include' });
                if (!response.ok) {
                    let errorMsg = 'Logout request failed';
                    try { const errorData = await response.json(); errorMsg = errorData.error || errorMsg; } catch (parseError) {}
                    console.warn(`Backend logout failed: ${errorMsg}. Proceeding with client-side cleanup.`);
                }
            } catch(error) {
                console.error("Network error during logout fetch:", error);
                // Still proceed with client-side cleanup even if network fails
            } finally {
                 // Client-side cleanup regardless of backend response
                 currentUser = { logged_in: false };
                 isInitialLoginCheckComplete = false; // Force re-check on next load potentially
                 isInitialConfigLoadComplete = false;
                 localStorage.removeItem('currentPage'); // Clear any saved state
                 disconnectSocket(); // Disconnect chat
                 updateHeaderUI(currentUser); // Update UI to logged-out state
                 adminDashboardSections?.classList.add('hidden'); // Hide admin sections
                 console.log("Redirecting to /#home after logout cleanup.");
                 window.location.hash = '/#home'; // Redirect to home
                 // No need to call runNavigation here, hash change will trigger it
            }
        }
        logoutButton.addEventListener('click', handleLogout);
        dashboardLogoutButton.addEventListener('click', handleLogout);

        // Navigation
        window.addEventListener('hashchange', runNavigation);

        // Ticket Creation
        if(createTicketForm) createTicketForm.addEventListener('submit', async (event) => {
            event.preventDefault();
            const subject = ticketSubjectInput.value.trim(); const message = ticketMessageInput.value.trim();
            createTicketStatus.textContent = ''; createTicketStatus.className = 'h-6 text-sm mt-4 mb-4 text-center'; // Reset status
            if (!subject || !message) { createTicketStatus.textContent = 'Please fill out both subject and message.'; createTicketStatus.classList.add('error'); return; }

            const submitButton = document.getElementById('create-ticket-button');
            submitButton.disabled = true; submitButton.textContent = 'Submitting...';

            try {
                const response = await fetch(`${API_BASE_URL}/api/tickets`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ subject, message }),
                    credentials: 'include'
                });
                if (!response.ok) {
                    let errorData;
                    try { errorData = await response.json(); } catch (e) {} // Try to get error message from JSON
                    throw new Error(errorData?.error || `HTTP error! status: ${response.status}`);
                }
                const result = await response.json(); // Get result if needed (e.g., new ticket ID)
                createTicketStatus.textContent = 'Ticket submitted successfully!';
                createTicketStatus.classList.add('success');
                createTicketForm.reset(); // Clear the form
                if (activeSectionId === pageSections['#tickets']) fetchTickets(); // Refresh list if viewing
                // Optionally redirect to the new ticket?
                // window.location.hash = `/#ticketDetail?id=${result.ticket_id}`;
            } catch (error) {
                console.error('Error creating ticket:', error);
                createTicketStatus.textContent = `Error: ${error.message}`;
                createTicketStatus.classList.add('error');
            } finally {
                submitButton.disabled = false; submitButton.textContent = 'Submit Ticket';
            }
        });

        // Ticket Chat Submission
        if(chatInputForm) chatInputForm.addEventListener('submit', (event) => {
            event.preventDefault(); const messageText = chatInput.value.trim();
            if (messageText && socket && socket.connected && currentTicketId) {
                socket.emit('send_message', { ticket_id: currentTicketId, text: messageText });
                chatInput.value = ''; // Clear input after sending
            }
            else if (!socket || !socket.connected) { showPopupMessage(errorMessagePopup, 'Not connected to chat.', true); }
            else if (!currentTicketId) { showPopupMessage(errorMessagePopup, 'No active ticket selected.', true); }
        });

        // Modals & Context Menus
        if (modalCloseButton) modalCloseButton.addEventListener('click', hideUserInfoModal);
        if (userInfoModal) userInfoModal.addEventListener('click', (event) => { if (event.target === userInfoModal) hideUserInfoModal(); }); // Close on backdrop click
        if (contextDeleteButton) contextDeleteButton.addEventListener('click', deleteChatMessage);
        if (contextUserInfoButton) contextUserInfoButton.addEventListener('click', () => {
            if (contextMenuData.senderId) {
                // Try to get username from the message element itself for display
                const messageElement = chatMessagesDiv?.querySelector(`.chat-message[data-timestamp="${contextMenuData.messageTimestamp}"]`);
                const usernameElement = messageElement?.querySelector('.username');
                const username = usernameElement ? usernameElement.textContent.replace(':', '') : 'Unknown User';
                showUserInfoModal(contextMenuData.senderId, username);
            }
            hideContextMenu(); // Hide menu after action
        });
        if (contextCloseTicketButton) contextCloseTicketButton.addEventListener('click', closeTicket);
        if (contextReopenTicketButton) contextReopenTicketButton.addEventListener('click', reopenTicket);
        if (contextDeleteTicketButton) contextDeleteTicketButton.addEventListener('click', deleteTicket);

        // Mobile Menu Toggle
        if (mobileMenuButton && mobileMenuNav) mobileMenuButton.addEventListener('click', () => mobileMenuNav.classList.toggle('hidden'));

        // Admin Forms
        if (siteConfigForm) siteConfigForm.addEventListener('submit', handleSaveSiteConfig);
        if (addHeaderLinkButton) addHeaderLinkButton.addEventListener('click', () => addHeaderLinkInput()); // Add empty link row
        if (addProductButton) addProductButton.addEventListener('click', () => openProductEditModal()); // Open modal for adding
        if (productEditModal && productModalCloseButton) productModalCloseButton.addEventListener('click', closeProductEditModal);
        if (productEditModal) productEditModal.addEventListener('click', (event) => { if (event.target === productEditModal) closeProductEditModal(); }); // Close on backdrop click
        if (productEditForm) productEditForm.addEventListener('submit', handleSaveProduct);
        // Add listener to the color dropdown to toggle HEX input visibility
        if (productEditTagColorSelect) productEditTagColorSelect.addEventListener('change', toggleCustomHexInput);
        // Add listener to icon input to update preview
        if (configSiteIconInput && configIconPreview) {
             configSiteIconInput.addEventListener('input', () => {
                 configIconPreview.src = configSiteIconInput.value.trim() || DEFAULT_ICON_URL;
             });
             // Add error handler for preview image itself
             configIconPreview.onerror = () => { configIconPreview.src = ICON_PLACEHOLDER_URL; };
        }


        // --- Initial Page Load Logic ---
        document.addEventListener('DOMContentLoaded', () => {
            console.log("DOM fully loaded.");
            createSnowflakes(); // Initialize snow effect
            checkLoginStatus(); // Start the check login -> load config -> navigate sequence
        });

    </script>

</body>
</html>