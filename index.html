<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shillette - Advanced DMA Firmware</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
    <style type="text/tailwindcss">
        /* --- Animations --- */
        @keyframes animateGradient {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        @keyframes spinBorder {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        @keyframes fall {
            0% { transform: translateY(-10vh) translateX(0); opacity: 1; }
            100% { transform: translateY(110vh) translateX(5vw); opacity: 0; }
        }

        @keyframes scaleUpDown {
            0%, 100% { transform: scaleY(0.4); }
            20% { transform: scaleY(1.0); }
        }

        /* --- Base Styles --- */
        body {
            font-family: 'Inter', sans-serif;
            @apply bg-gradient-to-br from-orange-700 via-black to-black text-gray-300;
            background-size: 200% 200%;
            animation: animateGradient 25s ease infinite;
            overflow-x: hidden;
            position: relative;
            z-index: 0;
        }

        /* Optional: Background image overlay */
        body::before {
            content: '';
            position: fixed;
            inset: 0;
            background-image: url('images/background.png'); /* Ensure this path is correct */
            background-size: cover;
            background-position: center center;
            background-repeat: no-repeat;
            background-attachment: fixed;
            opacity: 0.2; /* Adjust opacity as needed */
            z-index: -1; /* Place behind content */
        }

        /* --- Snow Effect --- */
        #snow-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 40; /* Ensure it's above background but below modals/header */
            overflow: hidden;
        }

        .snowflake {
            position: absolute;
            background-color: white;
            border-radius: 50%;
            pointer-events: none;
            animation-name: fall;
            animation-timing-function: linear;
            animation-iteration-count: infinite;
        }

        /* --- Card Styles --- */
        .card-gradient-border::before {
            content: '';
            position: absolute;
            inset: 0;
            border-radius: 0.5rem; /* Match card's border-radius */
            padding: 2px; /* Border thickness */
            background-size: 300% 300%;
            animation: spinBorder 5s linear infinite;
            -webkit-mask:
                linear-gradient(#fff 0 0) content-box,
                linear-gradient(#fff 0 0);
            -webkit-mask-composite: xor;
            mask-composite: exclude;
            pointer-events: none;
            z-index: -1;
        }

        .card-gradient-border.orange-border::before {
            background-image: linear-gradient(145deg, #f97316, #9a3412, #000000);
        }

        .card-gradient-border.gray-border::before {
             background-image: linear-gradient(145deg, #9ca3af, #374151, #000000);
             animation-duration: 6s; /* Slightly different speed */
        }

        .product-card {
            @apply relative bg-slate-800/80 backdrop-blur-sm rounded-lg p-6 shadow-xl flex flex-col transition-transform duration-300 ease-in-out hover:scale-[1.03] z-0;
             overflow: hidden; /* Needed for the border mask */
        }

        /* --- Page Section & General Content Styles --- */
        #dashboard-content h2, #products-page-content h2, #tickets-page-content h2, #ticket-detail-content h2 {
            @apply text-3xl md:text-4xl font-bold text-white text-center mb-12;
        }
        #dashboard-content .dashboard-card, #tickets-page-content .ticket-card, #ticket-detail-content .ticket-card {
            @apply bg-slate-800/80 backdrop-blur-sm p-6 rounded-lg shadow-lg;
        }

        .paypal-button {
            @apply bg-sky-600 hover:bg-sky-700 text-white text-sm font-medium py-2 px-4 rounded-md transition duration-300 flex items-center justify-center space-x-2 w-full;
        }

        /* --- Message Popups --- */
        #payment-message, #ticket-message, #error-message {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            @apply text-white text-sm font-medium py-2 px-5 rounded-lg shadow-lg opacity-0 transition-opacity duration-500 ease-in-out z-50 pointer-events-none;
        }
         #payment-message.show, #ticket-message.show, #error-message.show {
             opacity: 1;
         }
         #payment-message, #ticket-message { @apply bg-green-600; } /* General success */
         #error-message { @apply bg-red-600; } /* General error */

        /* --- Loading Overlay --- */
        #loading-overlay {
            position: fixed;
            inset: 0;
            @apply bg-black/60 backdrop-blur-sm flex items-center justify-center z-50 transition-opacity duration-300 ease-in-out opacity-0 pointer-events-none;
        }
        #loading-overlay.active {
             @apply opacity-100 pointer-events-auto;
        }

        /* Loader animation */
        .loader {
            display: flex;
            align-items: center;
            justify-content: space-between;
            width: 50px;
            height: 25px;
        }
        .loader-bar {
            display: block;
            width: 8px;
            height: 100%;
            background-color: #f97316; /* Orange color */
            border-radius: 4px;
            animation: scaleUpDown 1.2s infinite ease-in-out;
        }
        .loader-bar:nth-child(2) { animation-delay: 0.2s; }
        .loader-bar:nth-child(3) { animation-delay: 0.4s; }

        /* --- Page Section Visibility (FIXED) --- */
        .page-section {
            /* Use display none/block for robust hiding/showing */
            /* transition: opacity 0.3s ease-in-out; Optional: fade effect, but display handles layout */
        }
        .page-section.hidden {
             display: none !important; /* Use important to ensure override if needed */
        }
        .page-section:not(.hidden) {
             display: block; /* Or flex/grid if the container uses it */
             /* opacity: 1; */
             /* pointer-events: auto; */
             /* position: relative; */ /* Ensure it takes up space */
        }


        /* --- Ticket Specific Styles --- */
        .ticket-list-item {
            @apply bg-slate-700/50 p-4 rounded-md mb-3 flex justify-between items-center cursor-pointer hover:bg-slate-600/50 transition-colors;
        }
        .status-open { @apply bg-green-500 text-green-900 text-xs font-bold px-2 py-0.5 rounded-full; }
        .status-closed { @apply bg-red-500 text-red-900 text-xs font-bold px-2 py-0.5 rounded-full; }

        /* Ticket creation form status message */
        #create-ticket-status {
            @apply text-sm mt-4 mb-4 text-center;
        }
        #create-ticket-status.success { @apply text-green-400; }
        #create-ticket-status.error { @apply text-red-400; }

        /* Moderator Ticket View Styles */
        #moderator-management-view h3 {
             @apply text-xl font-semibold text-white mb-4;
        }
        #moderator-management-view details summary {
             @apply cursor-pointer text-lg font-semibold text-white mb-3 hover:text-orange-400 transition-colors;
        }
        #moderator-management-view details[open] summary {
             @apply text-orange-400;
        }
        .ticket-list-container {
             @apply space-y-3 max-h-96 overflow-y-auto pr-2;
        }


        /* --- Chat Styles --- */
        #chat-messages {
             @apply h-64 md:h-80 overflow-y-auto mb-4 p-3 bg-slate-900/50 rounded-md border border-slate-700 space-y-2;
        }
        .chat-message {
             @apply text-sm break-words p-1 rounded hover:bg-slate-800/50 transition-colors; /* Added padding/hover for context menu target */
        }
        .chat-message .username {
             @apply font-semibold text-orange-400 mr-2 cursor-pointer hover:underline; /* Make username clickable */
        }
         .chat-message .timestamp {
             @apply text-xs text-gray-500 ml-2 whitespace-nowrap;
         }
         #chat-input-form {
             @apply flex space-x-2;
         }
         #chat-input {
              @apply flex-grow bg-slate-700 border border-slate-600 rounded-md py-2 px-3 text-white focus:outline-none focus:ring-2 focus:ring-orange-500 focus:border-transparent placeholder-gray-500;
         }
         #send-chat-button {
             @apply bg-orange-600 hover:bg-orange-700 text-white font-medium py-2 px-4 rounded-lg transition duration-300;
         }

        /* --- User Info Modal --- */
        #user-info-modal {
             @apply fixed inset-0 bg-black/70 backdrop-blur-sm flex items-center justify-center z-50 opacity-0 pointer-events-none transition-opacity duration-300;
        }
        #user-info-modal.active {
             @apply opacity-100 pointer-events-auto;
        }
        .modal-content {
             @apply bg-slate-800 p-6 rounded-lg shadow-xl max-w-md w-full text-white;
        }
        .modal-close-button {
             @apply absolute top-3 right-3 text-gray-400 hover:text-white transition-colors;
        }
        #modal-user-roles {
             @apply flex flex-wrap gap-1 mt-3;
        }

        /* --- Custom Context Menu --- */
        #chat-context-menu, #ticket-context-menu {
             @apply absolute bg-slate-700 border border-slate-600 rounded-md shadow-lg py-1 text-sm text-white z-50 hidden; /* Start hidden */
        }
        .context-menu-item {
             @apply px-3 py-1.5 hover:bg-orange-600 cursor-pointer block w-full text-left;
        }
        .context-menu-item.hidden {
            display: none; /* Hide specific menu items */
        }
        .context-menu-item.delete {
             @apply hover:bg-red-600 text-red-400 hover:text-white; /* Style delete differently */
        }

        /* --- Mobile Menu --- */
        #mobile-menu {
             @apply absolute top-full left-0 right-0 bg-gray-800/95 backdrop-blur-sm p-4 space-y-2 border-t border-gray-700/50 md:hidden z-30;
             /* Start hidden, JS will toggle */
        }
        .mobile-menu-link {
             @apply block text-gray-300 hover:text-white transition duration-200 py-1;
        }


    </style>
</head>
<body class="min-h-screen flex flex-col">

    <div id="snow-container"></div>

    <div id="payment-message">Placeholder</div>
    <div id="ticket-message">Placeholder</div>
    <div id="error-message">Placeholder</div>

    <div id="loading-overlay">
        <div class="loader">
            <span class="loader-bar"></span>
            <span class="loader-bar"></span>
            <span class="loader-bar"></span>
        </div>
    </div>

    <div id="user-info-modal">
        <div class="modal-content relative">
            <button id="modal-close-button" class="modal-close-button">
                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path></svg>
            </button>
            <h3 class="text-lg font-semibold mb-3" id="modal-username">Username</h3>
            <p class="text-sm text-gray-400 mb-1">User ID: <span id="modal-user-id">N/A</span></p>
            <p class="text-sm font-medium mb-2">Roles:</p>
            <div id="modal-user-roles">
                <p class="text-gray-500 text-xs">Roles not available.</p>
            </div>
            </div>
    </div>

    <div id="chat-context-menu">
        <button class="context-menu-item" id="context-delete-message">Delete Message</button>
        <button class="context-menu-item" id="context-user-info">User Info</button>
    </div>

    <div id="ticket-context-menu">
        <button class="context-menu-item" id="context-close-ticket">Close Ticket</button>
        <button class="context-menu-item" id="context-reopen-ticket">Reopen Ticket</button>
        <button class="context-menu-item delete" id="context-delete-ticket">Delete Ticket</button>
    </div>


    <header class="py-4 sticky top-0 z-40 bg-gray-900/80 backdrop-blur-md border-b border-gray-700/50">
        <div class="container mx-auto px-6 flex justify-between items-center">
            <div class="flex items-center space-x-2">
                <img src="images/icon.png" alt="Shillette Icon" class="w-8 h-8" onerror="this.style.display='none'; this.nextElementSibling.classList.remove('hidden');">
                <span class="text-2xl font-bold text-white hidden">Shillette</span> <span class="text-2xl font-bold text-white">Shillette</span>
            </div>
            <div class="flex items-center space-x-6">
                <nav class="hidden md:flex space-x-6">
                    <a href="/#home" id="home-link" class="text-gray-300 hover:text-white transition duration-200">Home</a>
                    <a href="/#products" id="products-link" class="text-gray-300 hover:text-white transition duration-200">Products</a>
                    <a href="/#tickets" id="tickets-link" class="text-gray-300 hover:text-white transition duration-200">Tickets</a>
                    <a href="https://discord.gg/shillette" target="_blank" rel="noopener noreferrer" class="text-gray-300 hover:text-white transition duration-200">Discord</a>
                </nav>
                <div id="user-area" class="flex items-center">
                    <a id="login-button" href="https://api.shillette.com/login" class="bg-orange-600 hover:bg-orange-700 text-white text-sm font-medium py-2 px-4 rounded-lg transition duration-300 flex items-center space-x-2">
                        <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M19.54 6.04a13.27 13.27 0 00-2.66-1.89 12.4 12.4 0 00-1.6-1.3c-.4-.3-.82-.53-1.28-.71-.18-.07-.37-.13-.56-.19a.82.82 0 00-.5-.06 11.85 11.85 0 00-5.88 0 .82.82 0 00-.5.06c-.19.06-.38.12-.56.19-.46.18-.88.4-1.28.7a12.34 12.34 0 00-1.6 1.3A13.23 13.23 0 004.46 6.04 14.31 14.31 0 003 11.7c0 .1 0 .19.02.28a13.8 13.8 0 001.44 4.61c.56 1.1 1.24 2.1 2.04 3 .5.56 1.04 1.07 1.63 1.53.17.13.34.25.52.37a.8.8 0 00.57.19.78.78 0 00.57-.19 11.07 11.07 0 005.56 0 .78.78 0 00.57.19.8.8 0 00.57-.19c.18-.12.35-.24.52-.37a12.06 12.06 0 003.67-4.53 13.85 13.85 0 001.44-4.61c0-.1 0-.19.02-.28a14.31 14.31 0 00-1.46-5.66zm-4.61 7.03a1.93 1.93 0 01-3.86 0 1.93 1.93 0 013.86 0zm-5.72 0a1.93 1.93 0 01-3.86 0 1.93 1.93 0 013.86 0z"></path></svg>
                        <span>Login with Discord</span>
                    </a>
                    <a href="/#dashboard" id="user-info" class="hidden items-center space-x-3 hover:bg-slate-700/50 p-1.5 rounded-lg transition duration-200 cursor-pointer">
                        <img id="user-avatar" src="https://placehold.co/32x32/7f8c8d/ecf0f1?text=?" alt="User Avatar" class="w-8 h-8 rounded-full border-2 border-slate-600" onerror="this.src='https://placehold.co/32x32/7f8c8d/ecf0f1?text=?'">
                        <span id="user-name" class="text-white text-sm font-medium">Username</span>
                        <button id="logout-button" class="text-gray-400 hover:text-white text-xs font-medium bg-slate-600 hover:bg-slate-500 px-2 py-1 rounded-md transition duration-200">Logout</button>
                    </a>
                </div>
            </div>
            <div class="md:hidden">
                <button id="mobile-menu-button" class="text-gray-300 hover:text-white focus:outline-none">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7"></path></svg>
                </button>
            </div>
        </div>
        <div id="mobile-menu" class="hidden">
             <a href="/#home" class="mobile-menu-link">Home</a>
             <a href="/#products" class="mobile-menu-link">Products</a>
             <a href="/#tickets" class="mobile-menu-link">Tickets</a>
             <a href="https://discord.gg/shillette" target="_blank" rel="noopener noreferrer" class="mobile-menu-link">Discord</a>
             </div>
    </header>

    <main id="main-content" class="flex-grow page-section">
        <section class="relative text-center py-24 md:py-32 lg:py-40 overflow-hidden">
            <div class="container mx-auto px-6 relative z-10">
                <h1 class="text-4xl md:text-5xl lg:text-6xl font-extrabold text-white mb-4">Shillette</h1>
                <p class="text-xl md:text-2xl text-orange-400 mb-6 font-medium">Advanced DMA Firmware</p>
                <p class="max-w-2xl mx-auto text-gray-400 mb-10">
                    Fully undetected DMA firmware, battle-tested for reliable performance. Join thousands of satisfied users.
                </p>
                <div class="flex flex-col sm:flex-row justify-center items-center space-y-4 sm:space-y-0 sm:space-x-4 mb-16">
                    <a href="/#products" id="purchase-button" class="bg-orange-600 hover:bg-orange-700 text-white font-semibold py-3 px-8 rounded-lg transition duration-300 shadow-lg w-full sm:w-auto">
                        Purchase Product
                    </a>
                    <a href="https://discord.gg/shillette" target="_blank" rel="noopener noreferrer" class="bg-gray-700 hover:bg-gray-600 text-white font-semibold py-3 px-8 rounded-lg transition duration-300 shadow-lg w-full sm:w-auto flex items-center justify-center space-x-2">
                        <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M19.54 6.04a13.27 13.27 0 00-2.66-1.89 12.4 12.4 0 00-1.6-1.3c-.4-.3-.82-.53-1.28-.71-.18-.07-.37-.13-.56-.19a.82.82 0 00-.5-.06 11.85 11.85 0 00-5.88 0 .82.82 0 00-.5.06c-.19.06-.38.12-.56.19-.46.18-.88.4-1.28.7a12.34 12.34 0 00-1.6 1.3A13.23 13.23 0 004.46 6.04 14.31 14.31 0 003 11.7c0 .1 0 .19.02.28a13.8 13.8 0 001.44 4.61c.56 1.1 1.24 2.1 2.04 3 .5.56 1.04 1.07 1.63 1.53.17.13.34.25.52.37a.8.8 0 00.57.19.78.78 0 00.57-.19 11.07 11.07 0 005.56 0 .78.78 0 00.57.19.8.8 0 00.57-.19c.18-.12.35-.24.52-.37a12.06 12.06 0 003.67-4.53 13.85 13.85 0 001.44-4.61c0-.1 0-.19.02-.28a14.31 14.31 0 00-1.46-5.66zm-4.61 7.03a1.93 1.93 0 01-3.86 0 1.93 1.93 0 013.86 0zm-5.72 0a1.93 1.93 0 01-3.86 0 1.93 1.93 0 013.86 0z"></path></svg>
                        <span>Join Discord</span>
                    </a>
                </div>
                <div class="grid grid-cols-2 sm:grid-cols-4 gap-8 max-w-3xl mx-auto text-gray-400">
                    <div class="text-center">
                        <div class="text-3xl font-bold text-white mb-1">1000+</div>
                        <div>Happy Users</div>
                    </div>
                    <div class="text-center">
                        <div class="text-3xl font-bold text-white mb-1">1000+</div>
                        <div>Products Sold</div>
                    </div>
                    <div class="text-center">
                        <div class="text-3xl font-bold text-white mb-1">5.0</div>
                        <div>Star Rating</div>
                    </div>
                    <div class="text-center">
                        <div class="text-3xl font-bold text-white mb-1">3+</div>
                        <div>Years Experience</div>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <div id="products-page-content" class="hidden flex-grow container mx-auto px-6 py-10 page-section">
        <div class="flex justify-start mb-8">
             <a href="/#home" id="back-to-home-button-products" class="text-orange-400 hover:text-orange-300 flex items-center space-x-2 transition duration-200">
                 <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path></svg>
                 <span>Back to Home</span>
             </a>
        </div>
        <h2>Our Products</h2>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-8 max-w-5xl mx-auto">
            <div class="product-card card-gradient-border orange-border">
                <div class="flex justify-between items-center mb-4">
                    <span class="bg-orange-500/20 text-orange-300 text-xs font-semibold px-2.5 py-0.5 rounded">ALL IN ONE</span>
                    <div class="flex space-x-2 text-yellow-400">
                        <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"></path></svg>
                        <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path></svg>
                    </div>
                </div>
                <h3 class="text-xl font-semibold text-white mb-2">Shillette Firmware</h3>
                <p class="text-3xl font-bold text-white mb-4">From $100</p>
                <ul class="text-sm text-gray-400 space-y-2 mb-6 flex-grow">
                    <li class="flex items-center"><svg class="w-4 h-4 mr-2 text-green-500" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path></svg> Fully Undetected</li>
                    <li class="flex items-center"><svg class="w-4 h-4 mr-2 text-green-500" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path></svg> Easy Installation</li>
                    <li class="flex items-center"><svg class="w-4 h-4 mr-2 text-green-500" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path></svg> Full Support</li>
                    <li class="flex items-center"><svg class="w-4 h-4 mr-2 text-green-500" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path></svg> Lifetime Updates</li>
                </ul>
                <div class="mt-auto space-y-3 pt-4 border-t border-slate-700/50">
                     <button class="paypal-button" data-product-id="firmware-100">Pay with PayPal</button>
                     </div>
            </div>

            <div class="product-card card-gradient-border gray-border">
                 <div class="flex justify-between items-center mb-4">
                     <span class="bg-gray-500/20 text-gray-300 text-xs font-semibold px-2.5 py-0.5 rounded">SOFTWARE</span>
                     <div class="w-12 h-12 bg-gray-700 rounded flex items-center justify-center text-gray-400">
                          <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                      </div>
                 </div>
                 <h3 class="text-xl font-semibold text-white mb-2">Shillette Software</h3>
                 <p class="text-3xl font-bold text-white mb-4">From $3</p>
                 <ul class="text-sm text-gray-400 space-y-2 mb-6 flex-grow">
                     <li class="flex items-center"><svg class="w-4 h-4 mr-2 text-green-500" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path></svg> Feature Rich</li>
                     <li class="flex items-center"><svg class="w-4 h-4 mr-2 text-green-500" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path></svg> Highly Compatible</li>
                     <li class="flex items-center"><svg class="w-4 h-4 mr-2 text-green-500" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path></svg> Regular Updates</li>
                 </ul>
                  <div class="mt-auto space-y-3 pt-4 border-t border-slate-700/50">
                      <button class="paypal-button" data-product-id="software-3">Pay with PayPal</button>
                      </div>
            </div>
        </div>
    </div>

    <div id="dashboard-content" class="hidden flex-grow container mx-auto px-6 py-10 page-section">
        <h2>Dashboard</h2>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
            <div class="dashboard-card md:col-span-1">
                <h3 class="text-lg font-semibold text-white mb-4">Welcome!</h3>
                <div class="flex items-center space-x-4 mb-4">
                     <img id="dashboard-user-avatar" src="https://placehold.co/64x64/7f8c8d/ecf0f1?text=?" alt="User Avatar" class="w-16 h-16 rounded-full border-2 border-orange-500" onerror="this.src='https://placehold.co/64x64/7f8c8d/ecf0f1?text=?'">
                     <div>
                         <p id="dashboard-user-name" class="text-xl font-semibold text-white">Username</p>
                         <p class="text-sm text-gray-400">Status: Active</p> </div>
                </div>
                <button id="dashboard-logout-button" class="w-full bg-red-600 hover:bg-red-700 text-white text-sm font-medium py-2 px-4 rounded-lg transition duration-300">
                    Logout
                </button>
            </div>

            <div class="dashboard-card md:col-span-2">
                <h3 class="text-lg font-semibold text-white mb-4">My Products</h3>
                <p class="text-gray-400">Product information will appear here...</p>
                </div>

            <div class="dashboard-card md:col-span-1">
                <h3 class="text-lg font-semibold text-white mb-4">My Roles</h3>
                <div id="dashboard-user-roles" class="space-y-2 flex flex-wrap gap-1">
                    <p class="text-gray-400 text-sm w-full">Loading roles...</p>
                    </div>
            </div>

            <div class="dashboard-card md:col-span-2">
                 <h3 class="text-lg font-semibold text-white mb-4">Settings</h3>
                 <p class="text-gray-400">User settings will appear here...</p>
                 </div>
        </div>
    </div>

     <div id="tickets-page-content" class="hidden flex-grow container mx-auto px-6 py-10 page-section">
         <div class="flex justify-start mb-8">
             <a href="/#home" id="back-to-home-button-tickets" class="text-orange-400 hover:text-orange-300 flex items-center space-x-2 transition duration-200">
                 <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path></svg>
                 <span>Back to Home</span>
             </a>
         </div>
         <h2>Support Tickets</h2>

         <div id="moderator-management-view" class="hidden mb-8 ticket-card">
             <h3 class="text-xl font-semibold text-white mb-4 border-b border-slate-700 pb-2">Ticket Management</h3>
             <details class="mb-6" open> <summary>Active Tickets</summary>
                 <div id="moderator-active-ticket-list" class="ticket-list-container mt-3">
                     </div>
                 <p id="moderator-active-list-status" class="text-sm text-gray-500 mt-4">Loading active tickets...</p>
             </details>

             <details> <summary>Archived Tickets</summary>
                 <div id="moderator-archived-ticket-list" class="ticket-list-container mt-3">
                     </div>
                 <p id="moderator-archived-list-status" class="text-sm text-gray-500 mt-4">Loading archived tickets...</p>
             </details>
         </div>

         <div id="user-ticket-view" class="mb-8 ticket-card">
             <h3 class="text-xl font-semibold text-white mb-4">My Tickets</h3>
             <div id="ticket-list" class="ticket-list-container">
                 </div>
             <p id="ticket-list-status" class="text-sm text-gray-500 mt-4">Loading tickets...</p>
         </div>

         <div class="ticket-card">
             <h3 class="text-xl font-semibold text-white mb-4">Create New Ticket</h3>
             <form id="create-ticket-form" novalidate>
                 <div class="mb-4">
                     <label for="ticket-subject" class="block text-sm font-medium text-gray-300 mb-1">Subject</label>
                     <input type="text" id="ticket-subject" name="ticket-subject" required class="w-full bg-slate-700 border border-slate-600 rounded-md py-2 px-3 text-white focus:outline-none focus:ring-2 focus:ring-orange-500 focus:border-transparent placeholder-gray-500">
                 </div>
                 <div class="mb-4">
                     <label for="ticket-message-input" class="block text-sm font-medium text-gray-300 mb-1">Message</label>
                     <textarea id="ticket-message-input" name="ticket-message-input" rows="6" required class="w-full bg-slate-700 border border-slate-600 rounded-md py-2 px-3 text-white focus:outline-none focus:ring-2 focus:ring-orange-500 focus:border-transparent placeholder-gray-500"></textarea>
                 </div>
                 <div id="create-ticket-status" class="h-6"></div> <button type="submit" id="create-ticket-button" class="w-full bg-orange-600 hover:bg-orange-700 text-white font-medium py-2.5 px-6 rounded-lg transition duration-300">
                     Submit Ticket
                 </button>
             </form>
         </div>
     </div>

     <div id="ticket-detail-content" class="hidden flex-grow container mx-auto px-6 py-10 page-section">
         <div class="flex justify-start mb-8">
             <a href="/#tickets" id="back-to-tickets-button" class="text-orange-400 hover:text-orange-300 flex items-center space-x-2 transition duration-200">
                 <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path></svg>
                 <span>Back to Tickets</span>
             </a>
         </div>
         <h2 id="ticket-detail-subject">Ticket Subject</h2>
         <div class="ticket-card">
             <div id="chat-messages">
                 <p class="text-gray-500 text-center py-4">Loading chat...</p>
                 </div>
             <form id="chat-input-form" class="mt-4" novalidate>
                 <input type="text" id="chat-input" placeholder="Type your message..." required class="w-full">
                 <button type="submit" id="send-chat-button">Send</button>
             </form>
         </div>
     </div>


    <footer class="bg-black mt-auto py-6 border-t border-gray-800">
        <div class="container mx-auto px-6 text-center text-gray-500 text-sm">
            <p>&copy; 2025 Shillette. All rights reserved.</p>
            </div>
    </footer>

    <script>
        // --- DOM Element References ---
        const pageSections = {
            '#home': document.getElementById('main-content'),
            '#products': document.getElementById('products-page-content'),
            '#tickets': document.getElementById('tickets-page-content'),
            '#dashboard': document.getElementById('dashboard-content'),
            '#ticketDetail': document.getElementById('ticket-detail-content')
        };
        const loginButton = document.getElementById('login-button');
        const logoutButton = document.getElementById('logout-button');
        const dashboardLogoutButton = document.getElementById('dashboard-logout-button');
        const userInfo = document.getElementById('user-info');
        const userNameDisplay = document.getElementById('user-name');
        const userAvatarDisplay = document.getElementById('user-avatar');
        const dashboardUserNameDisplay = document.getElementById('dashboard-user-name');
        const dashboardUserAvatarDisplay = document.getElementById('dashboard-user-avatar');
        const snowContainer = document.getElementById('snow-container');
        const paymentMessage = document.getElementById('payment-message');
        const ticketMessagePopup = document.getElementById('ticket-message');
        const errorMessagePopup = document.getElementById('error-message');
        const loadingOverlay = document.getElementById('loading-overlay');
        const createTicketForm = document.getElementById('create-ticket-form');
        const ticketSubjectInput = document.getElementById('ticket-subject');
        const ticketMessageInput = document.getElementById('ticket-message-input');
        const createTicketStatus = document.getElementById('create-ticket-status');
        // Ticket List Views
        const userTicketView = document.getElementById('user-ticket-view');
        const moderatorManagementView = document.getElementById('moderator-management-view'); // New container for mod view
        const ticketListDiv = document.getElementById('ticket-list');
        const ticketListStatus = document.getElementById('ticket-list-status');
        const moderatorActiveTicketListDiv = document.getElementById('moderator-active-ticket-list');
        const moderatorActiveListStatus = document.getElementById('moderator-active-list-status');
        const moderatorArchivedTicketListDiv = document.getElementById('moderator-archived-ticket-list');
        const moderatorArchivedListStatus = document.getElementById('moderator-archived-list-status');
        // Ticket Detail
        const ticketDetailSubject = document.getElementById('ticket-detail-subject');
        const chatMessagesDiv = document.getElementById('chat-messages');
        const chatInputForm = document.getElementById('chat-input-form');
        const chatInput = document.getElementById('chat-input');
        const sendChatButton = document.getElementById('send-chat-button');
        const dashboardUserRolesContainer = document.getElementById('dashboard-user-roles');
        const backToTicketsButton = document.getElementById('back-to-tickets-button'); // Added reference
        // Modal & Context Menus
        const userInfoModal = document.getElementById('user-info-modal');
        const modalCloseButton = document.getElementById('modal-close-button');
        const modalUsername = document.getElementById('modal-username');
        const modalUserId = document.getElementById('modal-user-id');
        const modalUserRoles = document.getElementById('modal-user-roles');
        const chatContextMenu = document.getElementById('chat-context-menu');
        const contextDeleteButton = document.getElementById('context-delete-message');
        const contextUserInfoButton = document.getElementById('context-user-info');
        const ticketContextMenu = document.getElementById('ticket-context-menu');
        const contextCloseTicketButton = document.getElementById('context-close-ticket');
        const contextReopenTicketButton = document.getElementById('context-reopen-ticket');
        const contextDeleteTicketButton = document.getElementById('context-delete-ticket'); // Added delete ticket button
        const mobileMenuButton = document.getElementById('mobile-menu-button'); // Added mobile menu button
        const mobileMenu = document.getElementById('mobile-menu'); // Added mobile menu div


        // --- Configuration ---
        const API_BASE_URL = 'https://api.shillette.com';
        const SOCKET_URL = 'https://api.shillette.com';

        // --- State Variables ---
        let currentUser = null;
        let socket = null;
        let currentTicketId = null;
        let activeSectionId = null;
        let currentContextMenu = null; // Track which context menu is active
        let contextMenuData = { ticketId: null, messageTimestamp: null, senderId: null, ticketStatus: null }; // Combined context data


        // --- Utility Functions ---

        /**
         * Shows a temporary pop-up message at the bottom of the screen.
         * @param {HTMLElement} element - The pop-up element (e.g., paymentMessage, errorMessagePopup).
         * @param {string} message - The message to display.
         * @param {boolean} [isError=false] - If true, styles the pop-up as an error.
         */
        function showPopupMessage(element, message, isError = false) {
             if (!element) return;
             element.textContent = message;
             if (isError) {
                 element.classList.remove('bg-green-600');
                 element.classList.add('bg-red-600');
             } else {
                 element.classList.remove('bg-red-600');
                 element.classList.add('bg-green-600');
             }
             element.classList.add('show');
             setTimeout(() => {
                 element.classList.remove('show');
             }, 3500); // Hide after 3.5 seconds
        }

        /**
         * Updates the header UI based on the user's login status.
         * Shows/hides login button vs user info/logout button.
         * Updates username and avatar.
         * @param {object|null} user - The current user object or null if logged out.
         */
        function updateHeaderUI(user) {
             if (user && user.logged_in) {
                 loginButton.classList.add('hidden');
                 userInfo.classList.remove('hidden');
                 userInfo.classList.add('flex'); // Ensure flex display
                 userNameDisplay.textContent = user.username || 'User';
                 if (user.user_id && user.avatar) {
                     userAvatarDisplay.src = `https://cdn.discordapp.com/avatars/${user.user_id}/${user.avatar}.png?size=32`;
                 } else {
                     userAvatarDisplay.src = 'https://placehold.co/32x32/7f8c8d/ecf0f1?text=?'; // Placeholder
                 }
                 // Update dashboard elements as well
                 dashboardUserNameDisplay.textContent = user.username || 'User';
                 if (user.user_id && user.avatar) {
                    dashboardUserAvatarDisplay.src = `https://cdn.discordapp.com/avatars/${user.user_id}/${user.avatar}.png?size=64`;
                 } else {
                    dashboardUserAvatarDisplay.src = 'https://placehold.co/64x64/7f8c8d/ecf0f1?text=?';
                 }
             } else {
                 loginButton.classList.remove('hidden');
                 userInfo.classList.add('hidden');
                 userInfo.classList.remove('flex');
                 // Clear dashboard user info if logged out
                 dashboardUserNameDisplay.textContent = 'User';
                 dashboardUserAvatarDisplay.src = 'https://placehold.co/64x64/7f8c8d/ecf0f1?text=?';
             }
        }

        /**
         * Hides all page sections and shows the specified one.
         * Handles socket disconnection/connection based on the target section.
         * @param {string} sectionId - The ID of the section to show (e.g., '#home', '#tickets').
         */
        function showSection(sectionId) {
            console.log(`[showSection] Attempting to show: ${sectionId}`);
            hideContextMenu(); // Hide context menu when changing sections

            // Hide all sections first
            Object.keys(pageSections).forEach(key => {
                const sectionElement = pageSections[key];
                if (sectionElement) {
                    sectionElement.classList.add('hidden');
                } else {
                    console.warn(`[showSection] Element not found for key: ${key}`);
                }
            });


            // Show the target section
            const sectionElement = pageSections[sectionId];
            if (sectionElement) {
                sectionElement.classList.remove('hidden');
                activeSectionId = sectionId; // Update the active section ID
                console.log(`[showSection] Successfully shown: ${sectionId}`);
            } else {
                console.warn(`[showSection] Target element not found for ID: ${sectionId}. Defaulting to #home.`);
                // Default to home if target not found
                if (pageSections['#home']) {
                    pageSections['#home'].classList.remove('hidden');
                    activeSectionId = '#home';
                    console.log(`[showSection] Defaulted to #home.`);
                } else {
                     activeSectionId = null; // Or handle error appropriately
                     console.error("[showSection] Could not find #home element either!");
                }
            }

             // Disconnect socket ONLY if navigating away from ticket detail AND tickets list
             if (sectionId !== '#ticketDetail' && sectionId !== '#tickets') {
                 console.log(`[showSection] Navigating away from tickets/detail, disconnecting socket.`);
                 disconnectSocket(); // Disconnect if not on tickets or detail page
             }
             // Clear currentTicketId if not on detail page
             if (sectionId !== '#ticketDetail') {
                 currentTicketId = null;
             }
        }

        /**
         * Handles navigation based on URL hash changes.
         * Checks for protected routes and user login status.
         * Fetches necessary data for the target section (tickets, ticket details).
         * @param {string} hash - The URL hash (e.g., '#home', '/#tickets', '/#ticketDetail?id=123').
         * @param {object|null} [ticketData=null] - Optional pre-fetched ticket data (id, subject) for direct navigation.
         */
        function navigateTo(hash, ticketData = null) {
            console.log(`[navigateTo] Received hash: ${hash}`);
            // Handle hashes starting with /# or just #
            const cleanHash = hash.startsWith('/#') ? hash.substring(1) : (hash.startsWith('#') ? hash : '#home');
            const baseHash = cleanHash.split('?')[0] || '#home';
            const targetSectionId = pageSections[baseHash] ? baseHash : '#home'; // Default to #home if baseHash is invalid

            console.log(`[navigateTo] Cleaned hash: ${cleanHash}, Base hash: ${baseHash}, Target section: ${targetSectionId}`);

            const isProtected = ['#dashboard', '#tickets', '#ticketDetail'].includes(targetSectionId);
            console.log(`[navigateTo] Is protected: ${isProtected}, User logged in: ${currentUser?.logged_in}`);
            if (isProtected && (!currentUser || !currentUser.logged_in)) {
                console.log(`[navigateTo] Access denied to protected route: ${targetSectionId}`);
                showPopupMessage(errorMessagePopup, "Please log in to view this page.", true);
                // Redirect to home only if not already there
                if (window.location.hash !== '#home' && window.location.hash !== '/#home') {
                    console.log(`[navigateTo] Redirecting to /#home`);
                    window.location.hash = '/#home'; // Navigate to /#home
                } else {
                    console.log(`[navigateTo] Already on home, showing #home section.`);
                    showSection('#home'); // Explicitly show home if already on #home but logged out
                }
                return;
            }

            // Ensure socket is connected if navigating to a protected/socket-requiring page
            if (isProtected && currentUser && currentUser.logged_in) {
                console.log(`[navigateTo] Ensuring socket is connected for route: ${targetSectionId}`);
                ensureSocketConnected();
            }

            // Handle Ticket Detail specific logic
            if (targetSectionId === '#ticketDetail') {
                let id = null;
                let subject = null;
                if (ticketData) { // Prioritize passed data
                    id = ticketData.id;
                    subject = ticketData.subject;
                } else { // Fallback to URL params
                    const params = new URLSearchParams(cleanHash.split('?')[1] || '');
                    id = params.get('id');
                    // Subject might not be in URL, fetchTicketDetails will get it
                }
                console.log(`[navigateTo] Ticket Detail - ID: ${id}, Subject (initial): ${subject}`);

                if (id) {
                    currentTicketId = id; // Set currentTicketId *before* fetching
                    ticketDetailSubject.textContent = subject || `Ticket #${id.slice(-6)}`; // Set initial subject
                    chatMessagesDiv.innerHTML = '<p class="text-gray-500 text-center py-4">Connecting to chat...</p>'; // Loading state
                    // Fetch full ticket details including messages and update subject if needed
                    fetchTicketDetails(id); // This fetches details AND connects socket + joins room
                } else {
                    console.warn("[navigateTo] Ticket ID missing for detail view. Redirecting to tickets list.");
                    showPopupMessage(errorMessagePopup, "Invalid ticket link.", true);
                    window.location.hash = '/#tickets'; // Navigate to /#tickets
                    return; // Stop further execution for this invalid navigation
                }
            }

            // Show the correct section *after* handling potential redirects or data loading setup
            showSection(targetSectionId);
            localStorage.setItem('currentPage', targetSectionId); // Store the base hash

            // Fetch data if needed for the newly shown section
            if (targetSectionId === '#tickets') {
                console.log(`[navigateTo] Fetching tickets for #tickets view.`);
                fetchTickets(); // Handles mod/user view logic
            }
            if (targetSectionId === '#dashboard' && currentUser && currentUser.logged_in) {
                displayUserRoles(currentUser.roles); // Display roles on dashboard
            }

            updateHeaderUI(currentUser); // Update header based on login status
        }

        /**
         * Runs the navigation logic based on the current URL hash.
         * Called on initial load and hash changes.
         */
        function runNavigation() {
            console.log(`[runNavigation] Hash changed to: ${window.location.hash}`);
            // Use cleanHash logic here too for initial load / direct navigation
            const cleanHash = window.location.hash.startsWith('/#') ? window.location.hash.substring(1) : window.location.hash;
            const hashToNavigate = cleanHash || '#home'; // Default to #home if hash is empty
            console.log(`[runNavigation] Navigating to: ${hashToNavigate}`);
            navigateTo(hashToNavigate); // Use the cleaned hash or default
        }

        /**
         * Creates and appends snowflake elements for the background effect.
         */
        function createSnowflakes() {
            const numberOfSnowflakes = 75;
            if (!snowContainer) return;
            snowContainer.innerHTML = ''; // Clear existing snowflakes
            for (let i = 0; i < numberOfSnowflakes; i++) {
                const snowflake = document.createElement('div');
                snowflake.classList.add('snowflake');
                const size = Math.random() * 3 + 2; // Size between 2px and 5px
                const duration = Math.random() * 10 + 5; // Duration between 5s and 15s
                const delay = Math.random() * 10; // Delay up to 10s
                const startLeft = Math.random() * 100; // Start anywhere horizontally
                const opacity = Math.random() * 0.5 + 0.5; // Opacity between 0.5 and 1.0

                snowflake.style.width = `${size}px`;
                snowflake.style.height = `${size}px`;
                snowflake.style.left = `${startLeft}vw`;
                snowflake.style.opacity = opacity;
                snowflake.style.animationDuration = `${duration}s`;
                snowflake.style.animationDelay = `-${delay}s`; // Negative delay starts animation partway through

                snowContainer.appendChild(snowflake);
            }
        }

        /**
         * Checks the user's login status via the API and then triggers navigation.
         * Connects the socket if the user is logged in.
         */
        async function checkLoginStatusAndNavigate() {
             try {
                 // Use credentials: 'include' to send cookies
                 const response = await fetch(`${API_BASE_URL}/api/user`, { credentials: 'include' });
                 if (!response.ok) {
                     if (response.status === 401 || response.status === 403) {
                         // Not logged in or unauthorized
                         currentUser = { logged_in: false };
                     } else {
                         // Other server error
                         throw new Error(`HTTP error! status: ${response.status}`);
                     }
                 } else {
                     // Logged in, store user data
                     currentUser = await response.json();
                 }
                 console.log("[checkLoginStatusAndNavigate] User status checked:", currentUser);

                 // Connect socket if user is logged in (needed for ticket list actions, etc.)
                 if (currentUser && currentUser.logged_in) {
                     console.log("[checkLoginStatusAndNavigate] User logged in, ensuring socket connection.");
                     ensureSocketConnected();
                 }

             } catch (error) {
                 console.error("[checkLoginStatusAndNavigate] Error checking login status:", error);
                 currentUser = { logged_in: false }; // Assume logged out on error
                 showPopupMessage(errorMessagePopup, "Could not verify login status.", true);
             } finally {
                 // Run navigation AFTER checking login status
                 runNavigation();
             }
        }

        /**
         * Fetches the list of tickets (either user's or all, based on role)
         * and populates the appropriate list(s) in the UI.
         * Adds event listeners for clicking and right-clicking ticket items.
         */
        async function fetchTickets() {
            console.log("[fetchTickets] Starting to fetch tickets...");
            // Ensure elements exist before proceeding
            if (!userTicketView || !moderatorManagementView || !ticketListDiv || !ticketListStatus || !moderatorActiveTicketListDiv || !moderatorActiveListStatus || !moderatorArchivedTicketListDiv || !moderatorArchivedListStatus) {
                console.error("[fetchTickets] One or more ticket list elements not found.");
                return;
            }

            if (!currentUser || !currentUser.logged_in) {
                console.log("[fetchTickets] User not logged in.");
                ticketListStatus.textContent = "Please log in to view tickets.";
                moderatorActiveListStatus.textContent = "Please log in to view tickets.";
                moderatorArchivedListStatus.textContent = "Please log in to view tickets.";
                ticketListDiv.innerHTML = '';
                moderatorActiveTicketListDiv.innerHTML = '';
                moderatorArchivedTicketListDiv.innerHTML = '';
                userTicketView.classList.remove('hidden'); // Show user view placeholder if logged out
                moderatorManagementView.classList.add('hidden'); // Hide mod view
                return;
            }

            // Show loading states
            ticketListStatus.textContent = "Loading tickets...";
            moderatorActiveListStatus.textContent = "Loading active tickets...";
            moderatorArchivedListStatus.textContent = "Loading archived tickets...";
            ticketListDiv.innerHTML = '';
            moderatorActiveTicketListDiv.innerHTML = '';
            moderatorArchivedTicketListDiv.innerHTML = '';

            // Determine view based on moderator status
            const isModerator = currentUser.is_moderator;
            console.log(`[fetchTickets] Is moderator: ${isModerator}`);
            if (isModerator) {
                userTicketView.classList.add('hidden'); // Hide user list container
                moderatorManagementView.classList.remove('hidden'); // Show the dedicated mod management view
            } else {
                userTicketView.classList.remove('hidden'); // Show user list container
                moderatorManagementView.classList.add('hidden'); // Hide mod view
            }

            try {
                const response = await fetch(`${API_BASE_URL}/api/tickets`, { credentials: 'include' });
                if (!response.ok) {
                     if (response.status === 401 || response.status === 403) throw new Error("Authentication required.");
                     else throw new Error(`HTTP error! status: ${response.status}`);
                }
                const tickets = await response.json();
                console.log(`[fetchTickets] Received ${tickets.length} tickets.`);

                // Clear loading messages
                ticketListStatus.textContent = "";
                moderatorActiveListStatus.textContent = "";
                moderatorArchivedListStatus.textContent = "";

                let hasActive = false;
                let hasArchived = false;

                if (tickets.length === 0) {
                    if (isModerator) {
                        moderatorActiveListStatus.textContent = "No active tickets found.";
                        moderatorArchivedListStatus.textContent = "No archived tickets found.";
                    } else {
                        ticketListStatus.textContent = "You have no support tickets.";
                    }
                } else {
                    // Sort tickets by creation date, newest first
                    tickets.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));

                    tickets.forEach(ticket => {
                        const item = document.createElement('div');
                        item.classList.add('ticket-list-item');
                        // Add data attributes for context menu and navigation
                        item.dataset.ticketId = ticket._id;
                        item.dataset.ticketStatus = ticket.status;
                        item.dataset.ticketSubject = ticket.subject || 'No Subject'; // Store subject

                        const statusClass = ticket.status === 'open' ? 'status-open' : 'status-closed';
                        const statusText = ticket.status ? ticket.status.charAt(0).toUpperCase() + ticket.status.slice(1) : 'N/A';
                        const dateOpened = ticket.created_at ? new Date(ticket.created_at).toLocaleDateString() : 'N/A';
                        const ticketId = ticket._id || 'N/A';
                        const subject = ticket.subject || 'No Subject';
                        const shortId = ticketId !== 'N/A' ? ticketId.slice(-6) : 'N/A';
                        const username = ticket.username || 'Unknown User'; // Display username for mods

                        item.innerHTML = `
                            <div>
                                <p class="font-medium text-white">#${shortId}: ${subject}</p>
                                <p class="text-xs text-gray-400">User: ${username} | Opened: ${dateOpened}</p>
                            </div>
                            <span class="${statusClass}">${statusText}</span>`;

                        // Click to navigate (using updated format and passing data)
                        item.addEventListener('click', () => {
                             console.log(`[fetchTickets] Ticket item clicked: ID=${ticketId}`);
                             // Use navigateTo, passing ticket data for faster initial display
                             navigateTo(`/#ticketDetail?id=${ticketId}`, { id: ticketId, subject: subject });
                        });

                        // Right-click for context menu
                        item.addEventListener('contextmenu', showTicketContextMenu);


                        // Append to the correct list (user or moderator active/archived)
                        if (isModerator) {
                            if (ticket.status === 'open') {
                                moderatorActiveTicketListDiv.appendChild(item);
                                hasActive = true;
                            } else {
                                moderatorArchivedTicketListDiv.appendChild(item);
                                hasArchived = true;
                            }
                        } else {
                            ticketListDiv.appendChild(item);
                        }
                    });

                    // Update status messages if lists ended up empty after filtering
                    if (isModerator) {
                        if (!hasActive) moderatorActiveListStatus.textContent = "No active tickets found.";
                        if (!hasArchived) moderatorArchivedListStatus.textContent = "No archived tickets found.";
                    }
                }
            } catch (error) {
                console.error("[fetchTickets] Error fetching tickets:", error);
                const errorMsg = `Failed to load tickets: ${error.message}`;
                ticketListStatus.textContent = errorMsg;
                moderatorActiveListStatus.textContent = errorMsg;
                moderatorArchivedListStatus.textContent = errorMsg;
                showPopupMessage(errorMessagePopup, `Error fetching tickets: ${error.message}`, true);
            }
        }

        /**
         * Fetches the full details for a specific ticket, including its messages.
         * Populates the chat area and joins the corresponding socket room.
         * **Updates the "Back to Tickets" button href.**
         * @param {string} ticketId - The ID of the ticket to fetch.
         */
        async function fetchTicketDetails(ticketId) {
             console.log(`[fetchTicketDetails] Fetching details for ticket: ${ticketId}`);
             if (!currentUser || !currentUser.logged_in) return; // Should be caught by navigateTo, but double-check
             // Ensure socket is connected before fetching details that might need it soon
             ensureSocketConnected();
             chatMessagesDiv.innerHTML = '<p class="text-gray-500 text-center py-4">Loading messages...</p>'; // Loading state

             // **MODIFICATION**: Ensure the back button points to the ticket list
             if (backToTicketsButton) {
                backToTicketsButton.href = '/#tickets'; // Set href correctly
             } else {
                console.warn("[fetchTicketDetails] Back to Tickets button not found.");
             }


             try {
                 const response = await fetch(`${API_BASE_URL}/api/tickets/${ticketId}`, { credentials: 'include' });
                 if (!response.ok) {
                     if (response.status === 401 || response.status === 403) throw new Error("Forbidden or Not Authenticated.");
                     if (response.status === 404) throw new Error("Ticket not found.");
                     throw new Error(`HTTP error! status: ${response.status}`);
                 }
                 const ticket = await response.json();
                 console.log(`[fetchTicketDetails] Received details for ticket: ${ticketId}`);

                 // Update the page title with the fetched subject
                 ticketDetailSubject.textContent = ticket.subject || `Ticket #${ticketId.slice(-6)}`;

                 // Clear loading message
                 chatMessagesDiv.innerHTML = '';

                 // Populate chat messages
                 if (ticket.messages && ticket.messages.length > 0) {
                     // Sort messages by timestamp, oldest first
                     ticket.messages.sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
                     ticket.messages.forEach(appendChatMessage);
                 } else {
                     chatMessagesDiv.innerHTML = '<p class="text-gray-500 text-center py-4">No messages in this ticket yet.</p>';
                 }

                 // Join the specific ticket room now that we're viewing details
                 if (socket && socket.connected) {
                     console.log(`[fetchTicketDetails] Emitting join_ticket_room for: ${ticketId}`);
                     socket.emit('join_ticket_room', { ticket_id: ticketId });
                 } else {
                     console.warn("[fetchTicketDetails] Socket not connected when trying to join room.");
                     // Optionally try to connect again here, or rely on ensureSocketConnected
                 }

             } catch (error) {
                 console.error("[fetchTicketDetails] Error fetching ticket details:", error);
                 chatMessagesDiv.innerHTML = `<p class="text-red-400 text-center py-4">Error loading messages: ${error.message}</p>`;
                 showPopupMessage(errorMessagePopup, `Error loading ticket: ${error.message}`, true);
                 // Optionally redirect back to tickets list on error
                 // window.location.hash = '/#tickets';
             }
        }

        /**
         * Appends a chat message to the chat display area.
         * Handles potential differences in data structure (DB vs. socket).
         * Makes usernames clickable to show user info modal.
         * @param {object} data - The message data object.
         */
        function appendChatMessage(data) {
             if (!chatMessagesDiv) return;
             // Remove initial "Loading..." or "No messages..." paragraphs if present
             const placeholderMsg = chatMessagesDiv.querySelector('p.text-gray-500, p.text-red-400');
             if (placeholderMsg) placeholderMsg.remove();

             const messageElement = document.createElement('div');
             messageElement.classList.add('chat-message');
             messageElement.dataset.timestamp = data.timestamp; // Store ISO timestamp for deletion reference
             messageElement.dataset.senderId = data.sender_id; // Store sender ID for user info modal

             const timestamp = data.timestamp ? new Date(data.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) : '';
             // Use sender_username (from DB/HTTP fetch) or username (from socket event)
             const username = data.sender_username || data.username || 'System';
             const safeUsername = username.replace(/</g, "&lt;").replace(/>/g, "&gt;"); // Basic sanitization
             const safeText = (data.text || '').replace(/</g, "&lt;").replace(/>/g, "&gt;"); // Basic sanitization

             // Create clickable username span
             const usernameSpan = document.createElement('span');
             usernameSpan.classList.add('username');
             usernameSpan.textContent = `${safeUsername}:`;
             // Use sender_id from the message data for the modal
             usernameSpan.addEventListener('click', () => showUserInfoModal(data.sender_id, safeUsername));

             messageElement.appendChild(usernameSpan);
             messageElement.append(` ${safeText} `); // Append text content after username

             // Create timestamp span
             const timestampSpan = document.createElement('span');
             timestampSpan.classList.add('timestamp');
             timestampSpan.textContent = timestamp;
             messageElement.appendChild(timestampSpan);

             // Add context menu listener for moderators
             if (currentUser && currentUser.is_moderator) {
                messageElement.addEventListener('contextmenu', showChatContextMenu);
             }


             chatMessagesDiv.appendChild(messageElement);
             // Scroll to the bottom to show the new message
             chatMessagesDiv.scrollTop = chatMessagesDiv.scrollHeight;
        }

        /**
         * Establishes a WebSocket connection if not already connected.
         * Sets up basic event listeners (connect, disconnect, error).
         * @param {string|null} [ticketIdToJoin=null] - Optional ticket ID to join immediately upon connection.
         */
        function connectSocket(ticketIdToJoin = null) {
            if (socket && socket.connected) {
                // If already connected and a ticketId is provided for the *current* view, join that room
                if (ticketIdToJoin && currentTicketId === ticketIdToJoin) {
                    console.log(`[connectSocket] Socket already connected, joining room: ${ticketIdToJoin}`);
                    socket.emit('join_ticket_room', { ticket_id: ticketIdToJoin });
                } else {
                    console.log(`[connectSocket] Socket already connected, not joining room ${ticketIdToJoin || 'N/A'}.`);
                }
                return; // Already connected
            }

            console.log(`[connectSocket] Attempting to connect WebSocket... (Potential room join: ${ticketIdToJoin || 'none'})`);
            socket = io(SOCKET_URL, {
                reconnectionAttempts: 3, // Limit reconnection attempts
                withCredentials: true // Send cookies with the connection request
            });

            socket.on('connect', () => {
                console.log('[connectSocket] WebSocket connected:', socket.id);
                // If a ticketId was specified during connection attempt and it's still the current view, join its room now
                if (ticketIdToJoin && currentTicketId === ticketIdToJoin) {
                    console.log(`[connectSocket] Joining room post-connect: ${ticketIdToJoin}`);
                    socket.emit('join_ticket_room', { ticket_id: ticketIdToJoin });
                }
                // Add other event listeners only once after connection
                setupSocketListeners();
            });

            socket.on('disconnect', (reason) => {
                console.log('[connectSocket] WebSocket disconnected:', reason);
                socket = null; // Clear socket object on disconnect
                // Optionally show a message to the user
                // showPopupMessage(errorMessagePopup, "Chat disconnected.", true);
            });

            socket.on('connect_error', (error) => {
                console.error('[connectSocket] WebSocket connection error:', error);
                showPopupMessage(errorMessagePopup, "Chat connection failed.", true);
                socket = null; // Clear socket object on error
            });
        }

        /**
         * Helper function to ensure the WebSocket is connected.
         * Calls connectSocket() if needed.
         */
        function ensureSocketConnected() {
             if (!socket || !socket.connected) {
                 console.log("[ensureSocketConnected] Socket not connected, attempting connection...");
                 connectSocket(); // Connect without joining a specific room initially
             } else {
                 console.log("[ensureSocketConnected] Socket already connected.");
             }
        }


        /**
         * Sets up all necessary WebSocket event listeners.
         * Removes old listeners first to prevent duplicates if called multiple times.
         */
        function setupSocketListeners() {
             if (!socket) return;
             console.log("[setupSocketListeners] Setting up listeners.");
             // Remove potential old listeners before adding new ones to prevent duplicates
             socket.off('new_message');
             socket.off('room_joined');
             socket.off('error_message');
             socket.off('message_deleted');
             socket.off('ticket_status_updated');
             socket.off('ticket_list_updated');
             socket.off('action_success');

             // Add listeners
             socket.on('new_message', (data) => {
                 console.log("[Socket Listener] Received new_message:", data);
                 // **FIX**: Ensure sender_id is populated for messages sent by the current user
                 // Backend should ideally send sender_id, but this is a fallback
                 if (!data.sender_id && data.username === currentUser?.username) {
                     data.sender_id = currentUser.user_id;
                 }
                 // Only append if the message belongs to the currently viewed ticket
                 if (data.ticket_id === currentTicketId) {
                     appendChatMessage(data);
                 }
             });
             socket.on('room_joined', (data) => {
                 console.log('[Socket Listener] Joined room:', data.room);
                 // Can update UI to confirm connection if needed
             });
             socket.on('error_message', (data) => {
                 console.error('[Socket Listener] WebSocket server error:', data.message);
                 showPopupMessage(errorMessagePopup, data.message || 'Chat error.', true);
             });
             socket.on('message_deleted', (data) => {
                 console.log("[Socket Listener] Received message_deleted:", data);
                 if (data.ticket_id === currentTicketId) {
                     // Find the message element using the timestamp data attribute
                     const messageToRemove = chatMessagesDiv.querySelector(`.chat-message[data-timestamp="${data.timestamp}"]`);
                     if (messageToRemove) {
                         messageToRemove.remove();
                         console.log(`[Socket Listener] Removed message with timestamp: ${data.timestamp}`);
                         // Optionally add a placeholder like "[Message Deleted]"
                     }
                 }
             });
             socket.on('ticket_status_updated', (data) => {
                  console.log("[Socket Listener] Received ticket_status_updated:", data);
                  // If the user is currently viewing the tickets list, refresh it
                  if (activeSectionId === '#tickets') {
                      console.log(`[Socket Listener] Ticket ${data.ticket_id} status updated to ${data.status}. Refreshing list.`);
                      fetchTickets(); // Refresh the list to show the change
                  }
                  // If the user is viewing the specific ticket that was updated, maybe show a notification?
                  if (data.ticket_id === currentTicketId) {
                      showPopupMessage(ticketMessagePopup, `Ticket status updated to ${data.status}.`);
                      // Update context menu data if the ticket item is visible (though unlikely here)
                      const ticketItem = document.querySelector(`.ticket-list-item[data-ticket-id="${data.ticket_id}"]`);
                      if(ticketItem) ticketItem.dataset.ticketStatus = data.status;
                  }
             });
             // Listener for when a ticket is deleted entirely
              socket.on('ticket_list_updated', () => {
                  console.log("[Socket Listener] Received ticket_list_updated (likely due to deletion).");
                  // If the user is currently viewing the tickets list, refresh it
                  if (activeSectionId === '#tickets') {
                      console.log("[Socket Listener] Refreshing ticket list.");
                      fetchTickets();
                  }
                  // If the user was viewing the ticket that got deleted, redirect them
                  if (currentTicketId && !document.querySelector(`.ticket-list-item[data-ticket-id="${currentTicketId}"]`)) {
                      // Check if the currentTicketId still exists in the DOM after refresh might be complex.
                      // A simpler approach might be needed if the backend confirms deletion differently.
                      // For now, we rely on the list refresh. If viewing the deleted ticket, maybe redirect?
                      // This part needs careful handling based on backend signals.
                  }
              });
             socket.on('action_success', (data) => {
                  console.log("[Socket Listener] Received action_success:", data);
                  showPopupMessage(paymentMessage, data.message || 'Action successful.'); // Use success popup
             });
        }


        /**
         * Disconnects the WebSocket connection if it exists.
         */
        function disconnectSocket() {
            if (socket) {
                console.log('[disconnectSocket] Disconnecting WebSocket...');
                socket.disconnect();
                socket = null; // Clear the socket variable
            }
        }

        /**
         * Displays the user's Discord roles in the specified container.
         * Styles roles based on their color.
         * @param {Array} roles - An array of role objects (from Discord API).
         */
        function displayUserRoles(roles) {
            const rolesContainer = document.getElementById('dashboard-user-roles'); // Target dashboard container
            if (!rolesContainer) return;
            rolesContainer.innerHTML = ''; // Clear previous roles
            if (roles && roles.length > 0) {
                // Sort roles by position (descending, highest role first)
                roles.sort((a, b) => b.position - a.position);

                roles.forEach(role => {
                    const roleElement = document.createElement('span');
                    roleElement.classList.add('px-2', 'py-0.5', 'rounded-md', 'text-xs', 'font-medium', 'mr-1', 'mb-1', 'inline-block');

                    // Determine color and text contrast
                    let hexColor = '#9CA3AF'; // Default gray
                    if (role.color && role.color !== 0) {
                        hexColor = '#' + role.color.toString(16).padStart(6, '0');
                    }
                    // Simple luminance check for text color
                    const r = parseInt(hexColor.slice(1, 3), 16);
                    const g = parseInt(hexColor.slice(3, 5), 16);
                    const b = parseInt(hexColor.slice(5, 7), 16);
                    const luminance = (0.299 * r + 0.587 * g + 0.114 * b) / 255;
                    const textColorClass = luminance > 0.5 ? 'text-black' : 'text-white'; // Black text on light colors, white on dark

                    roleElement.textContent = role.name || `Role ${role.id}`;
                    roleElement.style.backgroundColor = hexColor;
                    roleElement.classList.add(textColorClass);
                    rolesContainer.appendChild(roleElement);
                });
            } else {
                rolesContainer.innerHTML = '<p class="text-gray-400 text-sm w-full">No roles found.</p>';
            }
        }

        // --- Modal Functions ---

        /**
         * Shows the user info modal with details for the given sender ID.
         * Fetches role info if available (currently only for the logged-in user).
         * @param {string} senderId - The Discord user ID.
         * @param {string} username - The user's username.
         */
        function showUserInfoModal(senderId, username) {
             if (!userInfoModal || !senderId) return;

             modalUsername.textContent = username || 'Unknown User';
             modalUserId.textContent = senderId;
             modalUserRoles.innerHTML = ''; // Clear previous roles

             // Check if the clicked user is the currently logged-in user to display roles
             if (currentUser && currentUser.user_id === senderId && currentUser.roles) {
                 if (currentUser.roles.length > 0) {
                     // Use displayUserRoles logic but target the modal container
                     const sortedRoles = [...currentUser.roles].sort((a, b) => b.position - a.position);
                     sortedRoles.forEach(role => {
                         const roleElement = document.createElement('span');
                         roleElement.classList.add('px-2', 'py-0.5', 'rounded-md', 'text-xs', 'font-medium', 'mr-1', 'mb-1', 'inline-block');
                         let hexColor = '#9CA3AF';
                         if (role.color && role.color !== 0) hexColor = '#' + role.color.toString(16).padStart(6, '0');
                         const r = parseInt(hexColor.slice(1, 3), 16), g = parseInt(hexColor.slice(3, 5), 16), b = parseInt(hexColor.slice(5, 7), 16);
                         const luminance = (0.299 * r + 0.587 * g + 0.114 * b) / 255;
                         const textColorClass = luminance > 0.5 ? 'text-black' : 'text-white';
                         roleElement.textContent = role.name || `Role ${role.id}`;
                         roleElement.style.backgroundColor = hexColor;
                         roleElement.classList.add(textColorClass);
                         modalUserRoles.appendChild(roleElement);
                     });
                 } else {
                      modalUserRoles.innerHTML = '<p class="text-gray-500 text-xs">User has no roles.</p>';
                 }
             } else {
                 // Placeholder for fetching other users' info if a backend endpoint existed
                 modalUserRoles.innerHTML = '<p class="text-gray-500 text-xs">Role information only available for yourself currently.</p>';
                 // TODO: If an endpoint `/api/user/{user_id}/roles` existed, fetch it here.
             }

             userInfoModal.classList.add('active'); // Show the modal
        }

        /**
         * Hides the user info modal.
         */
        function hideUserInfoModal() {
             if (userInfoModal) userInfoModal.classList.remove('active');
        }

        // --- Context Menu Functions ---

        /**
         * Positions a context menu element near the mouse event coordinates.
         * Adjusts position to stay within viewport boundaries.
         * @param {HTMLElement} menuElement - The context menu element.
         * @param {MouseEvent} event - The triggering mouse event (e.g., contextmenu).
         */
        function positionContextMenu(menuElement, event) {
             const rect = event.target.getBoundingClientRect(); // Get target element bounds
             // Initial position relative to viewport + scroll offset
             let top = event.clientY + window.scrollY + 5;
             let left = event.clientX + window.scrollX + 5;
             // Get menu dimensions (use offsetHeight/Width for rendered size)
             const menuHeight = menuElement.offsetHeight || 150; // Fallback height
             const menuWidth = menuElement.offsetWidth || 150; // Fallback width
             const windowHeight = window.innerHeight + window.scrollY;
             const windowWidth = window.innerWidth + window.scrollX;

             // Adjust if menu goes off bottom edge
             if (top + menuHeight > windowHeight) {
                 top = event.clientY + window.scrollY - menuHeight - 5; // Position above cursor
             }
             // Adjust if menu goes off right edge
             if (left + menuWidth > windowWidth) {
                 left = event.clientX + window.scrollX - menuWidth - 5; // Position left of cursor
             }
             // Ensure menu doesn't go off top/left (less common)
             if (top < window.scrollY) top = window.scrollY;
             if (left < window.scrollX) left = window.scrollX;


             menuElement.style.top = `${top}px`;
             menuElement.style.left = `${left}px`;
             menuElement.style.display = 'block'; // Make it visible
        }

        /**
         * Hides any currently visible context menu.
         * Removes associated event listeners.
         */
        function hideContextMenu() {
            if (chatContextMenu) chatContextMenu.style.display = 'none';
            if (ticketContextMenu) ticketContextMenu.style.display = 'none';
             // Remove global listeners when hiding
             document.removeEventListener('click', hideContextMenu);
             window.removeEventListener('scroll', hideContextMenu);
             currentContextMenu = null; // Reset active menu tracker
        }

        /**
         * Shows the context menu for chat messages (moderator only).
         * @param {MouseEvent} event - The contextmenu event.
         */
        function showChatContextMenu(event) {
            event.preventDefault();
            hideContextMenu(); // Hide any other menus first

            // Only moderators can use the chat context menu
            if (!currentUser || !currentUser.is_moderator || !chatContextMenu) return;

            const messageElement = event.target.closest('.chat-message');
            if (!messageElement) return; // Clicked outside a message

            // Store relevant data from the message element
            contextMenuData.ticketId = currentTicketId; // Assumes this is called on the ticket detail page
            contextMenuData.messageTimestamp = messageElement.dataset.timestamp;
            contextMenuData.senderId = messageElement.dataset.senderId;
            contextMenuData.ticketStatus = null; // Not relevant for chat message actions

            // Position and show the menu
            positionContextMenu(chatContextMenu, event);
            currentContextMenu = chatContextMenu; // Track the active menu

            // Add listeners to hide the menu on click outside or scroll
            // Use { once: true } so they automatically remove themselves after firing
            document.addEventListener('click', hideContextMenu, { once: true });
            window.addEventListener('scroll', hideContextMenu, { once: true });
        }

        /**
         * Shows the context menu for ticket list items.
         * Shows/hides options based on ticket status and user role.
         * @param {MouseEvent} event - The contextmenu event.
         */
        function showTicketContextMenu(event) {
             event.preventDefault();
             hideContextMenu(); // Hide any other menus

             if (!currentUser || !ticketContextMenu) return; // Check if user exists and menu exists

             const ticketElement = event.target.closest('.ticket-list-item');
             if (!ticketElement) return; // Clicked outside a ticket item

             // Store relevant data from the ticket element
             contextMenuData.ticketId = ticketElement.dataset.ticketId;
             contextMenuData.ticketStatus = ticketElement.dataset.ticketStatus;
             contextMenuData.senderId = null; // Not relevant for ticket actions
             contextMenuData.messageTimestamp = null; // Not relevant for ticket actions
             console.log("[showTicketContextMenu] Data:", contextMenuData);

             // Determine which actions are available based on status and role
             const isModerator = currentUser.is_moderator;
             // User can close their own open ticket (backend enforces ownership)
             // Moderator can close any open ticket
             const canClose = contextMenuData.ticketStatus === 'open';
             // Only moderators can reopen closed tickets
             const canReopen = contextMenuData.ticketStatus === 'closed' && isModerator;
             // Only moderators can delete tickets
             const canDelete = isModerator;

             // Toggle visibility of menu items based on permissions
             contextCloseTicketButton.classList.toggle('hidden', !canClose);
             contextReopenTicketButton.classList.toggle('hidden', !canReopen);
             contextDeleteTicketButton.classList.toggle('hidden', !canDelete);


             // Only show the menu if there's at least one action available
             if (canClose || canReopen || canDelete) {
                 positionContextMenu(ticketContextMenu, event);
                 currentContextMenu = ticketContextMenu; // Track active menu
                 // Add listeners to hide menu
                 document.addEventListener('click', hideContextMenu, { once: true });
                 window.addEventListener('scroll', hideContextMenu, { once: true });
             }
        }

        /**
         * Emits a socket event to delete a chat message.
         */
        function deleteChatMessage() {
             if (!contextMenuData.ticketId || !contextMenuData.messageTimestamp || !socket || !socket.connected) {
                 showPopupMessage(errorMessagePopup, 'Cannot delete message: Invalid state or not connected.', true);
                 return;
             }
             console.log(`[deleteChatMessage] Attempting to delete message: T:${contextMenuData.ticketId} TS:${contextMenuData.messageTimestamp}`);
             socket.emit('delete_message', {
                 ticket_id: contextMenuData.ticketId,
                 message_timestamp: contextMenuData.messageTimestamp // Send the ISO timestamp
             });
             hideContextMenu(); // Hide menu after action
        }

        // --- Ticket Context Menu Action Functions ---

        /** Emits socket event to close the selected ticket. */
         function closeTicket() {
             if (!contextMenuData.ticketId || !socket || !socket.connected) {
                 showPopupMessage(errorMessagePopup, 'Cannot close ticket: Invalid state or not connected.', true);
                 return;
             }
             console.log(`[closeTicket] Attempting to close ticket: ${contextMenuData.ticketId}`);
             socket.emit('update_ticket_status', {
                 ticket_id: contextMenuData.ticketId,
                 new_status: 'closed'
             });
             hideContextMenu();
         }

         /** Emits socket event to reopen the selected ticket (moderator only). */
         function reopenTicket() {
             if (!contextMenuData.ticketId || !socket || !socket.connected) {
                 showPopupMessage(errorMessagePopup, 'Cannot reopen ticket: Invalid state or not connected.', true);
                 return;
             }
             // Add extra check for moderator role (though backend should enforce)
             if (!currentUser?.is_moderator) {
                 showPopupMessage(errorMessagePopup, 'You do not have permission to reopen tickets.', true);
                 hideContextMenu();
                 return;
             }
             console.log(`[reopenTicket] Attempting to reopen ticket: ${contextMenuData.ticketId}`);
             socket.emit('update_ticket_status', {
                 ticket_id: contextMenuData.ticketId,
                 new_status: 'open'
             });
             hideContextMenu();
         }

         /** Emits socket event to delete the selected ticket (moderator only). Includes confirmation. */
         function deleteTicket() {
             if (!contextMenuData.ticketId || !socket || !socket.connected) {
                 showPopupMessage(errorMessagePopup, 'Cannot delete ticket: Invalid state or not connected.', true);
                 return;
             }
              // Add extra check for moderator role
             if (!currentUser?.is_moderator) {
                 showPopupMessage(errorMessagePopup, 'You do not have permission to delete tickets.', true);
                 hideContextMenu();
                 return;
             }
             // Confirmation dialog before deleting
             if (confirm(`Are you sure you want to permanently delete ticket #${contextMenuData.ticketId.slice(-6)}? This action cannot be undone.`)) {
                 console.log(`[deleteTicket] Attempting to delete ticket: ${contextMenuData.ticketId}`);
                 socket.emit('delete_ticket', {
                     ticket_id: contextMenuData.ticketId
                 });
             }
             hideContextMenu(); // Hide menu regardless of confirmation outcome
         }


        // --- Event Listeners Setup ---

        // Login Button
        loginButton.addEventListener('click', (e) => {
            e.preventDefault(); // Prevent default link behavior if needed
            window.location.href = loginButton.href; // Redirect to Discord login
        });

        /** Handles the logout process by calling the backend endpoint. */
        async function handleLogout() {
            console.log('Logging out...');
            try {
                const response = await fetch(`${API_BASE_URL}/logout`, { credentials: 'include' });
                if (!response.ok) {
                    let errorMsg = 'Logout request failed';
                    try { const errorData = await response.json(); errorMsg = errorData.error || errorMsg; } catch (parseError) {}
                    throw new Error(errorMsg);
                }
                currentUser = { logged_in: false }; // Update state
                localStorage.removeItem('currentPage'); // Clear saved page
                disconnectSocket(); // Disconnect socket on logout
                window.location.hash = '/#home'; // Redirect to home using updated format
                updateHeaderUI(currentUser); // Update header immediately
                showPopupMessage(paymentMessage, "Logged out successfully."); // Use success popup
            } catch(error) {
                console.error("Logout error:", error);
                showPopupMessage(errorMessagePopup, `Logout failed: ${error.message}`, true);
                // Still attempt to reset state even on error
                currentUser = { logged_in: false };
                localStorage.removeItem('currentPage');
                disconnectSocket();
                window.location.hash = '/#home';
                updateHeaderUI(currentUser);
            }
        }
        // Attach logout handler to both buttons
        logoutButton.addEventListener('click', handleLogout);
        dashboardLogoutButton.addEventListener('click', handleLogout);

        // Hash Change Listener for Navigation
        window.addEventListener('hashchange', runNavigation);

        // Create Ticket Form Submission
        if(createTicketForm) {
            createTicketForm.addEventListener('submit', async (event) => {
                event.preventDefault(); // Prevent default form submission
                const subject = ticketSubjectInput.value.trim();
                const message = ticketMessageInput.value.trim();
                createTicketStatus.textContent = ''; // Clear previous status
                createTicketStatus.className = 'h-6 text-sm mt-4 mb-4 text-center'; // Reset classes

                if (!subject || !message) {
                    createTicketStatus.textContent = 'Please fill out both subject and message.';
                    createTicketStatus.classList.add('error'); // Add error class for styling
                    return;
                }

                const submitButton = document.getElementById('create-ticket-button');
                submitButton.disabled = true; // Disable button during submission
                submitButton.textContent = 'Submitting...';

                try {
                    const response = await fetch(`${API_BASE_URL}/api/tickets`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ subject, message }),
                        credentials: 'include' // Send cookies
                    });
                    if (!response.ok) {
                        let errorData; try { errorData = await response.json(); } catch (e) {}
                        throw new Error(errorData?.error || `HTTP error! status: ${response.status}`);
                    }
                    const result = await response.json(); // Get the created ticket ID/details if needed
                    createTicketStatus.textContent = 'Ticket submitted successfully!';
                    createTicketStatus.classList.add('success'); // Add success class
                    createTicketForm.reset(); // Clear the form
                    fetchTickets(); // Refresh the ticket list to show the new ticket
                } catch (error) {
                    console.error('Error creating ticket:', error);
                    createTicketStatus.textContent = `Error: ${error.message}`;
                    createTicketStatus.classList.add('error');
                } finally {
                    submitButton.disabled = false; // Re-enable button
                    submitButton.textContent = 'Submit Ticket';
                }
            });
        } else { console.warn("Create ticket form not found."); }

        // Chat Input Form Submission
        if(chatInputForm) {
             chatInputForm.addEventListener('submit', (event) => {
                 event.preventDefault();
                 const messageText = chatInput.value.trim();
                 if (messageText && socket && socket.connected && currentTicketId) {
                     // Emit the message to the server
                     socket.emit('send_message', { ticket_id: currentTicketId, text: messageText });
                     chatInput.value = ''; // Clear the input field
                 } else if (!socket || !socket.connected) {
                     showPopupMessage(errorMessagePopup, 'Not connected to chat.', true);
                 } else if (!currentTicketId) {
                     showPopupMessage(errorMessagePopup, 'No active ticket selected.', true);
                 } // Don't send empty messages
             });
        } else { console.warn("Chat input form not found."); }

        // Modal Close Button Listener
        if (modalCloseButton) {
             modalCloseButton.addEventListener('click', hideUserInfoModal);
        }
        // Close modal if clicking on the backdrop (outside the content)
        if (userInfoModal) {
             userInfoModal.addEventListener('click', (event) => {
                 if (event.target === userInfoModal) { // Check if the click is directly on the modal backdrop
                     hideUserInfoModal();
                 }
             });
        }

        // Chat Context Menu Listener (attached in appendChatMessage for moderators)

        // Chat Context Menu Action Listeners
         if (contextDeleteButton) {
             contextDeleteButton.addEventListener('click', deleteChatMessage);
         }
         if (contextUserInfoButton) {
             contextUserInfoButton.addEventListener('click', () => {
                 if (contextMenuData.senderId) {
                     // Try to get username from the message element for better UX
                     const messageElement = chatMessagesDiv?.querySelector(`.chat-message[data-timestamp="${contextMenuData.messageTimestamp}"]`);
                     const usernameElement = messageElement?.querySelector('.username');
                     const username = usernameElement ? usernameElement.textContent.replace(':', '') : 'Unknown User';
                     showUserInfoModal(contextMenuData.senderId, username);
                 }
                 hideContextMenu(); // Hide menu after action
             });
         }

         // Ticket Context Menu Action Listeners
         if (contextCloseTicketButton) {
             contextCloseTicketButton.addEventListener('click', closeTicket);
         }
         if (contextReopenTicketButton) {
             contextReopenTicketButton.addEventListener('click', reopenTicket);
         }
         if (contextDeleteTicketButton) {
             contextDeleteTicketButton.addEventListener('click', deleteTicket);
         }

         // Mobile Menu Toggle
         if (mobileMenuButton && mobileMenu) {
             mobileMenuButton.addEventListener('click', () => {
                 mobileMenu.classList.toggle('hidden'); // Toggle visibility
             });
             // Add listeners to mobile menu links to close the menu on click
             mobileMenu.querySelectorAll('a').forEach(link => {
                 link.addEventListener('click', () => {
                     mobileMenu.classList.add('hidden'); // Hide menu when a link is clicked
                     // Let the default link behavior (hash change) handle navigation
                 });
             });
         }


        // --- Initial Page Load Logic ---
        document.addEventListener('DOMContentLoaded', () => {
            console.log("DOM fully loaded.");
            createSnowflakes(); // Initialize background effect
            checkLoginStatusAndNavigate(); // Check login and navigate to initial/saved section
        });

    </script>

</body>
</html>
