<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shillette</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
    <style type="text/tailwindcss">
        @keyframes animateGradient { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }
        @keyframes spinBorder { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }
        @keyframes fall { 0% { transform: translateY(-10vh) translateX(0); opacity: 1; } 100% { transform: translateY(110vh) translateX(5vw); opacity: 0; } }
        @keyframes scaleUpDown { 0%, 100% { transform: scaleY(0.4); } 20% { transform: scaleY(1.0); } }

        body {
            font-family: 'Inter', sans-serif;
            @apply bg-gradient-to-br from-orange-700 via-black to-black text-gray-300;
            background-size: 200% 200%;
            animation: animateGradient 25s ease infinite;
            overflow-x: hidden; position: relative; z-index: 0;
        }
        body::before { content: ''; position: fixed; inset: 0; background-image: url('images/background.png'); background-size: cover; background-position: center center; background-repeat: no-repeat; background-attachment: fixed; opacity: 0.2; z-index: -1; }

        #snow-container { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 40; overflow: hidden; }
        .snowflake { position: absolute; background-color: white; border-radius: 50%; pointer-events: none; animation-name: fall; animation-timing-function: linear; animation-iteration-count: infinite; }

        .card-gradient-border::before { content: ''; position: absolute; inset: 0; border-radius: 0.5rem; padding: 2px; background-size: 300% 300%; animation: spinBorder 5s linear infinite; -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0); -webkit-mask-composite: xor; mask-composite: exclude; pointer-events: none; z-index: -1; }
        .card-gradient-border.orange-border::before { background-image: linear-gradient(145deg, #f97316, #9a3412, #000000); }
        .card-gradient-border.gray-border::before { background-image: linear-gradient(145deg, #9ca3af, #374151, #000000); animation-duration: 6s; }
        .card-gradient-border.blue-border::before { background-image: linear-gradient(145deg, #3b82f6, #1e40af, #000000); animation-duration: 5.5s; }
        .card-gradient-border.green-border::before { background-image: linear-gradient(145deg, #22c55e, #15803d, #000000); animation-duration: 6.5s; }
        .card-gradient-border.red-border::before { background-image: linear-gradient(145deg, #ef4444, #991b1b, #000000); animation-duration: 4.5s; }
        .card-gradient-border.purple-border::before { background-image: linear-gradient(145deg, #a855f7, #6b21a8, #000000); animation-duration: 5.8s; }
        .card-gradient-border.yellow-border::before { background-image: linear-gradient(145deg, #eab308, #a16207, #000000); animation-duration: 5.2s; }
        .card-gradient-border.pink-border::before { background-image: linear-gradient(145deg, #ec4899, #be185d, #000000); animation-duration: 5.6s; }
        .card-gradient-border.teal-border::before { background-image: linear-gradient(145deg, #14b8a6, #0f766e, #000000); animation-duration: 6.1s; }
        .card-gradient-border.custom-border { border-width: 2px; border-style: solid; }

        .product-card { @apply relative bg-slate-800/80 backdrop-blur-sm rounded-lg shadow-xl flex flex-col z-0; overflow: hidden; transition: transform 0.3s ease-in-out, box-shadow 0.3s ease-in-out; cursor: pointer; }
        .product-card:not(.custom-border) { @apply p-0; }
        .product-card.custom-border { @apply p-0; }
        .product-card-inner { @apply p-6 flex flex-col flex-grow; }
        .product-card:hover { transform: scale(1.03); }

        .product-card.card-gradient-border.orange-border:hover { box-shadow: 0 0 8px 1px rgba(249, 115, 22, 0.6), 0 0 16px 4px rgba(249, 115, 22, 0.4), 0 0 32px 8px rgba(249, 115, 22, 0.2); }
        .product-card.card-gradient-border.gray-border:hover { box-shadow: 0 0 8px 1px rgba(156, 163, 175, 0.5), 0 0 16px 4px rgba(156, 163, 175, 0.3), 0 0 32px 8px rgba(156, 163, 175, 0.15); }
        .product-card.card-gradient-border.blue-border:hover { box-shadow: 0 0 8px 1px rgba(59, 130, 246, 0.6), 0 0 16px 4px rgba(59, 130, 246, 0.4), 0 0 32px 8px rgba(59, 130, 246, 0.2); }
        .product-card.card-gradient-border.green-border:hover { box-shadow: 0 0 8px 1px rgba(34, 197, 94, 0.6), 0 0 16px 4px rgba(34, 197, 94, 0.4), 0 0 32px 8px rgba(34, 197, 94, 0.2); }
        .product-card.card-gradient-border.red-border:hover { box-shadow: 0 0 8px 1px rgba(239, 68, 68, 0.6), 0 0 16px 4px rgba(239, 68, 68, 0.4), 0 0 32px 8px rgba(239, 68, 68, 0.2); }
        .product-card.card-gradient-border.purple-border:hover { box-shadow: 0 0 8px 1px rgba(168, 85, 247, 0.6), 0 0 16px 4px rgba(168, 85, 247, 0.4), 0 0 32px 8px rgba(168, 85, 247, 0.2); }
        .product-card.card-gradient-border.yellow-border:hover { box-shadow: 0 0 8px 1px rgba(234, 179, 8, 0.6), 0 0 16px 4px rgba(234, 179, 8, 0.4), 0 0 32px 8px rgba(234, 179, 8, 0.2); }
        .product-card.card-gradient-border.pink-border:hover { box-shadow: 0 0 8px 1px rgba(236, 72, 153, 0.6), 0 0 16px 4px rgba(236, 72, 153, 0.4), 0 0 32px 8px rgba(236, 72, 153, 0.2); }
        .product-card.card-gradient-border.teal-border:hover { box-shadow: 0 0 8px 1px rgba(20, 184, 166, 0.6), 0 0 16px 4px rgba(20, 184, 166, 0.4), 0 0 32px 8px rgba(20, 184, 166, 0.2); }
        .product-card.custom-border:hover { box-shadow: var(--custom-hover-shadow, 0 0 8px 1px rgba(255, 255, 255, 0.6), 0 0 16px 4px rgba(255, 255, 255, 0.4), 0 0 32px 8px rgba(255, 255, 255, 0.2)); }

        .product-thumbnail { @apply w-full h-40 object-cover rounded-t-lg; }
        .product-thumbnail-placeholder { @apply w-full h-40 bg-slate-700 rounded-t-lg flex items-center justify-center text-gray-500; }

        #dashboard-content h2, #products-page-content h2, #tickets-page-content h2, #ticket-detail-content h2, #product-detail-page-content h2 { @apply text-3xl md:text-4xl font-bold text-white text-center mb-12; }
        #dashboard-content .dashboard-card, #tickets-page-content .ticket-card, #ticket-detail-content .ticket-card, .admin-section, .product-detail-card { @apply bg-slate-800/80 backdrop-blur-sm p-6 rounded-lg shadow-lg mb-6; }

        .paypal-button, .purchase-button {
            @apply bg-sky-600 hover:bg-sky-700 text-white text-sm font-medium py-2 px-4 rounded-md transition duration-300 flex items-center justify-center space-x-2 w-full disabled:opacity-50 disabled:cursor-not-allowed;
        }
        .buy-now-button { @apply bg-orange-600 hover:bg-orange-700 text-white font-semibold py-2 px-6 rounded-lg transition duration-300 shadow-md; }
        .add-basket-button { @apply bg-gray-600 hover:bg-gray-500 text-white font-semibold py-2 px-6 rounded-lg transition duration-300 shadow-md; }

        #payment-message, #ticket-message, #error-message, #config-message, #product-message {
            position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
            @apply text-white text-sm font-medium py-2 px-5 rounded-lg shadow-lg opacity-0 transition-opacity duration-500 ease-in-out z-50 pointer-events-none;
        }
        #payment-message.show, #ticket-message.show, #error-message.show, #config-message.show, #product-message.show { opacity: 1; }
        #payment-message, #ticket-message, #config-message, #product-message { @apply bg-green-600; }
        #error-message { @apply bg-red-600; }

        #loading-overlay { position: fixed; inset: 0; @apply bg-black/60 backdrop-blur-sm flex items-center justify-center z-50 transition-opacity duration-300 ease-in-out opacity-0 pointer-events-none; }
        #loading-overlay.active { @apply opacity-100 pointer-events-auto; }
        .loader { display: flex; align-items: center; justify-content: space-between; width: 50px; height: 25px; }
        .loader-bar { display: block; width: 8px; height: 100%; background-color: #f97316; border-radius: 4px; animation: scaleUpDown 1.2s infinite ease-in-out; }
        .loader-bar:nth-child(2) { animation-delay: 0.2s; } .loader-bar:nth-child(3) { animation-delay: 0.4s; }

        .page-section { display: none; }
        .page-section.active { display: block; }

        .ticket-list-item { @apply bg-slate-700/50 p-4 rounded-md mb-3 flex justify-between items-center cursor-pointer hover:bg-slate-600/50 transition-colors; }
        .status-open { @apply bg-green-500 text-green-900 text-xs font-bold px-2 py-0.5 rounded-full; }
        .status-closed { @apply bg-red-500 text-red-900 text-xs font-bold px-2 py-0.5 rounded-full; }
        #create-ticket-status { @apply text-sm mt-4 mb-4 text-center h-6; }
        #create-ticket-status.success { @apply text-green-400; } #create-ticket-status.error { @apply text-red-400; }
        #moderator-management-view h3 { @apply text-xl font-semibold text-white mb-4; }
        #moderator-management-view details summary { @apply cursor-pointer text-lg font-semibold text-white mb-3 hover:text-orange-400 transition-colors; }
        #moderator-management-view details[open] summary { @apply text-orange-400; }
        .ticket-list-container { @apply space-y-3 max-h-96 overflow-y-auto pr-2; }

        #chat-messages { @apply h-64 md:h-80 overflow-y-auto mb-4 p-3 bg-slate-900/50 rounded-md border border-slate-700 space-y-2; }
        .chat-message { @apply text-sm break-words p-1 rounded hover:bg-slate-800/50 transition-colors; }
        .chat-message .username { @apply font-semibold text-orange-400 mr-2 cursor-pointer hover:underline; }
        .chat-message .timestamp { @apply text-xs text-gray-500 ml-2 whitespace-nowrap; }
        #chat-input-form { @apply flex space-x-2; }
        #chat-input { @apply flex-grow bg-slate-700 border border-slate-600 rounded-md py-2 px-3 text-white focus:outline-none focus:ring-2 focus:ring-orange-500 focus:border-transparent placeholder-gray-500; }
        #send-chat-button { @apply bg-orange-600 hover:bg-orange-700 text-white font-medium py-2 px-4 rounded-lg transition duration-300; }

        .modal { @apply fixed inset-0 bg-black/70 backdrop-blur-sm flex items-center justify-center z-50 opacity-0 pointer-events-none transition-opacity duration-300; }
        .modal.active { @apply opacity-100 pointer-events-auto; }
        .modal-content { @apply bg-slate-800 p-6 rounded-lg shadow-xl max-w-md w-full text-white relative; }
        #product-edit-modal .modal-content { @apply max-w-lg; }
        .modal-close-button { @apply absolute top-3 right-3 text-gray-400 hover:text-white transition-colors; }
        #modal-user-roles { @apply flex flex-wrap gap-1 mt-3; }

        #chat-context-menu, #ticket-context-menu { @apply absolute bg-slate-700 border border-slate-600 rounded-md shadow-lg py-1 text-sm text-white z-50 hidden; }
        .context-menu-item { @apply px-3 py-1.5 hover:bg-orange-600 cursor-pointer block w-full text-left; }
        .context-menu-item.hidden { display: none; }
        .context-menu-item.delete { @apply hover:bg-red-600 text-red-400 hover:text-white; }

        #mobile-menu { @apply absolute top-full left-0 right-0 bg-gray-800/95 backdrop-blur-sm p-4 space-y-2 border-t border-gray-700/50 md:hidden z-30 hidden; }
        .mobile-menu-link { @apply block text-gray-300 hover:text-white transition duration-200 py-1; }

        .admin-section h3 { @apply text-xl font-semibold text-white mb-4 border-b border-slate-700 pb-2; }
        .admin-form label { @apply block text-sm font-medium text-gray-300 mb-1; }
        .admin-form > div > input[type="text"],
        .admin-form > div > input[type="number"],
        .admin-form > div > input[type="color"],
        .admin-form > div > textarea,
        .admin-form > div > select,
        .admin-form > .grid > div > input[type="text"],
        .admin-form > .grid > div > select {
             @apply w-full bg-slate-700 border border-slate-600 rounded-md py-2 px-3 text-white focus:outline-none focus:ring-2 focus:ring-orange-500 focus:border-transparent placeholder-gray-400 mb-4;
        }
        .admin-form .link-group { @apply flex items-center space-x-2 mb-2; }
        .admin-form .link-group button { @apply bg-red-600 hover:bg-red-700 text-white text-xs font-bold py-1 px-2 rounded flex-shrink-0; }

        .admin-form button[type="submit"] { @apply w-full bg-orange-600 hover:bg-orange-700 text-white font-medium py-2.5 px-6 rounded-lg transition duration-300 disabled:opacity-50; }
        .admin-form button[type="button"] { @apply bg-blue-600 hover:bg-blue-700 text-white text-sm font-medium py-2 px-4 rounded-md transition duration-300; }


        #product-list-table { @apply w-full text-sm text-left text-gray-400 mt-4; }
        #product-list-table thead { @apply text-xs text-gray-300 uppercase bg-slate-700/50; }
        #product-list-table th, #product-list-table td { @apply px-4 py-3; }
        #product-list-table tbody tr { @apply border-b border-slate-700 hover:bg-slate-700/50; }
        #product-list-table .actions button { @apply text-xs font-medium px-2 py-1 rounded mr-1 transition duration-200; }
        #product-list-table .actions .edit-btn { @apply bg-blue-600 hover:bg-blue-700 text-white; }
        #product-list-table .actions .delete-btn { @apply bg-red-600 hover:bg-red-700 text-white; }
        #product-list-status { @apply text-sm text-gray-500 mt-4 text-center; }

        .role-span { @apply px-2 py-0.5 rounded-md text-xs font-medium mr-1 mb-1 inline-block; }

        /* Product Detail Page Specific Styles */
        #product-detail-page-content .detail-card { @apply bg-slate-800/70 backdrop-blur-sm p-5 rounded-lg shadow-lg; }
        #product-detail-image { @apply w-full aspect-video object-cover rounded-lg mb-6 shadow-lg; }
        .star-rating span { @apply text-yellow-400 text-lg; }
        .quantity-selector button { @apply bg-slate-600 hover:bg-slate-500 text-white font-bold w-8 h-8 rounded-md transition duration-200; }
        .quantity-selector input { @apply w-12 text-center bg-slate-700 border border-slate-600 rounded-md py-1 mx-2 text-white; }
        .review-card { @apply bg-slate-700/50 p-4 rounded-md; }

    </style>
</head>
<body class="min-h-screen flex flex-col">

    <div id="snow-container"></div>

    <div id="payment-message">Placeholder</div>
    <div id="ticket-message">Placeholder</div>
    <div id="error-message">Placeholder</div>
    <div id="config-message">Placeholder</div>
    <div id="product-message">Placeholder</div>

    <div id="loading-overlay">
        <div class="loader"><span class="loader-bar"></span><span class="loader-bar"></span><span class="loader-bar"></span></div>
    </div>

    <div id="user-info-modal" class="modal">
        <div class="modal-content">
            <button id="modal-close-button" class="modal-close-button">
                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path></svg>
            </button>
            <h3 class="text-lg font-semibold mb-3" id="modal-username">Username</h3>
            <p class="text-sm text-gray-400 mb-1">User ID: <span id="modal-user-id">N/A</span></p>
            <p class="text-sm font-medium mb-2">Roles:</p>
            <div id="modal-user-roles"><p class="text-gray-500 text-xs">Roles not available.</p></div>
        </div>
    </div>

    <div id="product-edit-modal" class="modal">
        <div class="modal-content max-w-lg">
            <button id="product-modal-close-button" class="modal-close-button">
                 <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path></svg>
            </button>
            <h3 class="text-lg font-semibold mb-4" id="product-modal-title">Add Product</h3>
            <form id="product-edit-form" class="admin-form space-y-4">
                <input type="hidden" id="product-edit-id">
                <div>
                    <label for="product-edit-name">Product Name</label>
                    <input type="text" id="product-edit-name" required>
                </div>
                 <div>
                    <label for="product-edit-thumbnail">Thumbnail URL or Select File</label>
                    <input type="text" id="product-edit-thumbnail" placeholder="Enter image URL...">
                    <div class="mt-2 flex items-center gap-x-3">
                         <input type="file" id="product-edit-thumbnail-file" accept=".png" class="hidden">
                         <button type="button" id="product-edit-thumbnail-button" class="text-sm">Select PNG File</button>
                         <span id="product-edit-thumbnail-filename" class="text-sm text-gray-400 truncate">No file selected</span>
                    </div>
                 </div>
                <div>
                    <label for="product-edit-price">Price ($)</label>
                    <input type="number" id="product-edit-price" step="0.01" required>
                </div>
                 <div>
                    <label for="product-edit-tag">Tag (e.g., ALL IN ONE, SOFTWARE)</label>
                    <input type="text" id="product-edit-tag">
                </div>
                 <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                         <label for="product-edit-tagColor">Tag Border Color</label>
                         <select id="product-edit-tagColor">
                            <option value="gray">Gray</option>
                            <option value="orange">Orange</option>
                            <option value="blue">Blue</option>
                            <option value="green">Green</option>
                            <option value="red">Red</option>
                            <option value="purple">Purple</option>
                            <option value="yellow">Yellow</option>
                            <option value="pink">Pink</option>
                            <option value="teal">Teal</option>
                            <option value="custom">Custom HEX</option>
                         </select>
                     </div>
                     <div id="custom-hex-input-container" class="hidden">
                         <label for="product-edit-customHex">Custom HEX Color</label>
                         <input type="text" id="product-edit-customHex" placeholder="#RRGGBB">
                     </div>
                </div>
                <div>
                    <label for="product-edit-description">Description (Optional)</label>
                    <textarea id="product-edit-description" rows="3"></textarea>
                </div>
                 <div>
                    <label for="product-edit-features">Features (One per line)</label>
                    <textarea id="product-edit-features" rows="5"></textarea>
                </div>
                 <div>
                    <label for="product-edit-paymentLink">Payment Link/ID (e.g., PayPal button ID)</label>
                    <input type="text" id="product-edit-paymentLink">
                </div>
                <button type="submit" id="product-save-button">Save Product</button>
                <div id="product-edit-status" class="text-sm text-center h-5 mt-2"></div>
            </form>
        </div>
    </div>

    <div id="chat-context-menu">
        <button class="context-menu-item" id="context-delete-message">Delete Message</button>
        <button class="context-menu-item" id="context-user-info">User Info</button>
    </div>
    <div id="ticket-context-menu">
        <button class="context-menu-item" id="context-close-ticket">Close Ticket</button>
        <button class="context-menu-item" id="context-reopen-ticket">Reopen Ticket</button>
        <button class="context-menu-item delete" id="context-delete-ticket">Delete Ticket</button>
    </div>


    <header class="py-4 sticky top-0 z-40 bg-gray-900/80 backdrop-blur-md border-b border-gray-700/50">
        <div class="container mx-auto px-6 flex justify-between items-center">
            <div class="flex items-center space-x-2">
                <img src="images/icon.png" alt="Shillette Icon" class="w-8 h-8" onerror="this.style.display='none'; this.nextElementSibling.classList.remove('hidden');">
                <span class="text-2xl font-bold text-white hidden">Shillette</span>
                <span id="site-title-display" class="text-2xl font-bold text-white">Shillette</span>
            </div>
            <div class="flex items-center space-x-6">
                <nav id="main-navigation" class="hidden md:flex space-x-6">
                    </nav>
                <div id="user-area" class="flex items-center">
                    <a id="login-button" href="https://api.shillette.com/login" class="bg-orange-600 hover:bg-orange-700 text-white text-sm font-medium py-2 px-4 rounded-lg transition duration-300 flex items-center space-x-2">
                        <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M19.54 6.04a13.27 13.27 0 00-2.66-1.89 12.4 12.4 0 00-1.6-1.3c-.4-.3-.82-.53-1.28-.71-.18-.07-.37-.13-.56-.19a.82.82 0 00-.5-.06 11.85 11.85 0 00-5.88 0 .82.82 0 00-.5.06c-.19.06-.38.12-.56.19-.46.18-.88.4-1.28.7a12.34 12.34 0 00-1.6 1.3A13.23 13.23 0 004.46 6.04 14.31 14.31 0 003 11.7c0 .1 0 .19.02.28a13.8 13.8 0 001.44 4.61c.56 1.1 1.24 2.1 2.04 3 .5.56 1.04 1.07 1.63 1.53.17.13.34.25.52.37a.8.8 0 00.57.19.78.78 0 00.57-.19 11.07 11.07 0 005.56 0 .78.78 0 00.57.19.8.8 0 00.57-.19c.18-.12.35-.24.52-.37a12.06 12.06 0 003.67-4.53 13.85 13.85 0 001.44 4.61c0-.1 0-.19.02-.28a14.31 14.31 0 00-1.46-5.66zm-4.61 7.03a1.93 1.93 0 01-3.86 0 1.93 1.93 0 013.86 0zm-5.72 0a1.93 1.93 0 01-3.86 0 1.93 1.93 0 013.86 0z"></path></svg>
                        <span>Login with Discord</span>
                    </a>
                    <a href="/#dashboard" id="user-info" class="hidden items-center space-x-3 hover:bg-slate-700/50 p-1.5 rounded-lg transition duration-200 cursor-pointer">
                        <img id="user-avatar" src="https://placehold.co/32x32/7f8c8d/ecf0f1?text=?" alt="User Avatar" class="w-8 h-8 rounded-full border-2 border-slate-600" onerror="this.src='https://placehold.co/32x32/7f8c8d/ecf0f1?text=?'">
                        <span id="user-name" class="text-white text-sm font-medium">Username</span>
                        <button id="logout-button" class="text-gray-400 hover:text-white text-xs font-medium bg-slate-600 hover:bg-slate-500 px-2 py-1 rounded-md transition duration-200">Logout</button>
                    </a>
                </div>
            </div>
            <div class="md:hidden">
                <button id="mobile-menu-button" class="text-gray-300 hover:text-white focus:outline-none">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7"></path></svg>
                </button>
            </div>
        </div>
        <div id="mobile-menu" class="hidden">
            </div>
    </header>

    <main id="main-content" class="flex-grow page-section">
        <section class="relative text-center py-24 md:py-32 lg:py-40 overflow-hidden">
            <div class="container mx-auto px-6 relative z-10">
                <h1 class="text-4xl md:text-5xl lg:text-6xl font-extrabold text-white mb-4">Shillette</h1>
                <p class="text-xl md:text-2xl text-orange-400 mb-6 font-medium">Advanced DMA Firmware</p>
                <p class="max-w-2xl mx-auto text-gray-400 mb-10">
                    Fully undetected DMA firmware, battle-tested for reliable performance. Join thousands of satisfied users.
                </p>
                <div class="flex flex-col sm:flex-row justify-center items-center space-y-4 sm:space-y-0 sm:space-x-4 mb-16">
                    <a href="/#products" id="purchase-button" class="bg-orange-600 hover:bg-orange-700 text-white font-semibold py-3 px-8 rounded-lg transition duration-300 shadow-lg w-full sm:w-auto">
                        Purchase Product
                    </a>
                    <a href="https://discord.gg/shillette" target="_blank" rel="noopener noreferrer" class="bg-gray-700 hover:bg-gray-600 text-white font-semibold py-3 px-8 rounded-lg transition duration-300 shadow-lg w-full sm:w-auto flex items-center justify-center space-x-2">
                        <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M19.54 6.04a13.27 13.27 0 00-2.66-1.89 12.4 12.4 0 00-1.6-1.3c-.4-.3-.82-.53-1.28-.71-.18-.07-.37-.13-.56-.19a.82.82 0 00-.5-.06 11.85 11.85 0 00-5.88 0 .82.82 0 00-.5.06c-.19.06-.38.12-.56.19-.46.18-.88.4-1.28.7a12.34 12.34 0 00-1.6 1.3A13.23 13.23 0 004.46 6.04 14.31 14.31 0 003 11.7c0 .1 0 .19.02.28a13.8 13.8 0 001.44 4.61c.56 1.1 1.24 2.1 2.04 3 .5.56 1.04 1.07 1.63 1.53.17.13.34.25.52.37a.8.8 0 00.57.19.78.78 0 00.57-.19 11.07 11.07 0 005.56 0 .78.78 0 00.57.19.8.8 0 00.57-.19c.18-.12.35-.24.52-.37a12.06 12.06 0 003.67-4.53 13.85 13.85 0 001.44 4.61c0-.1 0-.19.02-.28a14.31 14.31 0 00-1.46-5.66zm-4.61 7.03a1.93 1.93 0 01-3.86 0 1.93 1.93 0 013.86 0zm-5.72 0a1.93 1.93 0 01-3.86 0 1.93 1.93 0 013.86 0z"></path></svg>
                        <span>Join Discord</span>
                    </a>
                </div>
                <div class="grid grid-cols-2 sm:grid-cols-4 gap-8 max-w-3xl mx-auto text-gray-400">
                    <div class="text-center"><div class="text-3xl font-bold text-white mb-1">1000+</div><div>Happy Users</div></div>
                    <div class="text-center"><div class="text-3xl font-bold text-white mb-1">1000+</div><div>Products Sold</div></div>
                    <div class="text-center"><div class="text-3xl font-bold text-white mb-1">5.0</div><div>Star Rating</div></div>
                    <div class="text-center"><div class="text-3xl font-bold text-white mb-1">3+</div><div>Years Experience</div></div>
                </div>
            </div>
        </section>
    </main>

    <div id="products-page-content" class="flex-grow container mx-auto px-6 py-10 page-section">
        <div class="flex justify-start mb-8">
             <a href="/#home" id="back-to-home-button-products" class="text-orange-400 hover:text-orange-300 flex items-center space-x-2 transition duration-200">
                 <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path></svg>
                 <span>Back to Home</span>
             </a>
        </div>
        <h2>Our Products</h2>
        <div id="product-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8 max-w-7xl mx-auto">
            <p id="product-loading-status" class="text-center text-gray-400 md:col-span-2 lg:col-span-3">Loading products...</p>
        </div>
    </div>

    <div id="dashboard-content" class="flex-grow container mx-auto px-6 py-10 page-section">
        <h2>Dashboard</h2>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
            <div class="dashboard-card md:col-span-1">
                <h3 class="text-lg font-semibold text-white mb-4">Welcome!</h3>
                <div class="flex items-center space-x-4 mb-4">
                     <img id="dashboard-user-avatar" src="https://placehold.co/64x64/7f8c8d/ecf0f1?text=?" alt="User Avatar" class="w-16 h-16 rounded-full border-2 border-orange-500" onerror="this.src='https://placehold.co/64x64/7f8c8d/ecf0f1?text=?'">
                     <div>
                         <p id="dashboard-user-name" class="text-xl font-semibold text-white">Username</p>
                         <p class="text-sm text-gray-400">Status: Active</p>
                     </div>
                </div>
                <button id="dashboard-logout-button" class="w-full bg-red-600 hover:bg-red-700 text-white text-sm font-medium py-2 px-4 rounded-lg transition duration-300">
                    Logout
                </button>
            </div>

            <div class="dashboard-card md:col-span-2">
                <h3 class="text-lg font-semibold text-white mb-4">My Products</h3>
                <p class="text-gray-400">Purchased product information will appear here (Feature not implemented).</p>
            </div>

            <div class="dashboard-card md:col-span-1">
                <h3 class="text-lg font-semibold text-white mb-4">My Roles</h3>
                <div id="dashboard-user-roles" class="space-y-2 flex flex-wrap gap-1">
                    <p class="text-gray-400 text-sm w-full">Loading roles...</p>
                </div>
            </div>

            <div class="dashboard-card md:col-span-2">
                 <h3 class="text-lg font-semibold text-white mb-4">Settings</h3>
                 <p class="text-gray-400">User settings will appear here (Feature not implemented).</p>
            </div>

            <div id="admin-dashboard-sections" class="hidden md:col-span-3 grid grid-cols-1 lg:grid-cols-2 gap-6">

                <div class="admin-section lg:col-span-1">
                    <h3>Site Configuration</h3>
                    <form id="site-config-form" class="admin-form">
                        <div>
                            <label for="config-site-title">Site Title</label>
                            <input type="text" id="config-site-title" required>
                        </div>
                        <div>
                            <label>Header Links</label>
                            <div id="config-header-links-container" class="space-y-2 mb-2">
                                </div>
                            <button type="button" id="add-header-link-button" class="text-sm">Add Link</button>
                        </div>
                        <button type="submit" id="save-config-button">Save Configuration</button>
                        <div id="config-save-status" class="text-sm text-center h-5 mt-2"></div>
                    </form>
                </div>

                <div class="admin-section lg:col-span-1">
                    <h3>Product Management</h3>
                    <button id="add-product-button" class="mb-4 bg-green-600 hover:bg-green-700 text-white font-medium py-2 px-4 rounded-lg transition duration-300">Add New Product</button>
                    <div class="overflow-x-auto">
                        <table id="product-list-table">
                            <thead>
                                <tr><th>Name</th><th>Price</th><th>Tag</th><th>Actions</th></tr>
                            </thead>
                            <tbody id="product-list-tbody">
                                </tbody>
                        </table>
                    </div>
                    <p id="product-list-status">Loading products...</p>
                </div>

            </div>
            </div> </div> <div id="tickets-page-content" class="flex-grow container mx-auto px-6 py-10 page-section">
         <div class="flex justify-start mb-8">
             <a href="/#products" id="back-to-products-button-tickets" class="text-orange-400 hover:text-orange-300 flex items-center space-x-2 transition duration-200">
                 <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path></svg>
                 <span>Back to Products</span>
             </a>
         </div>
         <h2>Support Tickets</h2>

         <div id="moderator-management-view" class="hidden mb-8 ticket-card">
             <h3 class="text-xl font-semibold text-white mb-4 border-b border-slate-700 pb-2">Ticket Management</h3>
             <details class="mb-6" open> <summary>Active Tickets</summary>
                 <div id="moderator-active-ticket-list" class="ticket-list-container mt-3"></div>
                 <p id="moderator-active-list-status" class="text-sm text-gray-500 mt-4">Loading active tickets...</p>
             </details>
             <details> <summary>Archived Tickets</summary>
                 <div id="moderator-archived-ticket-list" class="ticket-list-container mt-3"></div>
                 <p id="moderator-archived-list-status" class="text-sm text-gray-500 mt-4">Loading archived tickets...</p>
             </details>
         </div>

         <div id="user-ticket-view" class="mb-8 ticket-card">
             <h3 class="text-xl font-semibold text-white mb-4">My Tickets</h3>
             <div id="ticket-list" class="ticket-list-container"></div>
             <p id="ticket-list-status" class="text-sm text-gray-500 mt-4">Loading tickets...</p>
         </div>

         <div class="ticket-card">
             <h3 class="text-xl font-semibold text-white mb-4">Create New Ticket</h3>
             <form id="create-ticket-form" novalidate>
                 <div class="mb-4">
                     <label for="ticket-subject" class="block text-sm font-medium text-gray-300 mb-1">Subject</label>
                     <input type="text" id="ticket-subject" name="ticket-subject" required class="w-full bg-slate-700 border border-slate-600 rounded-md py-2 px-3 text-white focus:outline-none focus:ring-2 focus:ring-orange-500 focus:border-transparent placeholder-gray-500">
                 </div>
                 <div class="mb-4">
                     <label for="ticket-message-input" class="block text-sm font-medium text-gray-300 mb-1">Message</label>
                     <textarea id="ticket-message-input" name="ticket-message-input" rows="6" required class="w-full bg-slate-700 border border-slate-600 rounded-md py-2 px-3 text-white focus:outline-none focus:ring-2 focus:ring-orange-500 focus:border-transparent placeholder-gray-500"></textarea>
                 </div>
                 <div id="create-ticket-status" class="h-6"></div>
                 <button type="submit" id="create-ticket-button" class="w-full bg-orange-600 hover:bg-orange-700 text-white font-medium py-2.5 px-6 rounded-lg transition duration-300">Submit Ticket</button>
             </form>
         </div>
     </div>

     <div id="ticket-detail-content" class="flex-grow container mx-auto px-6 py-10 page-section">
         <div class="flex justify-start mb-8">
             <a href="/#tickets" id="back-to-tickets-button" class="text-orange-400 hover:text-orange-300 flex items-center space-x-2 transition duration-200">
                 <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path></svg>
                 <span>Back to Tickets</span>
             </a>
         </div>
         <h2 id="ticket-detail-subject">Ticket Subject</h2>
         <div class="ticket-card">
             <div id="chat-messages"><p class="text-gray-500 text-center py-4">Loading chat...</p></div>
             <form id="chat-input-form" class="mt-4" novalidate>
                 <input type="text" id="chat-input" placeholder="Type your message..." required class="w-full">
                 <button type="submit" id="send-chat-button">Send</button>
             </form>
         </div>
     </div>

     <div id="product-detail-page-content" class="flex-grow container mx-auto px-6 py-10 page-section">
         <div class="flex justify-start mb-8">
             <a href="/#products" id="back-to-products-button-detail" class="text-orange-400 hover:text-orange-300 flex items-center space-x-2 transition duration-200">
                 <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path></svg>
                 <span>Back to Products</span>
             </a>
         </div>

         <div id="product-detail-loading" class="text-center text-gray-400">Loading product details...</div>

         <div id="product-detail-container" class="hidden grid grid-cols-1 lg:grid-cols-3 gap-8">
             <div class="lg:col-span-2 space-y-6">
                 <img id="product-detail-image" src="https://placehold.co/600x400/374151/9ca3af?text=Loading..." alt="Product Image" class="w-full aspect-video object-cover rounded-lg shadow-lg bg-slate-700">
                 <h1 id="product-detail-name" class="text-3xl md:text-4xl font-bold text-white">Product Name</h1>
                 <p id="product-detail-price" class="text-4xl font-extrabold text-white">$0.00</p>
                 <div class="flex items-center space-x-4 text-sm text-gray-400">
                     <span id="product-detail-rating" class="star-rating">
                         </span>
                     <span id="product-detail-stock">X in stock</span>
                 </div>
                 <div class="flex flex-col sm:flex-row items-center space-y-4 sm:space-y-0 sm:space-x-4 pt-4 border-t border-slate-700/50">
                     <button id="product-detail-buy-now" class="buy-now-button w-full sm:w-auto">Buy Now</button>
                     <button id="product-detail-add-basket" class="add-basket-button w-full sm:w-auto">Add to Basket</button>
                     <div class="flex items-center quantity-selector ml-auto">
                         <button id="quantity-decrease">-</button>
                         <input type="text" id="quantity-input" value="1" readonly>
                         <button id="quantity-increase">+</button>
                     </div>
                 </div>
                 <div id="product-detail-description-container" class="pt-4 border-t border-slate-700/50">
                    <h3 class="text-lg font-semibold text-white mb-2">Description</h3>
                    <p id="product-detail-description" class="text-gray-400 text-sm">Loading description...</p>
                 </div>
             </div>

             <div class="lg:col-span-1 space-y-6">
                 <div class="product-detail-card">
                     <h3 class="text-lg font-semibold text-white mb-4">Seller Information</h3>
                     <div class="flex items-center space-x-3 mb-3">
                         <img id="seller-avatar" src="https://placehold.co/40x40/7f8c8d/ecf0f1?text=S" alt="Seller Avatar" class="w-10 h-10 rounded-full bg-slate-600">
                         <div>
                             <p id="seller-name" class="font-medium text-white">Seller Name</p>
                             <p id="seller-established" class="text-xs text-gray-400">Established X months ago</p>
                         </div>
                     </div>
                 </div>
                 <div class="product-detail-card">
                    <h3 class="text-lg font-semibold text-white mb-3">Need help?</h3>
                    <a href="/#tickets" id="product-detail-open-ticket" class="text-orange-400 hover:text-orange-300 text-sm flex items-center space-x-1.5">
                        <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path></svg>
                        <span>Open a ticket</span>
                    </a>
                 </div>
                 <div class="product-detail-card space-y-4">
                    <h3 class="text-lg font-semibold text-white mb-3">Not quite sure?</h3>
                    <div class="flex items-start space-x-3">
                        <svg class="w-5 h-5 text-blue-400 mt-0.5 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-8.707l-3-3a1 1 0 00-1.414 1.414L10.586 9H7a1 1 0 100 2h3.586l-1.293 1.293a1 1 0 101.414 1.414l3-3a1 1 0 000-1.414z" clip-rule="evenodd"></path></svg>
                        <div>
                            <p class="text-sm font-medium text-white">Instant delivery</p>
                            <p class="text-xs text-gray-400">Your product will be delivered within minutes</p>
                        </div>
                    </div>
                     <div class="flex items-start space-x-3">
                        <svg class="w-5 h-5 text-blue-400 mt-0.5 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M2.003 5.884L10 9.882l7.997-3.998A2 2 0 0016 4H4a2 2 0 00-1.997 1.884z"></path><path d="M18 8.118l-8 4-8-4V14a2 2 0 002 2h12a2 2 0 002-2V8.118z"></path></svg>
                        <div>
                            <p class="text-sm font-medium text-white">Integrated tickets with sellers</p>
                            <p class="text-xs text-gray-400">You can contact the seller directly if you have any issues</p>
                        </div>
                    </div>
                     <div class="flex items-start space-x-3">
                        <svg class="w-5 h-5 text-yellow-400 mt-0.5 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"></path></svg>
                        <div>
                            <p class="text-sm font-medium text-white">Good average review score</p>
                            <p id="seller-review-score" class="text-xs text-gray-400">The seller has an average review score of X stars out of 5</p>
                        </div>
                    </div>
                 </div>
             </div>

             <div class="lg:col-span-3 mt-8">
                 <h2 class="text-2xl font-bold text-white mb-6 text-left">Reviews</h2>
                 <div id="product-reviews-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                     <p class="text-gray-400 md:col-span-2 lg:col-span-3">Loading reviews...</p>
                     </div>
             </div>
         </div>
     </div>


    <footer class="bg-black mt-auto py-6 border-t border-gray-800">
        <div class="container mx-auto px-6 text-center text-gray-500 text-sm">
            <p>&copy; <span id="footer-year">2025</span> Shillette. All rights reserved.</p>
        </div>
    </footer>

    <script>
        const pageSections = {
            '#home': 'main-content',
            '#products': 'products-page-content',
            '#tickets': 'tickets-page-content',
            '#dashboard': 'dashboard-content',
            '#ticketDetail': 'ticket-detail-content',
            '#productDetail': 'product-detail-page-content'
        };
        const siteTitleDisplay = document.getElementById('site-title-display');
        const mainNavigation = document.getElementById('main-navigation');
        const mobileMenuNav = document.getElementById('mobile-menu');
        const loginButton = document.getElementById('login-button');
        const logoutButton = document.getElementById('logout-button');
        const dashboardLogoutButton = document.getElementById('dashboard-logout-button');
        const userInfo = document.getElementById('user-info');
        const userNameDisplay = document.getElementById('user-name');
        const userAvatarDisplay = document.getElementById('user-avatar');
        const dashboardUserNameDisplay = document.getElementById('dashboard-user-name');
        const dashboardUserAvatarDisplay = document.getElementById('dashboard-user-avatar');
        const dashboardUserRolesContainer = document.getElementById('dashboard-user-roles');
        const snowContainer = document.getElementById('snow-container');
        const paymentMessage = document.getElementById('payment-message');
        const ticketMessagePopup = document.getElementById('ticket-message');
        const errorMessagePopup = document.getElementById('error-message');
        const configMessagePopup = document.getElementById('config-message');
        const productMessagePopup = document.getElementById('product-message');
        const loadingOverlay = document.getElementById('loading-overlay');
        const createTicketForm = document.getElementById('create-ticket-form');
        const ticketSubjectInput = document.getElementById('ticket-subject');
        const ticketMessageInput = document.getElementById('ticket-message-input');
        const createTicketStatus = document.getElementById('create-ticket-status');
        const userTicketView = document.getElementById('user-ticket-view');
        const moderatorManagementView = document.getElementById('moderator-management-view');
        const ticketListDiv = document.getElementById('ticket-list');
        const ticketListStatus = document.getElementById('ticket-list-status');
        const moderatorActiveTicketListDiv = document.getElementById('moderator-active-ticket-list');
        const moderatorActiveListStatus = document.getElementById('moderator-active-list-status');
        const moderatorArchivedTicketListDiv = document.getElementById('moderator-archived-ticket-list');
        const moderatorArchivedListStatus = document.getElementById('moderator-archived-list-status');
        const ticketDetailSubject = document.getElementById('ticket-detail-subject');
        const chatMessagesDiv = document.getElementById('chat-messages');
        const chatInputForm = document.getElementById('chat-input-form');
        const chatInput = document.getElementById('chat-input');
        const sendChatButton = document.getElementById('send-chat-button');
        const backToTicketsButton = document.getElementById('back-to-tickets-button');
        const userInfoModal = document.getElementById('user-info-modal');
        const modalCloseButton = document.getElementById('modal-close-button');
        const modalUsername = document.getElementById('modal-username');
        const modalUserId = document.getElementById('modal-user-id');
        const modalUserRoles = document.getElementById('modal-user-roles');
        const chatContextMenu = document.getElementById('chat-context-menu');
        const contextDeleteButton = document.getElementById('context-delete-message');
        const contextUserInfoButton = document.getElementById('context-user-info');
        const ticketContextMenu = document.getElementById('ticket-context-menu');
        const contextCloseTicketButton = document.getElementById('context-close-ticket');
        const contextReopenTicketButton = document.getElementById('context-reopen-ticket');
        const contextDeleteTicketButton = document.getElementById('context-delete-ticket');
        const mobileMenuButton = document.getElementById('mobile-menu-button');
        const productGrid = document.getElementById('product-grid');
        const productLoadingStatus = document.getElementById('product-loading-status');
        const adminDashboardSections = document.getElementById('admin-dashboard-sections');
        const siteConfigForm = document.getElementById('site-config-form');
        const configSiteTitleInput = document.getElementById('config-site-title');
        const configHeaderLinksContainer = document.getElementById('config-header-links-container');
        const addHeaderLinkButton = document.getElementById('add-header-link-button');
        const saveConfigButton = document.getElementById('save-config-button');
        const configSaveStatus = document.getElementById('config-save-status');
        const addProductButton = document.getElementById('add-product-button');
        const productListTableBody = document.getElementById('product-list-tbody');
        const productListStatus = document.getElementById('product-list-status');
        const productEditModal = document.getElementById('product-edit-modal');
        const productModalCloseButton = document.getElementById('product-modal-close-button');
        const productModalTitle = document.getElementById('product-modal-title');
        const productEditForm = document.getElementById('product-edit-form');
        const productEditIdInput = document.getElementById('product-edit-id');
        const productEditNameInput = document.getElementById('product-edit-name');
        const productEditThumbnailInput = document.getElementById('product-edit-thumbnail');
        const productEditThumbnailFileInput = document.getElementById('product-edit-thumbnail-file');
        const productEditThumbnailButton = document.getElementById('product-edit-thumbnail-button');
        const productEditThumbnailFilename = document.getElementById('product-edit-thumbnail-filename');
        const productEditPriceInput = document.getElementById('product-edit-price');
        const productEditTagInput = document.getElementById('product-edit-tag');
        const productEditTagColorSelect = document.getElementById('product-edit-tagColor');
        const productEditCustomHexInput = document.getElementById('product-edit-customHex');
        const customHexInputContainer = document.getElementById('custom-hex-input-container');
        const productEditDescriptionInput = document.getElementById('product-edit-description');
        const productEditFeaturesInput = document.getElementById('product-edit-features');
        const productEditPaymentLinkInput = document.getElementById('product-edit-paymentLink');
        const productSaveButton = document.getElementById('product-save-button');
        const productEditStatus = document.getElementById('product-edit-status');
        const footerYear = document.getElementById('footer-year');
        const productDetailPage = document.getElementById('product-detail-page-content');
        const productDetailLoading = document.getElementById('product-detail-loading');
        const productDetailContainer = document.getElementById('product-detail-container');
        const productDetailImage = document.getElementById('product-detail-image');
        const productDetailName = document.getElementById('product-detail-name');
        const productDetailPrice = document.getElementById('product-detail-price');
        const productDetailRating = document.getElementById('product-detail-rating');
        const productDetailStock = document.getElementById('product-detail-stock');
        const productDetailBuyNow = document.getElementById('product-detail-buy-now');
        const productDetailAddBasket = document.getElementById('product-detail-add-basket');
        const quantityDecrease = document.getElementById('quantity-decrease');
        const quantityIncrease = document.getElementById('quantity-increase');
        const quantityInput = document.getElementById('quantity-input');
        const productDetailDescriptionContainer = document.getElementById('product-detail-description-container');
        const productDetailDescription = document.getElementById('product-detail-description');
        const sellerAvatar = document.getElementById('seller-avatar');
        const sellerName = document.getElementById('seller-name');
        const sellerEstablished = document.getElementById('seller-established');
        const sellerReviewScore = document.getElementById('seller-review-score');
        const productReviewsList = document.getElementById('product-reviews-list');

        const API_BASE_URL = 'https://api.shillette.com';
        const SOCKET_URL = 'https://api.shillette.com';

        let currentUser = null;
        let siteConfig = null;
        let socket = null;
        let currentTicketId = null;
        let activeSectionId = null;
        let currentContextMenu = null;
        let contextMenuData = { ticketId: null, messageTimestamp: null, senderId: null, ticketStatus: null };
        let isInitialLoginCheckComplete = false;
        let isInitialConfigLoadComplete = false;

        function showPopupMessage(element, message, isError = false, duration = 3500) {
             if (!element) return;
             element.textContent = message;
             element.classList.toggle('bg-red-600', isError);
             element.classList.toggle('bg-green-600', !isError);
             element.classList.add('show');
             setTimeout(() => element.classList.remove('show'), duration);
        }

        function updateHeaderUI(user) {
             const isLoggedIn = user && user.logged_in;
             loginButton.classList.toggle('hidden', isLoggedIn);
             userInfo.classList.toggle('hidden', !isLoggedIn);
             userInfo.classList.toggle('flex', isLoggedIn);

             if (isLoggedIn) {
                 userNameDisplay.textContent = user.username || 'User';
                 userAvatarDisplay.src = user.user_id && user.avatar ? `https://cdn.discordapp.com/avatars/${user.user_id}/${user.avatar}.png?size=32` : 'https://placehold.co/32x32/7f8c8d/ecf0f1?text=?';
                 dashboardUserNameDisplay.textContent = user.username || 'User';
                 dashboardUserAvatarDisplay.src = user.user_id && user.avatar ? `https://cdn.discordapp.com/avatars/${user.user_id}/${user.avatar}.png?size=64` : 'https://placehold.co/64x64/7f8c8d/ecf0f1?text=?';

                 const isMod = user.is_moderator === true;
                 console.log(`[updateHeaderUI] Toggling admin sections. Moderator status: ${isMod} (Raw value: ${user.is_moderator})`);
                 adminDashboardSections?.classList.toggle('hidden', !isMod);

             } else {
                 dashboardUserNameDisplay.textContent = 'User';
                 dashboardUserAvatarDisplay.src = 'https://placehold.co/64x64/7f8c8d/ecf0f1?text=?';
                 adminDashboardSections?.classList.add('hidden');
             }
        }

        function showSection(sectionElementId) {
            console.log(`[showSection] Attempting to show element ID: ${sectionElementId}`);
            hideContextMenu();

            let foundSection = false;
            Object.values(pageSections).forEach(id => {
                const sectionElement = document.getElementById(id);
                if (sectionElement) {
                    sectionElement.classList.remove('active');
                    sectionElement.classList.add('hidden');
                } else {
                    console.warn(`[showSection] Element not found for ID: ${id}`);
                }
            });

            const targetElement = document.getElementById(sectionElementId);
            if (targetElement) {
                targetElement.classList.remove('hidden');
                targetElement.classList.add('active');
                activeSectionId = sectionElementId;
                foundSection = true;
                console.log(`[showSection] Successfully shown: ${sectionElementId}`);
                window.scrollTo(0, 0);
            }

            if (!foundSection) {
                console.warn(`[showSection] Target element ID not found: ${sectionElementId}. Defaulting to home.`);
                const homeElement = document.getElementById(pageSections['#home']);
                if (homeElement) {
                    homeElement.classList.remove('hidden');
                    homeElement.classList.add('active');
                    activeSectionId = pageSections['#home'];
                    console.log(`[showSection] Defaulted to ${activeSectionId}.`);
                    window.scrollTo(0, 0);
                } else {
                     activeSectionId = null;
                     console.error("[showSection] Could not find home element either!");
                }
            }

            const isTicketRelated = sectionElementId === pageSections['#ticketDetail'] || sectionElementId === pageSections['#tickets'];
            if (!isTicketRelated) {
                 console.log(`[showSection] Navigating away from tickets/detail, disconnecting socket.`);
                 disconnectSocket();
             }
            if (sectionElementId !== pageSections['#ticketDetail']) {
                 currentTicketId = null;
            }
        }

        function navigateTo(hash) {
            console.log(`[navigateTo] Received hash: ${hash}`);
            const hashParts = hash.split('?');
            const baseHash = hashParts[0] || '#home';
            const targetElementId = pageSections[baseHash] || pageSections['#home'];

            console.log(`[navigateTo] Base hash: ${baseHash}, Target element ID: ${targetElementId}`);

            const isProtected = ['#dashboard', '#tickets', '#ticketDetail', '#productDetail'].includes(baseHash);

            if (isProtected && (!isInitialLoginCheckComplete || !isInitialConfigLoadComplete)) {
                console.log(`[navigateTo] Initial checks not complete for protected route ${baseHash}. Deferring action.`);
                return;
            }

            if (['#dashboard', '#tickets', '#ticketDetail'].includes(baseHash) && (!currentUser || !currentUser.logged_in)) {
                console.log(`[navigateTo] Access denied to protected route: ${baseHash}`);
                showPopupMessage(errorMessagePopup, "Please log in to view this page.", true);
                if (window.location.hash !== '#home' && window.location.hash !== '/#home') {
                    console.log(`[navigateTo] Redirecting to /#home`);
                    window.location.hash = '/#home';
                } else {
                    console.log(`[navigateTo] Already on home, ensuring #home section is shown.`);
                    if(activeSectionId !== pageSections['#home']) showSection(pageSections['#home']);
                }
                return;
            }

            if (['#tickets', '#ticketDetail'].includes(baseHash)) {
                console.log(`[navigateTo] Ensuring socket is connected for route: ${baseHash}`);
                ensureSocketConnected();
            }

            let idParam = null;
            if (baseHash === '#ticketDetail' || baseHash === '#productDetail') {
                 const params = new URLSearchParams(hashParts[1] || '');
                 idParam = params.get('id');
                 console.log(`[navigateTo] ID from URL: ${idParam}`);
            }

            if (baseHash === '#ticketDetail') {
                if (idParam) {
                    if (currentTicketId !== idParam) {
                        currentTicketId = idParam;
                        ticketDetailSubject.textContent = `Ticket #${idParam.slice(-6)}`;
                        chatMessagesDiv.innerHTML = '<p class="text-gray-500 text-center py-4">Connecting to chat...</p>';
                        fetchTicketDetails(idParam);
                    } else {
                         console.log(`[navigateTo] Already viewing ticket ${idParam}, not re-fetching details.`);
                         if (socket && socket.connected) socket.emit('join_ticket_room', { ticket_id: currentTicketId });
                    }
                } else {
                    console.warn("[navigateTo] Ticket ID missing for detail view. Redirecting to tickets list.");
                    showPopupMessage(errorMessagePopup, "Invalid ticket link.", true);
                    window.location.hash = '/#tickets';
                    return;
                }
            } else if (baseHash === '#productDetail') {
                 if (idParam) {
                      console.log(`[navigateTo] Fetching product details for ID: ${idParam}`);
                      fetchProductDetails(idParam);
                 } else {
                      console.warn("[navigateTo] Product ID missing for detail view. Redirecting to products list.");
                      showPopupMessage(errorMessagePopup, "Invalid product link.", true);
                      window.location.hash = '/#products';
                      return;
                 }
            }

            showSection(targetElementId);

            if (baseHash === '#tickets') {
                console.log(`[navigateTo] Fetching tickets for #tickets view.`);
                fetchTickets();
            } else if (baseHash === '#products') {
                 console.log(`[navigateTo] Fetching products for #products view.`);
                 fetchProducts();
            } else if (baseHash === '#dashboard' && currentUser?.logged_in) {
                 console.log(`[navigateTo] Loading dashboard data. User:`, currentUser);
                 displayUserRoles(currentUser.roles);
                 if (currentUser.is_moderator === true) {
                     console.log(`[navigateTo] User is moderator, loading admin data.`);
                     loadAdminDashboardData();
                 } else {
                     console.log(`[navigateTo] User is NOT moderator, skipping admin data load.`);
                 }
            }

            updateHeaderUI(currentUser);
        }

        function runNavigation() {
            console.log(`[runNavigation] Processing raw hash: ${window.location.hash}`);
            const rawHash = window.location.hash;
            let pathPart = '';
            let queryPart = '';
            const queryIndex = rawHash.indexOf('?');
            const firstHashIndex = rawHash.indexOf('#');

            if (firstHashIndex !== -1) {
                const hashContent = queryIndex !== -1 ? rawHash.substring(firstHashIndex + 1, queryIndex) : rawHash.substring(firstHashIndex + 1);
                pathPart = hashContent;
                while (pathPart.startsWith('/') || pathPart.startsWith('#')) {
                    pathPart = pathPart.substring(1);
                }
                if(queryIndex !== -1) {
                    queryPart = rawHash.substring(queryIndex);
                }
            }
            const hashToNavigate = `#${pathPart || 'home'}${queryPart}`;
            console.log(`[runNavigation] Cleaned hash to navigate: ${hashToNavigate}`);

            if ((isInitialLoginCheckComplete && isInitialConfigLoadComplete) || pathPart === '' || pathPart === 'home') {
                navigateTo(hashToNavigate);
            } else {
                console.log(`[runNavigation] Initial checks not complete for target ${hashToNavigate}. Deferring.`);
            }
        }

        function createSnowflakes() {
            const numberOfSnowflakes = 75;
            if (!snowContainer) return;
            snowContainer.innerHTML = '';
            for (let i = 0; i < numberOfSnowflakes; i++) {
                const snowflake = document.createElement('div');
                snowflake.classList.add('snowflake');
                const size = Math.random() * 3 + 2;
                const duration = Math.random() * 10 + 5;
                const delay = Math.random() * 10;
                const startLeft = Math.random() * 100;
                const opacity = Math.random() * 0.5 + 0.5;

                snowflake.style.width = `${size}px`;
                snowflake.style.height = `${size}px`;
                snowflake.style.left = `${startLeft}vw`;
                snowflake.style.opacity = opacity;
                snowflake.style.animationDuration = `${duration}s`;
                snowflake.style.animationDelay = `-${delay}s`;

                snowContainer.appendChild(snowflake);
            }
        }

        async function checkLoginStatus() {
             isInitialLoginCheckComplete = false;
             try {
                 const response = await fetch(`${API_BASE_URL}/api/user`, { credentials: 'include' });
                 if (!response.ok && (response.status === 401 || response.status === 403)) {
                     currentUser = { logged_in: false };
                 } else if (!response.ok) {
                     throw new Error(`HTTP error! status: ${response.status}`);
                 } else {
                     currentUser = await response.json();
                 }
                 console.log("[checkLoginStatus] User status checked:", currentUser);
                 if (currentUser && currentUser.logged_in) {
                     ensureSocketConnected();
                 }
             } catch (error) {
                 console.error("[checkLoginStatus] Error checking login status:", error);
                 currentUser = { logged_in: false };
                 showPopupMessage(errorMessagePopup, "Could not verify login status.", true);
             } finally {
                 isInitialLoginCheckComplete = true;
                 console.log("[checkLoginStatus] Initial login check complete.");
                 loadSiteConfigAndNavigate();
             }
        }

        async function loadSiteConfigAndNavigate() {
            isInitialConfigLoadComplete = false;
            try {
                const response = await fetch(`${API_BASE_URL}/api/config`);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                siteConfig = await response.json();
                console.log("[loadSiteConfig] Site config loaded:", siteConfig);
                applySiteConfig(siteConfig);
            } catch (error) {
                console.error("[loadSiteConfig] Error loading site config:", error);
                showPopupMessage(errorMessagePopup, "Failed to load site configuration. Using defaults.", true);
                applySiteConfig(null);
            } finally {
                isInitialConfigLoadComplete = true;
                console.log("[loadSiteConfig] Initial config load complete.");
                runNavigation();
            }
        }

        function applySiteConfig(config) {
            const title = config?.siteTitle || "Shillette";
            const links = config?.headerLinks || [
                {name: "Home", href: "/#home"}, {name: "Products", href: "/#products"},
                {name: "Tickets", href: "/#tickets"}, {name: "Discord", href: "https://discord.gg/shillette", target: "_blank"}
            ];

            document.title = title;
            siteTitleDisplay.textContent = title;

            mainNavigation.innerHTML = '';
            mobileMenuNav.innerHTML = '';
            links.forEach(link => {
                const a = document.createElement('a');
                a.href = link.href;
                a.textContent = link.name;
                a.classList.add('text-gray-300', 'hover:text-white', 'transition', 'duration-200');
                if (link.target) a.target = link.target;
                if (link.target === '_blank') a.rel = 'noopener noreferrer';
                mainNavigation.appendChild(a);

                const mob_a = a.cloneNode(true);
                mob_a.classList.remove('text-gray-300', 'hover:text-white');
                mob_a.classList.add('mobile-menu-link');
                mob_a.addEventListener('click', () => mobileMenuNav.classList.add('hidden'));
                mobileMenuNav.appendChild(mob_a);
            });

            footerYear.textContent = new Date().getFullYear();
        }

        async function fetchProducts() {
             if (!productGrid || !productLoadingStatus) return;
             productGrid.innerHTML = '';
             productLoadingStatus.textContent = 'Loading products...';
             productLoadingStatus.classList.remove('hidden');

             try {
                 const response = await fetch(`${API_BASE_URL}/api/products`);
                 if (!response.ok) throw new Error(`HTTP ${response.status}`);
                 const products = await response.json();

                 productLoadingStatus.classList.add('hidden');

                 if (!products || products.length === 0) {
                     productGrid.innerHTML = `<p class="text-center text-gray-400 md:col-span-2 lg:col-span-3">No products available at this time.</p>`;
                     return;
                 }

                 products.forEach(renderProductCard);

             } catch (error) {
                 console.error("Error fetching products:", error);
                 productLoadingStatus.textContent = 'Failed to load products.';
                 showPopupMessage(errorMessagePopup, `Error loading products: ${error.message}`, true);
             }
        }

        function renderProductCard(product) {
             if (!productGrid || !product) return;

             const card = document.createElement('div');
             card.className = `product-card flex flex-col`;
             card.dataset.productId = product._id;

             const tagColor = product.tagColor || 'gray';
             const customHex = product.customBorderHex;
             let borderClasses = '';
             let inlineStyle = '';
             let hoverStyleVar = '';

             if (customHex && /^#[0-9A-F]{6}$/i.test(customHex)) {
                 borderClasses = 'custom-border';
                 inlineStyle = `border-color: ${customHex};`;
                 hoverStyleVar = `--custom-hover-shadow: 0 0 8px 1px ${customHex}99, 0 0 16px 4px ${customHex}66, 0 0 32px 8px ${customHex}33;`;
                 card.style.cssText = inlineStyle + hoverStyleVar;
                 card.classList.add(borderClasses);
             } else if (tagColor !== 'custom') {
                 borderClasses = `card-gradient-border ${tagColor}-border`;
                 card.classList.add(...borderClasses.split(' '));
             } else {
                  borderClasses = `card-gradient-border gray-border`;
                  card.classList.add(...borderClasses.split(' '));
             }

             const displayTagColor = (tagColor === 'custom' && !customHex) ? 'gray' : tagColor;
             const tagBgClass = `bg-${displayTagColor}-500/20`;
             const tagTextClass = `text-${displayTagColor}-300`;

             let thumbnailElement = null;
             const placeholderDiv = document.createElement('div');
             placeholderDiv.className = 'product-thumbnail-placeholder';
             placeholderDiv.style.display = 'none';
             placeholderDiv.innerHTML = '<span>Image not found</span>';

             if (product.thumbnailUrl && product.thumbnailUrl.trim() !== '') {
                 thumbnailElement = document.createElement('img');
                 thumbnailElement.src = product.thumbnailUrl;
                 thumbnailElement.alt = `${product.name || 'Product'} thumbnail`;
                 thumbnailElement.className = 'product-thumbnail';
                 thumbnailElement.onerror = () => {
                     if (thumbnailElement) thumbnailElement.style.display = 'none';
                     placeholderDiv.style.display = 'flex';
                 };
             } else {
                 placeholderDiv.style.display = 'flex';
                 thumbnailElement = null;
             }

             const innerDiv = document.createElement('div');
             innerDiv.className = 'product-card-inner';
             innerDiv.innerHTML = `
                 <div class="flex justify-between items-center mb-4">
                     <span class="${tagBgClass} ${tagTextClass} text-xs font-semibold px-2.5 py-0.5 rounded">${product.tag || 'PRODUCT'}</span>
                 </div>
                 <h3 class="text-xl font-semibold text-white mb-2">${product.name || 'Unnamed Product'}</h3>
                 <p class="text-3xl font-bold text-white mb-4">$${product.price?.toFixed(2) || 'N/A'}</p>
                 <ul class="text-sm text-gray-400 space-y-2 mb-6 flex-grow">
                     ${(product.features || []).map(feature => `<li class="flex items-center"><svg class="w-4 h-4 mr-2 text-green-500" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path></svg> ${feature}</li>`).join('')}
                     ${!(product.features && product.features.length > 0) ? '<li class="text-gray-500">No features listed.</li>' : ''}
                 </ul>
                 <div class="mt-auto space-y-3 pt-4 border-t border-slate-700/50">
                     ${product.paymentLink ? `<button class="purchase-button" data-product-id="${product._id}" data-payment-link="${product.paymentLink}">Pay with PayPal</button>` : '<button class="purchase-button" disabled>Purchase Unavailable</button>'}
                 </div>
             `;

             if (thumbnailElement) {
                 card.appendChild(thumbnailElement);
             }
             card.appendChild(placeholderDiv);
             card.appendChild(innerDiv);

             card.addEventListener('click', (event) => {
                 if (event.target.closest('.purchase-button')) {
                     handlePurchaseClick(event);
                     return;
                 }
                 const productId = card.dataset.productId;
                 if (productId) {
                     window.location.hash = `/#productDetail?id=${productId}`;
                 }
             });

             productGrid.appendChild(card);
        }


        function handlePurchaseClick(event) {
            event.stopPropagation();
            const button = event.target.closest('.purchase-button');
            if (!button) return;
            const productId = button.dataset.productId;
            const paymentLink = button.dataset.paymentLink;
            console.log(`Purchase clicked for product ID: ${productId}, Link/ID: ${paymentLink}`);
            if (paymentLink) {
                 showPopupMessage(paymentMessage, `Initiating purchase for product ${productId}... (Integration needed)`);
            } else {
                 showPopupMessage(errorMessagePopup, 'Payment link is missing for this product.', true);
            }
        }

        async function fetchProductDetails(productId) {
            if (!productDetailPage || !productDetailLoading || !productDetailContainer) return;

            productDetailLoading.classList.remove('hidden');
            productDetailContainer.classList.add('hidden');
            productDetailPage.classList.remove('hidden');

            try {
                const response = await fetch(`${API_BASE_URL}/api/products/${productId}`);
                if (!response.ok) {
                    if (response.status === 404) throw new Error("Product not found.");
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const productData = await response.json();
                renderProductDetails(productData);
                productDetailLoading.classList.add('hidden');
                productDetailContainer.classList.remove('hidden');

            } catch (error) {
                console.error("Error fetching product details:", error);
                productDetailLoading.textContent = `Error loading product: ${error.message}`;
                showPopupMessage(errorMessagePopup, `Error loading product: ${error.message}`, true);
            }
        }

        function renderProductDetails(product) {
            if (!product) return;

            productDetailImage.src = product.thumbnailUrl || 'https://placehold.co/600x400/374151/9ca3af?text=No+Image';
            productDetailImage.alt = product.name || 'Product Image';
            productDetailName.textContent = product.name || 'Product Name';
            productDetailPrice.textContent = product.price ? `$${product.price.toFixed(2)}` : 'Price unavailable';

            const rating = product.averageRating || 5;
            const stock = product.stock !== undefined ? product.stock : 6;
            productDetailRating.innerHTML = `${'★'.repeat(rating)}${'☆'.repeat(5 - rating)}`;
            productDetailStock.textContent = `${stock} in stock`;

             if (product.description) {
                productDetailDescription.textContent = product.description;
                productDetailDescriptionContainer.classList.remove('hidden');
             } else {
                productDetailDescriptionContainer.classList.add('hidden');
             }

            sellerName.textContent = product.sellerName || 'ShilletteFN';
            sellerEstablished.textContent = product.sellerEstablishedDate ? `Established ${formatTimeAgo(product.sellerEstablishedDate)}` : 'Established 7 months ago';
            sellerReviewScore.textContent = `The seller has an average review score of ${rating} stars out of 5`;

            productReviewsList.innerHTML = '';
            const reviews = product.reviews || [];

            if (reviews.length > 0) {
                reviews.forEach(review => {
                    const reviewCard = document.createElement('div');
                    reviewCard.className = 'review-card';
                    const reviewRating = review.rating || 5;
                    const reviewDate = review.createdAt ? new Date(review.createdAt).toLocaleDateString() : 'recently';
                    const reviewerName = review.reviewerName || 'Verified customer';

                    reviewCard.innerHTML = `
                        <div class="flex justify-between items-center mb-2">
                            <span class="text-xs text-green-400 font-medium">Verified purchase</span>
                            <span class="star-rating text-sm">${'★'.repeat(reviewRating)}${'☆'.repeat(5 - reviewRating)}</span>
                        </div>
                        <p class="text-sm text-gray-300 mb-1">${review.text || 'Automatically left after 3 days of purchase'}</p>
                        <p class="text-xs text-gray-500">Reviewed by ${reviewerName} on ${reviewDate}</p>
                    `;
                    productReviewsList.appendChild(reviewCard);
                });
            } else {
                productReviewsList.innerHTML = '<p class="text-gray-400 md:col-span-2 lg:col-span-3">No reviews yet.</p>';
            }
        }

        function formatTimeAgo(dateString) {
            try {
                const date = new Date(dateString);
                const now = new Date();
                const diffMonths = (now.getFullYear() - date.getFullYear()) * 12 + (now.getMonth() - date.getMonth());
                if (diffMonths < 1) return 'less than a month ago';
                if (diffMonths === 1) return '1 month ago';
                return `${diffMonths} months ago`;
            } catch (e) {
                return 'a while ago';
            }
        }


        async function fetchTickets() {
            console.log("[fetchTickets] Starting...");
            if (!userTicketView || !moderatorManagementView || !ticketListDiv || !ticketListStatus || !moderatorActiveTicketListDiv || !moderatorActiveListStatus || !moderatorArchivedTicketListDiv || !moderatorArchivedListStatus) {
                console.error("[fetchTickets] One or more ticket list elements not found."); return;
            }
            if (!currentUser || !currentUser.logged_in) {
                console.log("[fetchTickets] User not logged in.");
                ticketListStatus.textContent = "Please log in to view tickets.";
                moderatorActiveListStatus.textContent = "Please log in to view tickets.";
                moderatorArchivedListStatus.textContent = "Please log in to view tickets.";
                ticketListDiv.innerHTML = ''; moderatorActiveTicketListDiv.innerHTML = ''; moderatorArchivedTicketListDiv.innerHTML = '';
                userTicketView.classList.remove('hidden'); moderatorManagementView.classList.add('hidden'); return;
            }

            ticketListStatus.textContent = "Loading tickets...";
            moderatorActiveListStatus.textContent = "Loading active tickets...";
            moderatorArchivedListStatus.textContent = "Loading archived tickets...";
            ticketListDiv.innerHTML = ''; moderatorActiveTicketListDiv.innerHTML = ''; moderatorArchivedTicketListDiv.innerHTML = '';

            const isMod = currentUser.is_moderator === true;
            console.log(`[fetchTickets] Is moderator: ${isMod}`);
            userTicketView.classList.toggle('hidden', isMod);
            moderatorManagementView.classList.toggle('hidden', !isMod);

            try {
                const response = await fetch(`${API_BASE_URL}/api/tickets`, { credentials: 'include' });
                if (!response.ok) {
                     if (response.status === 401 || response.status === 403) throw new Error("Authentication required.");
                     else throw new Error(`HTTP error! status: ${response.status}`);
                }
                const tickets = await response.json();
                console.log(`[fetchTickets] Received ${tickets.length} tickets.`);

                ticketListStatus.textContent = ""; moderatorActiveListStatus.textContent = ""; moderatorArchivedListStatus.textContent = "";
                let hasActive = false; let hasArchived = false;

                if (tickets.length === 0) {
                    if (isMod) {
                        moderatorActiveListStatus.textContent = "No active tickets found.";
                        moderatorArchivedListStatus.textContent = "No archived tickets found.";
                    } else {
                        ticketListStatus.textContent = "You have no support tickets.";
                    }
                } else {
                    tickets.forEach(ticket => {
                        const item = document.createElement('div');
                        item.classList.add('ticket-list-item');
                        item.dataset.ticketId = ticket._id;
                        item.dataset.ticketStatus = ticket.status;
                        item.dataset.ticketSubject = ticket.subject || 'No Subject';

                        const statusClass = ticket.status === 'open' ? 'status-open' : 'status-closed';
                        const statusText = ticket.status ? ticket.status.charAt(0).toUpperCase() + ticket.status.slice(1) : 'N/A';
                        const dateOpened = ticket.created_at ? new Date(ticket.created_at).toLocaleDateString() : 'N/A';
                        const shortId = ticket._id ? ticket._id.slice(-6) : 'N/A';
                        const subject = ticket.subject || 'No Subject';
                        const username = ticket.username || 'Unknown User';

                        item.innerHTML = `
                            <div>
                                <p class="font-medium text-white">#${shortId}: ${subject}</p>
                                <p class="text-xs text-gray-400">User: ${username} | Opened: ${dateOpened}</p>
                            </div>
                            <span class="${statusClass}">${statusText}</span>`;

                        item.addEventListener('click', (e) => {
                            e.preventDefault();
                            const targetHash = `/#ticketDetail?id=${ticket._id}`;
                            console.log(`[fetchTickets] Ticket item clicked: ID=${ticket._id}. Setting hash to: ${targetHash}`);
                            window.location.hash = targetHash;
                        });
                        item.addEventListener('contextmenu', showTicketContextMenu);

                        if (isMod) {
                            if (ticket.status === 'open') { moderatorActiveTicketListDiv.appendChild(item); hasActive = true; }
                            else { moderatorArchivedTicketListDiv.appendChild(item); hasArchived = true; }
                        } else {
                            ticketListDiv.appendChild(item);
                        }
                    });
                    if (isMod) {
                        if (!hasActive) moderatorActiveListStatus.textContent = "No active tickets found.";
                        if (!hasArchived) moderatorArchivedListStatus.textContent = "No archived tickets found.";
                    }
                }
            } catch (error) {
                console.error("[fetchTickets] Error fetching tickets:", error);
                const errorMsg = `Failed to load tickets: ${error.message}`;
                ticketListStatus.textContent = errorMsg; moderatorActiveListStatus.textContent = errorMsg; moderatorArchivedListStatus.textContent = errorMsg;
                showPopupMessage(errorMessagePopup, `Error fetching tickets: ${error.message}`, true);
            }
        }
        async function fetchTicketDetails(ticketId) {
            console.log(`[fetchTicketDetails] Fetching details for ticket: ${ticketId}`);
            if (!currentUser || !currentUser.logged_in) return;
            ensureSocketConnected();
            chatMessagesDiv.innerHTML = '<p class="text-gray-500 text-center py-4">Loading messages...</p>';
            if (backToTicketsButton) backToTicketsButton.href = '/#tickets';

            try {
                const response = await fetch(`${API_BASE_URL}/api/tickets/${ticketId}`, { credentials: 'include' });
                if (!response.ok) {
                    if (response.status === 401 || response.status === 403) throw new Error("Forbidden or Not Authenticated.");
                    if (response.status === 404) throw new Error("Ticket not found.");
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const ticket = await response.json();
                console.log(`[fetchTicketDetails] Received details for ticket: ${ticketId}`);

                ticketDetailSubject.textContent = ticket.subject || `Ticket #${ticketId.slice(-6)}`;
                chatMessagesDiv.innerHTML = '';

                if (ticket.messages && ticket.messages.length > 0) {
                    ticket.messages.forEach(appendChatMessage);
                } else {
                    chatMessagesDiv.innerHTML = '<p class="text-gray-500 text-center py-4">No messages in this ticket yet.</p>';
                }

                if (socket && socket.connected) {
                    console.log(`[fetchTicketDetails] Emitting join_ticket_room for: ${ticketId}`);
                    socket.emit('join_ticket_room', { ticket_id: ticketId });
                } else {
                    console.warn("[fetchTicketDetails] Socket not connected when trying to join room.");
                }

            } catch (error) {
                console.error("[fetchTicketDetails] Error fetching ticket details:", error);
                chatMessagesDiv.innerHTML = `<p class="text-red-400 text-center py-4">Error loading messages: ${error.message}</p>`;
                showPopupMessage(errorMessagePopup, `Error loading ticket: ${error.message}`, true);
                if (error.message.includes("not found") || error.message.includes("Forbidden")) {
                    window.location.hash = '/#tickets';
                }
            }
        }
        function appendChatMessage(data) {
            if (!chatMessagesDiv) return;
            const placeholderMsg = chatMessagesDiv.querySelector('p.text-gray-500, p.text-red-400');
            if (placeholderMsg) placeholderMsg.remove();

            const messageElement = document.createElement('div');
            messageElement.classList.add('chat-message');
            messageElement.dataset.timestamp = data.timestamp;
            messageElement.dataset.senderId = data.sender_id;

            const timestamp = data.timestamp ? new Date(data.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) : '';
            const username = data.sender_username || data.username || 'System';
            const safeUsername = username.replace(/</g, "&lt;").replace(/>/g, "&gt;");
            const safeText = (data.text || '').replace(/</g, "&lt;").replace(/>/g, "&gt;");

            const usernameSpan = document.createElement('span');
            usernameSpan.classList.add('username');
            usernameSpan.textContent = `${safeUsername}:`;
            usernameSpan.addEventListener('click', () => showUserInfoModal(data.sender_id, safeUsername));

            messageElement.appendChild(usernameSpan);
            messageElement.append(` ${safeText} `);

            const timestampSpan = document.createElement('span');
            timestampSpan.classList.add('timestamp');
            timestampSpan.textContent = timestamp;
            messageElement.appendChild(timestampSpan);

            if (currentUser && currentUser.is_moderator) {
               messageElement.addEventListener('contextmenu', showChatContextMenu);
            }

            chatMessagesDiv.appendChild(messageElement);
            chatMessagesDiv.scrollTop = chatMessagesDiv.scrollHeight;
        }
        function connectSocket(ticketIdToJoin = null) {
            if (socket && socket.connected) {
                if (ticketIdToJoin && currentTicketId === ticketIdToJoin) {
                    console.log(`[connectSocket] Socket already connected, re-joining room: ${ticketIdToJoin}`);
                    socket.emit('join_ticket_room', { ticket_id: ticketIdToJoin });
                } else {
                    console.log(`[connectSocket] Socket already connected, not joining room ${ticketIdToJoin || 'N/A'}.`);
                }
                return;
            }

            console.log(`[connectSocket] Attempting to connect WebSocket... (Potential room join: ${ticketIdToJoin || 'none'})`);
            if (socket) {
                socket.disconnect();
                socket = null;
            }
            socket = io(SOCKET_URL, { reconnectionAttempts: 3, withCredentials: true });

            socket.on('connect', () => {
                console.log('[connectSocket] WebSocket connected:', socket.id);
                if (ticketIdToJoin && currentTicketId === ticketIdToJoin) {
                    console.log(`[connectSocket] Joining room post-connect: ${ticketIdToJoin}`);
                    socket.emit('join_ticket_room', { ticket_id: ticketIdToJoin });
                }
                setupSocketListeners();
            });

            socket.on('disconnect', (reason) => { console.log('[connectSocket] WebSocket disconnected:', reason); socket = null; });
            socket.on('connect_error', (error) => { console.error('[connectSocket] WebSocket connection error:', error); showPopupMessage(errorMessagePopup, "Chat connection failed.", true); socket = null; });
        }
        function ensureSocketConnected() {
             if (!socket || !socket.connected) {
                 console.log("[ensureSocketConnected] Socket not connected, attempting connection...");
                 connectSocket(currentTicketId);
             } else {
                 console.log("[ensureSocketConnected] Socket already connected.");
                 if (currentTicketId) {
                     socket.emit('join_ticket_room', { ticket_id: currentTicketId });
                 }
             }
        }
        function setupSocketListeners() {
             if (!socket) return;
             console.log("[setupSocketListeners] Setting up listeners.");
             socket.off('new_message'); socket.off('room_joined'); socket.off('error_message');
             socket.off('message_deleted'); socket.off('ticket_status_updated');
             socket.off('ticket_list_updated'); socket.off('action_success');

             socket.on('new_message', (data) => {
                 console.log("[Socket Listener] Received new_message:", data);
                 if (!data.sender_id && data.username === currentUser?.username) data.sender_id = currentUser.user_id;
                 if (data.ticket_id === currentTicketId) appendChatMessage(data);
             });
             socket.on('room_joined', (data) => { console.log('[Socket Listener] Joined room:', data.room); });
             socket.on('error_message', (data) => { console.error('[Socket Listener] WebSocket server error:', data.message); showPopupMessage(errorMessagePopup, data.message || 'Chat error.', true); });
             socket.on('message_deleted', (data) => {
                 console.log("[Socket Listener] Received message_deleted:", data);
                 if (data.ticket_id === currentTicketId) {
                     const messageToRemove = chatMessagesDiv.querySelector(`.chat-message[data-timestamp="${data.timestamp}"]`);
                     if (messageToRemove) { messageToRemove.remove(); console.log(`[Socket Listener] Removed message with timestamp: ${data.timestamp}`); }
                     else { console.warn(`[Socket Listener] Could not find message to delete with timestamp: ${data.timestamp}`); }
                 }
             });
             socket.on('ticket_status_updated', (data) => {
                  console.log("[Socket Listener] Received ticket_status_updated:", data);
                  if (activeSectionId === pageSections['#tickets']) { console.log(`[Socket Listener] Ticket ${data.ticket_id} status updated to ${data.status}. Refreshing list.`); fetchTickets(); }
                  if (data.ticket_id === currentTicketId) { showPopupMessage(ticketMessagePopup, `Ticket status updated to ${data.status}.`); }
                  const ticketItem = document.querySelector(`.ticket-list-item[data-ticket-id="${data.ticket_id}"]`);
                  if(ticketItem) ticketItem.dataset.ticketStatus = data.status;
             });
              socket.on('ticket_list_updated', () => {
                  console.log("[Socket Listener] Received ticket_list_updated (likely due to deletion/creation).");
                  if (activeSectionId === pageSections['#tickets']) { console.log("[Socket Listener] Refreshing ticket list."); fetchTickets(); }
                  if (currentTicketId && activeSectionId === pageSections['#ticketDetail']) {
                      console.log(`[Socket Listener] Ticket list updated while viewing ticket ${currentTicketId}. Redirecting to list.`);
                      showPopupMessage(errorMessagePopup, "The ticket list was updated. Returning to list.", true);
                      window.location.hash = '/#tickets';
                  }
              });
             socket.on('action_success', (data) => { console.log("[Socket Listener] Received action_success:", data); showPopupMessage(paymentMessage, data.message || 'Action successful.'); });
        }
        function disconnectSocket() { if (socket) { console.log('[disconnectSocket] Disconnecting WebSocket...'); socket.disconnect(); socket = null; } }

        function displayUserRoles(roles) {
            console.log('[displayUserRoles] Received roles:', roles);

            const rolesContainer = document.getElementById('dashboard-user-roles');
            if (!rolesContainer) {
                console.error('[displayUserRoles] Container #dashboard-user-roles not found!');
                return;
            }
            rolesContainer.innerHTML = '';

            if (roles && Array.isArray(roles) && roles.length > 0) {
                roles.forEach(role => {
                    const roleElement = document.createElement('span');
                    roleElement.classList.add('role-span');

                    let hexColor = '#9CA3AF';
                    if (role.color && role.color !== 0) {
                        hexColor = '#' + role.color.toString(16).padStart(6, '0');
                    }
                    const r = parseInt(hexColor.slice(1, 3), 16);
                    const g = parseInt(hexColor.slice(3, 5), 16);
                    const b = parseInt(hexColor.slice(5, 7), 16);
                    const luminance = (0.299 * r + 0.587 * g + 0.114 * b) / 255;
                    const textColorClass = luminance > 0.5 ? 'text-black' : 'text-white';

                    roleElement.textContent = role.name || `Role ${role.id}`;
                    roleElement.style.backgroundColor = hexColor;
                    roleElement.classList.add(textColorClass);
                    rolesContainer.appendChild(roleElement);
                });
            } else {
                console.log('[displayUserRoles] No roles found or roles data is invalid.');
                rolesContainer.innerHTML = '<p class="text-gray-400 text-sm w-full">No roles found.</p>';
            }
        }

        function showUserInfoModal(senderId, username) {
             if (!userInfoModal || !senderId) return;
             modalUsername.textContent = username || 'Unknown User';
             modalUserId.textContent = senderId;
             modalUserRoles.innerHTML = '<p class="text-gray-500 text-xs">Loading roles...</p>';

             if (currentUser && currentUser.user_id === senderId && currentUser.roles) {
                 const modalRolesContainer = document.getElementById('modal-user-roles');
                 if (modalRolesContainer) {
                     modalRolesContainer.innerHTML = '';
                     if (currentUser.roles.length > 0) {
                         currentUser.roles.forEach(role => {
                             const roleElement = document.createElement('span');
                             roleElement.classList.add('role-span');
                             let hexColor = '#9CA3AF';
                             if (role.color && role.color !== 0) hexColor = '#' + role.color.toString(16).padStart(6, '0');
                             const r = parseInt(hexColor.slice(1, 3), 16), g = parseInt(hexColor.slice(3, 5), 16), b = parseInt(hexColor.slice(5, 7), 16);
                             const luminance = (0.299 * r + 0.587 * g + 0.114 * b) / 255;
                             const textColorClass = luminance > 0.5 ? 'text-black' : 'text-white';
                             roleElement.textContent = role.name || `Role ${role.id}`;
                             roleElement.style.backgroundColor = hexColor;
                             roleElement.classList.add(textColorClass);
                             modalRolesContainer.appendChild(roleElement);
                         });
                     } else {
                          modalRolesContainer.innerHTML = '<p class="text-gray-500 text-xs">User has no roles.</p>';
                     }
                 }
             } else {
                 modalUserRoles.innerHTML = '<p class="text-gray-500 text-xs">Role information unavailable.</p>';
             }
             userInfoModal.classList.add('active');
        }
        function hideUserInfoModal() { if (userInfoModal) userInfoModal.classList.remove('active'); }
        function positionContextMenu(menuElement, event) {
             const rect = event.target.getBoundingClientRect();
             let top = event.clientY + window.scrollY + 5;
             let left = event.clientX + window.scrollX + 5;

             const menuHeight = menuElement.offsetHeight || 150;
             const menuWidth = menuElement.offsetWidth || 150;

             const windowHeight = window.innerHeight + window.scrollY;
             const windowWidth = window.innerWidth + window.scrollX;

             if (top + menuHeight > windowHeight) {
                 top = event.clientY + window.scrollY - menuHeight - 5;
             }
             if (left + menuWidth > windowWidth) {
                 left = event.clientX + window.scrollX - menuWidth - 5;
             }
             if (top < window.scrollY) top = window.scrollY;
             if (left < window.scrollX) left = window.scrollX;

             menuElement.style.top = `${top}px`;
             menuElement.style.left = `${left}px`;
             menuElement.style.display = 'block';
        }
        function hideContextMenu() {
            if (chatContextMenu) chatContextMenu.style.display = 'none';
            if (ticketContextMenu) ticketContextMenu.style.display = 'none';
            document.removeEventListener('click', hideContextMenuOnClickOutside);
            window.removeEventListener('scroll', hideContextMenu);
            currentContextMenu = null;
        }
        function hideContextMenuOnClickOutside(event) {
            if (currentContextMenu && !currentContextMenu.contains(event.target)) {
                hideContextMenu();
            }
        }
        function showChatContextMenu(event) {
            event.preventDefault(); hideContextMenu();
            if (!currentUser || !currentUser.is_moderator || !chatContextMenu) return;
            const messageElement = event.target.closest('.chat-message'); if (!messageElement) return;

            contextMenuData.ticketId = currentTicketId;
            contextMenuData.messageTimestamp = messageElement.dataset.timestamp;
            contextMenuData.senderId = messageElement.dataset.senderId;
            contextMenuData.ticketStatus = null;

            positionContextMenu(chatContextMenu, event);
            currentContextMenu = chatContextMenu;

            setTimeout(() => {
                 document.addEventListener('click', hideContextMenuOnClickOutside);
                 window.addEventListener('scroll', hideContextMenu, { once: true });
            }, 0);
        }
        function showTicketContextMenu(event) {
             event.preventDefault(); hideContextMenu();
             if (!currentUser || !ticketContextMenu) return;
             const ticketElement = event.target.closest('.ticket-list-item'); if (!ticketElement) return;

             contextMenuData.ticketId = ticketElement.dataset.ticketId;
             contextMenuData.ticketStatus = ticketElement.dataset.ticketStatus;
             contextMenuData.senderId = null;
             contextMenuData.messageTimestamp = null;
             console.log("[showTicketContextMenu] Data:", contextMenuData);

             const isMod = currentUser.is_moderator === true;
             const canClose = contextMenuData.ticketStatus === 'open';
             const canReopen = contextMenuData.ticketStatus === 'closed' && isMod;
             const canDelete = isMod;

             contextCloseTicketButton.classList.toggle('hidden', !canClose);
             contextReopenTicketButton.classList.toggle('hidden', !canReopen);
             contextDeleteTicketButton.classList.toggle('hidden', !canDelete);

             if (canClose || canReopen || canDelete) {
                 positionContextMenu(ticketContextMenu, event);
                 currentContextMenu = ticketContextMenu;
                 setTimeout(() => {
                      document.addEventListener('click', hideContextMenuOnClickOutside);
                      window.addEventListener('scroll', hideContextMenu, { once: true });
                 }, 0);
             }
        }
        function deleteChatMessage() {
             if (!contextMenuData.ticketId || !contextMenuData.messageTimestamp || !socket || !socket.connected) { showPopupMessage(errorMessagePopup, 'Cannot delete message: Invalid state or not connected.', true); return; }
             console.log(`[deleteChatMessage] Attempting to delete message: T:${contextMenuData.ticketId} TS:${contextMenuData.messageTimestamp}`);
             socket.emit('delete_message', { ticket_id: contextMenuData.ticketId, message_timestamp: contextMenuData.messageTimestamp });
             hideContextMenu();
         }
         function closeTicket() {
             if (!contextMenuData.ticketId || !socket || !socket.connected) { showPopupMessage(errorMessagePopup, 'Cannot close ticket: Invalid state or not connected.', true); return; }
             console.log(`[closeTicket] Attempting to close ticket: ${contextMenuData.ticketId}`);
             socket.emit('update_ticket_status', { ticket_id: contextMenuData.ticketId, new_status: 'closed' });
             hideContextMenu();
         }
         function reopenTicket() {
             if (!contextMenuData.ticketId || !socket || !socket.connected) { showPopupMessage(errorMessagePopup, 'Cannot reopen ticket: Invalid state or not connected.', true); return; }
             if (!currentUser?.is_moderator) { showPopupMessage(errorMessagePopup, 'You do not have permission to reopen tickets.', true); hideContextMenu(); return; }
             console.log(`[reopenTicket] Attempting to reopen ticket: ${contextMenuData.ticketId}`);
             socket.emit('update_ticket_status', { ticket_id: contextMenuData.ticketId, new_status: 'open' });
             hideContextMenu();
         }
         function deleteTicket() {
             if (!contextMenuData.ticketId || !socket || !socket.connected) { showPopupMessage(errorMessagePopup, 'Cannot delete ticket: Invalid state or not connected.', true); return; }
             if (!currentUser?.is_moderator) { showPopupMessage(errorMessagePopup, 'You do not have permission to delete tickets.', true); hideContextMenu(); return; }
             if (confirm(`Are you sure you want to permanently delete ticket #${contextMenuData.ticketId.slice(-6)}? This action cannot be undone.`)) {
                 console.log(`[deleteTicket] Attempting to delete ticket: ${contextMenuData.ticketId}`);
                 socket.emit('delete_ticket', { ticket_id: contextMenuData.ticketId });
             }
             hideContextMenu();
         }

        async function loadAdminDashboardData() {
            console.log("Loading admin dashboard data...");
            if (!currentUser?.is_moderator) return;
            await loadSiteConfigForm();
            await loadProductManagementTable();
        }

        async function loadSiteConfigForm() {
            if (!siteConfigForm || !configSiteTitleInput || !configHeaderLinksContainer || !configSaveStatus) return;
            if (!siteConfig) {
                console.warn("Site config not loaded yet for admin form. Attempting fetch.");
                configSaveStatus.textContent = "Error: Config not loaded.";
                configSaveStatus.className = 'text-sm text-center h-5 mt-2 text-red-400';
                return;
            }
            configSiteTitleInput.value = siteConfig.siteTitle || '';
            configHeaderLinksContainer.innerHTML = '';
            (siteConfig.headerLinks || []).forEach((link) => {
                addHeaderLinkInput(link.name, link.href, link.target);
            });
            configSaveStatus.textContent = '';
            configSaveStatus.className = 'text-sm text-center h-5 mt-2';
        }

        function addHeaderLinkInput(name = '', href = '', target = '') {
             const linkGroup = document.createElement('div');
             linkGroup.className = 'link-group';
             linkGroup.innerHTML = `
                 <input type="text" placeholder="Link Name" value="${name}" class="link-name flex-1 bg-slate-700 border border-slate-600 rounded-md py-2 px-3 text-white focus:outline-none focus:ring-2 focus:ring-orange-500 focus:border-transparent placeholder-gray-400" required>
                 <input type="text" placeholder="Link Href" value="${href}" class="link-href flex-1 bg-slate-700 border border-slate-600 rounded-md py-2 px-3 text-white focus:outline-none focus:ring-2 focus:ring-orange-500 focus:border-transparent placeholder-gray-400" required>
                 <input type="text" placeholder="Target (e.g., _blank)" value="${target || ''}" class="link-target flex-none w-32 bg-slate-700 border border-slate-600 rounded-md py-2 px-3 text-white focus:outline-none focus:ring-2 focus:ring-orange-500 focus:border-transparent placeholder-gray-400">
                 <button type="button" class="remove-link-button bg-red-600 hover:bg-red-700 text-white text-xs font-bold py-1 px-2 rounded flex-shrink-0" title="Remove Link">X</button>
             `;
             linkGroup.querySelector('.remove-link-button').addEventListener('click', () => linkGroup.remove());
             configHeaderLinksContainer.appendChild(linkGroup);
        }

        async function handleSaveSiteConfig(event) {
            event.preventDefault();
            if (!siteConfigForm || !saveConfigButton) return;
            saveConfigButton.disabled = true; saveConfigButton.textContent = 'Saving...';
            configSaveStatus.textContent = ''; configSaveStatus.className = 'text-sm text-center h-5 mt-2';

            const updatedConfig = { siteTitle: configSiteTitleInput.value.trim(), headerLinks: [] };
            configHeaderLinksContainer.querySelectorAll('.link-group').forEach(group => {
                const nameInput = group.querySelector('.link-name');
                const hrefInput = group.querySelector('.link-href');
                const targetInput = group.querySelector('.link-target');
                if (nameInput.value.trim() && hrefInput.value.trim()) {
                    updatedConfig.headerLinks.push({
                        name: nameInput.value.trim(),
                        href: hrefInput.value.trim(),
                        target: targetInput.value.trim() || null
                    });
                }
            });

            try {
                const response = await fetch(`${API_BASE_URL}/api/config`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(updatedConfig),
                    credentials: 'include'
                });
                const result = await response.json();
                if (!response.ok) throw new Error(result.error || `HTTP ${response.status}`);

                siteConfig = result;
                applySiteConfig(siteConfig);
                configSaveStatus.textContent = 'Configuration saved successfully!';
                configSaveStatus.classList.add('text-green-400');
                showPopupMessage(configMessagePopup, 'Configuration saved!');
            } catch (error) {
                console.error("Error saving site config:", error);
                configSaveStatus.textContent = `Error: ${error.message}`;
                configSaveStatus.classList.add('text-red-400');
                showPopupMessage(errorMessagePopup, `Failed to save config: ${error.message}`, true);
            } finally {
                saveConfigButton.disabled = false; saveConfigButton.textContent = 'Save Configuration';
            }
        }

        async function loadProductManagementTable() {
             if (!productListTableBody || !productListStatus) return;
             productListTableBody.innerHTML = ''; productListStatus.textContent = 'Loading products...';
             productListStatus.classList.remove('hidden');

             try {
                 const response = await fetch(`${API_BASE_URL}/api/products`);
                 if (!response.ok) throw new Error(`HTTP ${response.status}`);
                 const products = await response.json();
                 productListStatus.classList.add('hidden');

                 if (!products || products.length === 0) {
                     productListStatus.textContent = 'No products found.';
                     productListStatus.classList.remove('hidden');
                     return;
                 }

                 products.forEach(product => {
                     const row = productListTableBody.insertRow();
                     row.innerHTML = `
                         <td>${product.name || 'N/A'}</td>
                         <td>$${product.price?.toFixed(2) || 'N/A'}</td>
                         <td>${product.tag || '-'}</td>
                         <td class="actions">
                             <button class="edit-btn" data-product-id="${product._id}">Edit</button>
                             <button class="delete-btn" data-product-id="${product._id}">Delete</button>
                         </td>
                     `;
                     row.querySelector('.edit-btn').addEventListener('click', () => openProductEditModal(product));
                     row.querySelector('.delete-btn').addEventListener('click', () => handleDeleteProduct(product._id, product.name));
                 });
             } catch (error) {
                 console.error("Error loading products for admin table:", error);
                 productListStatus.textContent = 'Failed to load products.';
                 productListStatus.classList.remove('hidden');
                 showPopupMessage(errorMessagePopup, `Error loading products: ${error.message}`, true);
             }
        }

        function openProductEditModal(product = null) {
             if (!productEditModal || !productEditForm || !customHexInputContainer) return;
             productEditForm.reset();
             productEditStatus.textContent = '';
             productEditStatus.className = 'text-sm text-center h-5 mt-2';
             productEditThumbnailFilename.textContent = 'No file selected';

             if (product) {
                 productModalTitle.textContent = 'Edit Product';
                 productEditIdInput.value = product._id;
                 productEditNameInput.value = product.name || '';
                 productEditThumbnailInput.value = product.thumbnailUrl || '';
                 productEditPriceInput.value = product.price || '';
                 productEditTagInput.value = product.tag || '';
                 const hasValidCustomHex = product.customBorderHex && /^#[0-9A-F]{6}$/i.test(product.customBorderHex);
                 productEditTagColorSelect.value = hasValidCustomHex ? 'custom' : (product.tagColor || 'gray');
                 productEditCustomHexInput.value = hasValidCustomHex ? product.customBorderHex : '';
                 productEditDescriptionInput.value = product.description || '';
                 productEditFeaturesInput.value = (product.features || []).join('\n');
                 productEditPaymentLinkInput.value = product.paymentLink || '';
             } else {
                 productModalTitle.textContent = 'Add Product';
                 productEditIdInput.value = '';
                 productEditTagColorSelect.value = 'gray';
                 productEditCustomHexInput.value = '';
             }
             toggleCustomHexInput();
             productEditModal.classList.add('active');
        }

        function toggleCustomHexInput() {
            if (customHexInputContainer && productEditTagColorSelect) {
                 const selectedColor = productEditTagColorSelect.value;
                 customHexInputContainer.classList.toggle('hidden', selectedColor !== 'custom');
            }
        }

        function closeProductEditModal() { if (productEditModal) productEditModal.classList.remove('active'); }

        async function handleSaveProduct(event) {
             event.preventDefault(); if (!productEditForm || !productSaveButton) return;
             productSaveButton.disabled = true; productSaveButton.textContent = 'Saving...';
             productEditStatus.textContent = ''; productEditStatus.className = 'text-sm text-center h-5 mt-2';

             const productId = productEditIdInput.value; const isEditing = !!productId;
             const url = isEditing ? `${API_BASE_URL}/api/products/${productId}` : `${API_BASE_URL}/api/products`;
             const method = isEditing ? 'PUT' : 'POST';

             let tagColorValue = productEditTagColorSelect.value;
             let customHexValue = productEditCustomHexInput.value.trim();
             let finalTagColor = 'gray';
             let finalCustomHex = null;

             if (tagColorValue === 'custom') {
                 if (customHexValue && /^#[0-9A-F]{6}$/i.test(customHexValue)) {
                     finalTagColor = 'custom';
                     finalCustomHex = customHexValue;
                 } else {
                     productEditStatus.textContent = 'Invalid Custom HEX format. Please use #RRGGBB.';
                     productEditStatus.classList.add('text-red-400');
                     productSaveButton.disabled = false; productSaveButton.textContent = 'Save Product'; return;
                 }
             } else {
                 finalTagColor = tagColorValue || 'gray';
                 finalCustomHex = null;
             }

             const productData = {
                 name: productEditNameInput.value.trim(),
                 thumbnailUrl: productEditThumbnailInput.value.trim() || null,
                 price: parseFloat(productEditPriceInput.value),
                 tag: productEditTagInput.value.trim() || null,
                 tagColor: finalTagColor,
                 customBorderHex: finalCustomHex,
                 description: productEditDescriptionInput.value.trim() || null,
                 features: productEditFeaturesInput.value.split('\n').map(f => f.trim()).filter(f => f),
                 paymentLink: productEditPaymentLinkInput.value.trim() || null
             };

             if (!productData.name || isNaN(productData.price)) {
                  productEditStatus.textContent = 'Name and valid Price are required.';
                  productEditStatus.classList.add('text-red-400');
                  productSaveButton.disabled = false; productSaveButton.textContent = 'Save Product'; return;
             }

             try {
                 const response = await fetch(url, {
                     method: method,
                     headers: { 'Content-Type': 'application/json' },
                     body: JSON.stringify(productData),
                     credentials: 'include'
                 });
                 const result = await response.json();
                 if (!response.ok) throw new Error(result.error || `HTTP ${response.status}`);

                 showPopupMessage(productMessagePopup, `Product ${isEditing ? 'updated' : 'added'} successfully!`);
                 closeProductEditModal();
                 await loadProductManagementTable();
                 if (activeSectionId === pageSections['#products']) await fetchProducts();
             } catch (error) {
                 console.error(`Error ${isEditing ? 'updating' : 'adding'} product:`, error);
                 productEditStatus.textContent = `Error: ${error.message}`;
                 productEditStatus.classList.add('text-red-400');
                 showPopupMessage(errorMessagePopup, `Failed to save product: ${error.message}`, true);
             } finally {
                 productSaveButton.disabled = false; productSaveButton.textContent = 'Save Product';
             }
        }

        async function handleDeleteProduct(productId, productName) {
            if (!productId) return;
            if (!confirm(`Are you sure you want to delete the product "${productName || 'this product'}"? This cannot be undone.`)) return;

            console.log(`Attempting to delete product: ${productId}`);
            try {
                const response = await fetch(`${API_BASE_URL}/api/products/${productId}`, {
                    method: 'DELETE',
                    credentials: 'include'
                });
                const result = await response.json();
                if (!response.ok) throw new Error(result.error || `HTTP ${response.status}`);

                showPopupMessage(productMessagePopup, 'Product deleted successfully!');
                await loadProductManagementTable();
                if (activeSectionId === pageSections['#products']) await fetchProducts();
            } catch (error) {
                console.error("Error deleting product:", error);
                showPopupMessage(errorMessagePopup, `Failed to delete product: ${error.message}`, true);
            }
        }


        loginButton.addEventListener('click', (e) => { e.preventDefault(); window.location.href = loginButton.href; });
        async function handleLogout() {
            console.log('Logging out...');
            try {
                const response = await fetch(`${API_BASE_URL}/logout`, { credentials: 'include' });
                if (!response.ok) {
                    let errorMsg = 'Logout request failed';
                    try { const errorData = await response.json(); errorMsg = errorData.error || errorMsg; } catch (parseError) {}
                    console.warn(`Backend logout failed: ${errorMsg}. Proceeding with client-side cleanup.`);
                }
            } catch(error) {
                console.error("Network error during logout fetch:", error);
            } finally {
                 currentUser = { logged_in: false };
                 isInitialLoginCheckComplete = false;
                 isInitialConfigLoadComplete = false;
                 localStorage.removeItem('currentPage');
                 disconnectSocket();
                 updateHeaderUI(currentUser);
                 adminDashboardSections?.classList.add('hidden');
                 console.log("Redirecting to /#home after logout cleanup.");
                 window.location.hash = '/#home';
            }
        }
        logoutButton.addEventListener('click', handleLogout);
        dashboardLogoutButton.addEventListener('click', handleLogout);

        window.addEventListener('hashchange', runNavigation);

        if(createTicketForm) createTicketForm.addEventListener('submit', async (event) => {
            event.preventDefault();
            const subject = ticketSubjectInput.value.trim(); const message = ticketMessageInput.value.trim();
            createTicketStatus.textContent = ''; createTicketStatus.className = 'h-6 text-sm mt-4 mb-4 text-center';
            if (!subject || !message) { createTicketStatus.textContent = 'Please fill out both subject and message.'; createTicketStatus.classList.add('error'); return; }

            const submitButton = document.getElementById('create-ticket-button');
            submitButton.disabled = true; submitButton.textContent = 'Submitting...';

            try {
                const response = await fetch(`${API_BASE_URL}/api/tickets`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ subject, message }),
                    credentials: 'include'
                });
                if (!response.ok) {
                    let errorData;
                    try { errorData = await response.json(); } catch (e) {}
                    throw new Error(errorData?.error || `HTTP error! status: ${response.status}`);
                }
                const result = await response.json();
                createTicketStatus.textContent = 'Ticket submitted successfully!';
                createTicketStatus.classList.add('success');
                createTicketForm.reset();
                if (activeSectionId === pageSections['#tickets']) fetchTickets();
            } catch (error) {
                console.error('Error creating ticket:', error);
                createTicketStatus.textContent = `Error: ${error.message}`;
                createTicketStatus.classList.add('error');
            } finally {
                submitButton.disabled = false; submitButton.textContent = 'Submit Ticket';
            }
        });

        if(chatInputForm) chatInputForm.addEventListener('submit', (event) => {
            event.preventDefault(); const messageText = chatInput.value.trim();
            if (messageText && socket && socket.connected && currentTicketId) {
                socket.emit('send_message', { ticket_id: currentTicketId, text: messageText });
                chatInput.value = '';
            }
            else if (!socket || !socket.connected) { showPopupMessage(errorMessagePopup, 'Not connected to chat.', true); }
            else if (!currentTicketId) { showPopupMessage(errorMessagePopup, 'No active ticket selected.', true); }
        });

        if (modalCloseButton) modalCloseButton.addEventListener('click', hideUserInfoModal);
        if (userInfoModal) userInfoModal.addEventListener('click', (event) => { if (event.target === userInfoModal) hideUserInfoModal(); });
        if (contextDeleteButton) contextDeleteButton.addEventListener('click', deleteChatMessage);
        if (contextUserInfoButton) contextUserInfoButton.addEventListener('click', () => {
            if (contextMenuData.senderId) {
                const messageElement = chatMessagesDiv?.querySelector(`.chat-message[data-timestamp="${contextMenuData.messageTimestamp}"]`);
                const usernameElement = messageElement?.querySelector('.username');
                const username = usernameElement ? usernameElement.textContent.replace(':', '') : 'Unknown User';
                showUserInfoModal(contextMenuData.senderId, username);
            }
            hideContextMenu();
        });
        if (contextCloseTicketButton) contextCloseTicketButton.addEventListener('click', closeTicket);
        if (contextReopenTicketButton) contextReopenTicketButton.addEventListener('click', reopenTicket);
        if (contextDeleteTicketButton) contextDeleteTicketButton.addEventListener('click', deleteTicket);

        if (mobileMenuButton && mobileMenuNav) mobileMenuButton.addEventListener('click', () => mobileMenuNav.classList.toggle('hidden'));

        if (siteConfigForm) siteConfigForm.addEventListener('submit', handleSaveSiteConfig);
        if (addHeaderLinkButton) addHeaderLinkButton.addEventListener('click', () => addHeaderLinkInput());
        if (addProductButton) addProductButton.addEventListener('click', () => openProductEditModal());
        if (productEditModal && productModalCloseButton) productModalCloseButton.addEventListener('click', closeProductEditModal);
        if (productEditModal) productEditModal.addEventListener('click', (event) => { if (event.target === productEditModal) closeProductEditModal(); });
        if (productEditForm) productEditForm.addEventListener('submit', handleSaveProduct);
        if (productEditTagColorSelect) productEditTagColorSelect.addEventListener('change', toggleCustomHexInput);

        if(productEditThumbnailButton && productEditThumbnailFileInput) {
            productEditThumbnailButton.addEventListener('click', () => {
                productEditThumbnailFileInput.click();
            });
        }
        if(productEditThumbnailFileInput && productEditThumbnailFilename) {
            productEditThumbnailFileInput.addEventListener('change', (event) => {
                const file = event.target.files[0];
                if (file) {
                    productEditThumbnailFilename.textContent = file.name;
                } else {
                    productEditThumbnailFilename.textContent = 'No file selected';
                }
                 // Reset file input value so the same file can be selected again if needed
                event.target.value = null;
            });
        }


        document.addEventListener('DOMContentLoaded', () => {
            console.log("DOM fully loaded.");
            createSnowflakes();
            checkLoginStatus();
        });

    </script>

</body>
</html>
